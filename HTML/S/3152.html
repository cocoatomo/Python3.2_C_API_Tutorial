<html>
<head>
<title>Python/thread_pthread.h</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.8.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/3402.html'>Python</a>/thread_pthread.h</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L137'>[^]</a><a href='#L625'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2><a href='3145.html#L118' title='Included from 118 in Python/thread.c.'>INCLUDED FROM</a></h2>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L137' title='Defined at 137.'>_noop</a>
<li><a href='#L142' title='Defined at 142.'>PyThread__init_thread</a>
<li><a href='#L154' title='Defined at 154.'>PyThread__init_thread</a>
<li><a href='#L169' title='Defined at 169.'>PyThread_start_new_thread</a>
<li><a href='#L235' title='Defined at 235.'>PyThread_get_thread_ident</a>
<li><a href='#L250' title='Defined at 250.'>PyThread_exit_thread</a>
<li><a href='#L265' title='Defined at 265.'>PyThread_allocate_lock</a>
<li><a href='#L291' title='Defined at 291.'>PyThread_free_lock</a>
<li><a href='#L314' title='Defined at 314.'>fix_status</a>
<li><a href='#L320' title='Defined at 320.'>PyThread_acquire_lock_timed</a>
<li><a href='#L373' title='Defined at 373.'>PyThread_release_lock</a>
<li><a href='#L390' title='Defined at 390.'>PyThread_allocate_lock</a>
<li><a href='#L429' title='Defined at 429.'>PyThread_free_lock</a>
<li><a href='#L446' title='Defined at 446.'>PyThread_acquire_lock_timed</a>
<li><a href='#L512' title='Defined at 512.'>PyThread_release_lock</a>
<li><a href='#L535' title='Defined at 535.'>PyThread_acquire_lock</a>
<li><a href='#L545' title='Defined at 545.'>_pythread_pthread_set_stacksize</a>
<li><a href='#L588' title='Defined at 588.'>PyThread_create_key</a>
<li><a href='#L596' title='Defined at 596.'>PyThread_delete_key</a>
<li><a href='#L602' title='Defined at 602.'>PyThread_delete_key_value</a>
<li><a href='#L608' title='Defined at 608.'>PyThread_set_key_value</a>
<li><a href='#L619' title='Defined at 619.'>PyThread_get_key_value</a>
<li><a href='#L625' title='Defined at 625.'>PyThread_ReInitTLS</a>
</ol>
<hr>
<pre>
<a name='L1'>
<a name='L2'><i><font color='green'>/* Posix threads interface */</font></i>
<a name='L3'>
<a name='L4'><font color='darkred'>#include</font> &lt;stdlib.h&gt;
<a name='L5'><font color='darkred'>#include</font> &lt;string.h&gt;
<a name='L6'><font color='darkred'>#if</font> <b>defined</b>(__APPLE__) || <b>defined</b>(HAVE_PTHREAD_DESTRUCTOR)
<a name='L7'><font color='darkred'>#define</font> <a href='../R/7315.html' title='Multiple refered from 194 places.'>destructor</a> xxdestructor
<a name='L8'><font color='darkred'>#endif</font>
<a name='L9'><font color='darkred'>#include</font> &lt;pthread.h&gt;
<a name='L10'><font color='darkred'>#if</font> <b>defined</b>(__APPLE__) || <b>defined</b>(HAVE_PTHREAD_DESTRUCTOR)
<a name='L11'><font color='darkred'>#undef</font> <a href='../R/7315.html' title='Multiple refered from 194 places.'>destructor</a>
<a name='L12'><font color='darkred'>#endif</font>
<a name='L13'><font color='darkred'>#include</font> &lt;signal.h&gt;
<a name='L14'>
<a name='L15'><i><font color='green'>/* The POSIX spec requires that use of pthread_attr_setstacksize</font></i>
<a name='L16'><i><font color='green'>   be conditional on _POSIX_THREAD_ATTR_STACKSIZE being defined. */</font></i>
<a name='L17'><font color='darkred'>#ifdef</font> _POSIX_THREAD_ATTR_STACKSIZE
<a name='L18'><font color='darkred'>#ifndef</font> <a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>
<a name='L19'><font color='darkred'>#define</font> <a href='../R/4537.html' title='Multiple refered from 13 places.'>THREAD_STACK_SIZE</a>       0       <i><font color='green'>/* use default stack size */</font></i>
<a name='L20'><font color='darkred'>#endif</font>
<a name='L21'><i><font color='green'>/* for safety, ensure a viable minimum stacksize */</font></i>
<a name='L22'><font color='darkred'>#define</font> <a href='../R/4536.html' title='Multiple refered from 3 places.'>THREAD_STACK_MIN</a>        0x8000  <i><font color='green'>/* 32kB */</font></i>
<a name='L23'><font color='darkred'>#else</font>  <i><font color='green'>/* !_POSIX_THREAD_ATTR_STACKSIZE */</font></i>
<a name='L24'><font color='darkred'>#ifdef</font> <a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>
<a name='L25'><font color='darkred'>#error</font> "THREAD_STACK_SIZE defined but _POSIX_THREAD_ATTR_STACKSIZE undefined"
<a name='L26'><font color='darkred'>#endif</font>
<a name='L27'><font color='darkred'>#endif</font>
<a name='L28'>
<a name='L29'><i><font color='green'>/* The POSIX spec says that implementations supporting the sem_*</font></i>
<a name='L30'><i><font color='green'>   family of functions must indicate this by defining</font></i>
<a name='L31'><i><font color='green'>   _POSIX_SEMAPHORES. */</font></i>
<a name='L32'><font color='darkred'>#ifdef</font> _POSIX_SEMAPHORES
<a name='L33'><i><font color='green'>/* On FreeBSD 4.x, _POSIX_SEMAPHORES is defined empty, so</font></i>
<a name='L34'><i><font color='green'>   we need to add 0 to make it work there as well. */</font></i>
<a name='L35'><font color='darkred'>#if</font> (_POSIX_SEMAPHORES+0) == -1
<a name='L36'><font color='darkred'>#define</font> <a href='../S/3152.html#L67' title='Refered from 67 in Python/thread_pthread.h.'>HAVE_BROKEN_POSIX_SEMAPHORES</a>
<a name='L37'><font color='darkred'>#else</font>
<a name='L38'><font color='darkred'>#include</font> &lt;semaphore.h&gt;
<a name='L39'><font color='darkred'>#include</font> &lt;errno.h&gt;
<a name='L40'><font color='darkred'>#endif</font>
<a name='L41'><font color='darkred'>#endif</font>
<a name='L42'>
<a name='L43'><i><font color='green'>/* Before FreeBSD 5.4, system scope threads was very limited resource</font></i>
<a name='L44'><i><font color='green'>   in default setting.  So the process scope is preferred to get</font></i>
<a name='L45'><i><font color='green'>   enough number of threads to work. */</font></i>
<a name='L46'><font color='darkred'>#ifdef</font> __FreeBSD__
<a name='L47'><font color='darkred'>#include</font> &lt;osreldate.h&gt;
<a name='L48'><font color='darkred'>#if</font> __FreeBSD_version &gt;= 500000 &amp;&amp; __FreeBSD_version &lt; 504101
<a name='L49'><font color='darkred'>#undef</font> <a href='../R/2312.html' title='Multiple refered from 5 places.'>PTHREAD_SYSTEM_SCHED_SUPPORTED</a>
<a name='L50'><font color='darkred'>#endif</font>
<a name='L51'><font color='darkred'>#endif</font>
<a name='L52'>
<a name='L53'><font color='darkred'>#if</font> !<b>defined</b>(<a href='../S/3152.html#L54' title='Defined at 54 in Python/thread_pthread.h.'>pthread_attr_default</a>)
<a name='L54'><font color='darkred'>#  define</font> <a href='../S/3152.html#L53' title='Refered from 53 in Python/thread_pthread.h.'>pthread_attr_default</a> ((pthread_attr_t *)<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L55'><font color='darkred'>#endif</font>
<a name='L56'><font color='darkred'>#if</font> !<b>defined</b>(<a href='../S/3152.html#L57' title='Defined at 57 in Python/thread_pthread.h.'>pthread_mutexattr_default</a>)
<a name='L57'><font color='darkred'>#  define</font> <a href='../R/9781.html' title='Multiple refered from 2 places.'>pthread_mutexattr_default</a> ((pthread_mutexattr_t *)<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L58'><font color='darkred'>#endif</font>
<a name='L59'><font color='darkred'>#if</font> !<b>defined</b>(<a href='../S/3152.html#L60' title='Defined at 60 in Python/thread_pthread.h.'>pthread_condattr_default</a>)
<a name='L60'><font color='darkred'>#  define</font> <a href='../R/9779.html' title='Multiple refered from 2 places.'>pthread_condattr_default</a> ((pthread_condattr_t *)<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L61'><font color='darkred'>#endif</font>
<a name='L62'>
<a name='L63'>
<a name='L64'><i><font color='green'>/* Whether or not to use semaphores directly rather than emulating them with</font></i>
<a name='L65'><i><font color='green'> * mutexes and condition variables:</font></i>
<a name='L66'><i><font color='green'> */</font></i>
<a name='L67'><font color='darkred'>#if</font> (<b>defined</b>(_POSIX_SEMAPHORES) &amp;&amp; !<b>defined</b>(<a href='../S/3152.html#L36' title='Defined at 36 in Python/thread_pthread.h.'>HAVE_BROKEN_POSIX_SEMAPHORES</a>) &amp;&amp; \
<a name='L68'>     <b>defined</b>(HAVE_SEM_TIMEDWAIT))
<a name='L69'><font color='darkred'>#  define</font> <a href='../S/3152.html#L258' title='Refered from 258 in Python/thread_pthread.h.'>USE_SEMAPHORES</a>
<a name='L70'><font color='darkred'>#else</font>
<a name='L71'><font color='darkred'>#  undef</font> <a href='../S/3152.html#L258' title='Refered from 258 in Python/thread_pthread.h.'>USE_SEMAPHORES</a>
<a name='L72'><font color='darkred'>#endif</font>
<a name='L73'>
<a name='L74'>
<a name='L75'><i><font color='green'>/* On platforms that don't use standard POSIX threads pthread_sigmask()</font></i>
<a name='L76'><i><font color='green'> * isn't present.  DEC threads uses sigprocmask() instead as do most</font></i>
<a name='L77'><i><font color='green'> * other UNIX International compliant systems that don't have the full</font></i>
<a name='L78'><i><font color='green'> * pthread implementation.</font></i>
<a name='L79'><i><font color='green'> */</font></i>
<a name='L80'><font color='darkred'>#if</font> <b>defined</b>(HAVE_PTHREAD_SIGMASK) &amp;&amp; !<b>defined</b>(HAVE_BROKEN_PTHREAD_SIGMASK)
<a name='L81'><font color='darkred'>#  define</font> SET_THREAD_SIGMASK pthread_sigmask
<a name='L82'><font color='darkred'>#else</font>
<a name='L83'><font color='darkred'>#  define</font> SET_THREAD_SIGMASK sigprocmask
<a name='L84'><font color='darkred'>#endif</font>
<a name='L85'>
<a name='L86'>
<a name='L87'><i><font color='green'>/* We assume all modern POSIX systems have gettimeofday() */</font></i>
<a name='L88'><font color='darkred'>#ifdef</font> GETTIMEOFDAY_NO_TZ
<a name='L89'><font color='darkred'>#define</font> <a href='../R/1240.html' title='Multiple refered from 2 places.'>GETTIMEOFDAY</a>(ptv) gettimeofday(ptv)
<a name='L90'><font color='darkred'>#else</font>
<a name='L91'><font color='darkred'>#define</font> <a href='../R/1240.html' title='Multiple refered from 2 places.'>GETTIMEOFDAY</a>(ptv) gettimeofday(ptv, (<b>struct</b> <a href='../S/2720.html#L41' title='Defined at 41 in Modules/timemodule.c.'>timezone</a> *)<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L92'><font color='darkred'>#endif</font>
<a name='L93'>
<a name='L94'><font color='darkred'>#define</font> <a href='../R/1922.html' title='Multiple refered from 2 places.'>MICROSECONDS_TO_TIMESPEC</a>(microseconds, ts) \
<a name='L95'><b>do</b> <font color='red'>{</font> \
<a name='L96'>    <b>struct</b> timeval tv; \
<a name='L97'>    <a href='../D/1382.html' title='Multiple defined in 4 places.'>GETTIMEOFDAY</a>(&amp;tv); \
<a name='L98'>    tv.tv_usec += microseconds % 1000000; \
<a name='L99'>    tv.tv_sec += microseconds / 1000000; \
<a name='L100'>    tv.tv_sec += tv.tv_usec / 1000000; \
<a name='L101'>    tv.tv_usec %= 1000000; \
<a name='L102'>    ts.tv_sec = tv.tv_sec; \
<a name='L103'>    ts.tv_nsec = tv.tv_usec * 1000; \
<a name='L104'><font color='red'>}</font> <b>while</b>(0)
<a name='L105'>
<a name='L106'>
<a name='L107'><i><font color='green'>/* A pthread mutex isn't sufficient to model the Python lock type</font></i>
<a name='L108'><i><font color='green'> * because, according to Draft 5 of the docs (P1003.4a/D5), both of the</font></i>
<a name='L109'><i><font color='green'> * following are undefined:</font></i>
<a name='L110'><i><font color='green'> *  -&gt; a thread tries to lock a mutex it already has locked</font></i>
<a name='L111'><i><font color='green'> *  -&gt; a thread tries to unlock a mutex locked by a different thread</font></i>
<a name='L112'><i><font color='green'> * pthread mutexes are designed for serializing threads over short pieces</font></i>
<a name='L113'><i><font color='green'> * of code anyway, so wouldn't be an appropriate implementation of</font></i>
<a name='L114'><i><font color='green'> * Python's locks regardless.</font></i>
<a name='L115'><i><font color='green'> *</font></i>
<a name='L116'><i><font color='green'> * The pthread_lock struct implements a Python lock as a "locked?" bit</font></i>
<a name='L117'><i><font color='green'> * and a &lt;condition, mutex&gt; pair.  In general, if the bit can be acquired</font></i>
<a name='L118'><i><font color='green'> * instantly, it is, else the pair is used to block the thread until the</font></i>
<a name='L119'><i><font color='green'> * bit is cleared.     9 May 1994 tim@ksr.com</font></i>
<a name='L120'><i><font color='green'> */</font></i>
<a name='L121'>
<a name='L122'><b>typedef</b> <b>struct</b> <font color='red'>{</font>
<a name='L123'>    <b>char</b>             locked; <i><font color='green'>/* 0=unlocked, 1=locked */</font></i>
<a name='L124'>    <i><font color='green'>/* a &lt;cond, mutex&gt; pair to handle an acquire of a locked lock */</font></i>
<a name='L125'>    pthread_cond_t   lock_released;
<a name='L126'>    pthread_mutex_t  mut;
<a name='L127'><font color='red'>}</font> <a href='../R/9780.html' title='Multiple refered from 6 places.'>pthread_lock</a>;
<a name='L128'>
<a name='L129'><font color='darkred'>#define</font> <a href='../R/504.html' title='Multiple refered from 27 places.'>CHECK_STATUS</a>(name)  <b>if</b> (status != 0) <font color='red'>{</font> <a href='../S/2759.html#L64' title='Defined at 64 in Modules/zlib/minigzip.c.'>perror</a>(name); <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 1; <font color='red'>}</font>
<a name='L130'>
<a name='L131'><i><font color='green'>/*</font></i>
<a name='L132'><i><font color='green'> * Initialization.</font></i>
<a name='L133'><i><font color='green'> */</font></i>
<a name='L134'>
<a name='L135'><font color='darkred'>#ifdef</font> _HAVE_BSDI
<a name='L136'><b>static</b>
<a name='L137'><b>void</b> <a href='../S/3152.html#L147' title='Refered from 147 in Python/thread_pthread.h.'>_noop</a>(<b>void</b>)
<a name='L138'><font color='red'>{</font>
<a name='L139'><font color='red'>}</font>
<a name='L140'>
<a name='L141'><b>static</b> <b>void</b>
<a name='L142'><a href='../R/3449.html' title='Multiple refered from 2 places.'>PyThread__init_thread</a>(<b>void</b>)
<a name='L143'><font color='red'>{</font>
<a name='L144'>    <i><font color='green'>/* DO AN INIT BY STARTING THE THREAD */</font></i>
<a name='L145'>    <b>static</b> <b>int</b> dummy = 0;
<a name='L146'>    pthread_t thread1;
<a name='L147'>    pthread_create(&amp;thread1, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, (<b>void</b> *) <a href='../S/3152.html#L137' title='Defined at 137 in Python/thread_pthread.h.'>_noop</a>, &amp;dummy);
<a name='L148'>    pthread_join(thread1, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>);
<a name='L149'><font color='red'>}</font>
<a name='L150'>
<a name='L151'><font color='darkred'>#else</font> <i><font color='green'>/* !_HAVE_BSDI */</font></i>
<a name='L152'>
<a name='L153'><b>static</b> <b>void</b>
<a name='L154'><a href='../R/3449.html' title='Multiple refered from 2 places.'>PyThread__init_thread</a>(<b>void</b>)
<a name='L155'><font color='red'>{</font>
<a name='L156'><font color='darkred'>#if</font> <b>defined</b>(_AIX) &amp;&amp; <b>defined</b>(__GNUC__)
<a name='L157'>    pthread_init();
<a name='L158'><font color='darkred'>#endif</font>
<a name='L159'><font color='red'>}</font>
<a name='L160'>
<a name='L161'><font color='darkred'>#endif</font> <i><font color='green'>/* !_HAVE_BSDI */</font></i>
<a name='L162'>
<a name='L163'><i><font color='green'>/*</font></i>
<a name='L164'><i><font color='green'> * Thread support.</font></i>
<a name='L165'><i><font color='green'> */</font></i>
<a name='L166'>
<a name='L167'>
<a name='L168'><b>long</b>
<a name='L169'><a href='../R/3465.html' title='Multiple refered from 3 places.'>PyThread_start_new_thread</a>(<b>void</b> (*func)(<b>void</b> *), <b>void</b> *arg)
<a name='L170'><font color='red'>{</font>
<a name='L171'>    pthread_t th;
<a name='L172'>    <b>int</b> status;
<a name='L173'><font color='darkred'>#if</font> <b>defined</b>(<a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>) || <b>defined</b>(<a href='../S/3152.html#L49' title='Defined at 49 in Python/thread_pthread.h.'>PTHREAD_SYSTEM_SCHED_SUPPORTED</a>)
<a name='L174'>    pthread_attr_t attrs;
<a name='L175'><font color='darkred'>#endif</font>
<a name='L176'><font color='darkred'>#if</font> <b>defined</b>(<a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>)
<a name='L177'>    <a href='../D/11182.html' title='Multiple defined in 2 places.'>size_t</a>      tss;
<a name='L178'><font color='darkred'>#endif</font>
<a name='L179'>
<a name='L180'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_start_new_thread called\n"));
<a name='L181'>    <b>if</b> (!initialized)
<a name='L182'>        <a href='../S/3145.html#L73' title='Defined at 73 in Python/thread.c.'>PyThread_init_thread</a>();
<a name='L183'>
<a name='L184'><font color='darkred'>#if</font> <b>defined</b>(<a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>) || <b>defined</b>(<a href='../S/3152.html#L49' title='Defined at 49 in Python/thread_pthread.h.'>PTHREAD_SYSTEM_SCHED_SUPPORTED</a>)
<a name='L185'>    <b>if</b> (pthread_attr_init(&amp;attrs) != 0)
<a name='L186'>        <b>return</b> -1;
<a name='L187'><font color='darkred'>#endif</font>
<a name='L188'><font color='darkred'>#if</font> <b>defined</b>(<a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>)
<a name='L189'>    tss = (_pythread_stacksize != 0) ? _pythread_stacksize
<a name='L190'>                                     : <a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>;
<a name='L191'>    <b>if</b> (tss != 0) <font color='red'>{</font>
<a name='L192'>        <b>if</b> (pthread_attr_setstacksize(&amp;attrs, tss) != 0) <font color='red'>{</font>
<a name='L193'>            pthread_attr_destroy(&amp;attrs);
<a name='L194'>            <b>return</b> -1;
<a name='L195'>        <font color='red'>}</font>
<a name='L196'>    <font color='red'>}</font>
<a name='L197'><font color='darkred'>#endif</font>
<a name='L198'><font color='darkred'>#if</font> <b>defined</b>(<a href='../S/3152.html#L49' title='Defined at 49 in Python/thread_pthread.h.'>PTHREAD_SYSTEM_SCHED_SUPPORTED</a>)
<a name='L199'>    pthread_attr_setscope(&amp;attrs, PTHREAD_SCOPE_SYSTEM);
<a name='L200'><font color='darkred'>#endif</font>
<a name='L201'>
<a name='L202'>    status = pthread_create(&amp;th,
<a name='L203'><font color='darkred'>#if</font> <b>defined</b>(<a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>) || <b>defined</b>(<a href='../S/3152.html#L49' title='Defined at 49 in Python/thread_pthread.h.'>PTHREAD_SYSTEM_SCHED_SUPPORTED</a>)
<a name='L204'>                             &amp;attrs,
<a name='L205'><font color='darkred'>#else</font>
<a name='L206'>                             (pthread_attr_t*)<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>,
<a name='L207'><font color='darkred'>#endif</font>
<a name='L208'>                             (<b>void</b>* (*)(<b>void</b> *))func,
<a name='L209'>                             (<b>void</b> *)<a href='../D/6730.html' title='Multiple defined in 2 places.'>arg</a>
<a name='L210'>                             );
<a name='L211'>
<a name='L212'><font color='darkred'>#if</font> <b>defined</b>(<a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>) || <b>defined</b>(<a href='../S/3152.html#L49' title='Defined at 49 in Python/thread_pthread.h.'>PTHREAD_SYSTEM_SCHED_SUPPORTED</a>)
<a name='L213'>    pthread_attr_destroy(&amp;attrs);
<a name='L214'><font color='darkred'>#endif</font>
<a name='L215'>    <b>if</b> (status != 0)
<a name='L216'>        <b>return</b> -1;
<a name='L217'>
<a name='L218'>    pthread_detach(th);
<a name='L219'>
<a name='L220'><font color='darkred'>#if</font> <a href='../D/4738.html' title='Multiple defined in 6 places.'>SIZEOF_PTHREAD_T</a> &lt;= <a href='../D/4734.html' title='Multiple defined in 7 places.'>SIZEOF_LONG</a>
<a name='L221'>    <b>return</b> (<b>long</b>) th;
<a name='L222'><font color='darkred'>#else</font>
<a name='L223'>    <b>return</b> (<b>long</b>) *(<b>long</b> *) &amp;th;
<a name='L224'><font color='darkred'>#endif</font>
<a name='L225'><font color='red'>}</font>
<a name='L226'>
<a name='L227'><i><font color='green'>/* XXX This implementation is considered (to quote Tim Peters) "inherently</font></i>
<a name='L228'><i><font color='green'>   hosed" because:</font></i>
<a name='L229'><i><font color='green'>     - It does not guarantee the promise that a non-zero integer is returned.</font></i>
<a name='L230'><i><font color='green'>     - The cast to long is inherently unsafe.</font></i>
<a name='L231'><i><font color='green'>     - It is not clear that the 'volatile' (for AIX?) and ugly casting in the</font></i>
<a name='L232'><i><font color='green'>       latter return statement (for Alpha OSF/1) are any longer necessary.</font></i>
<a name='L233'><i><font color='green'>*/</font></i>
<a name='L234'><b>long</b>
<a name='L235'><a href='../R/3460.html' title='Multiple refered from 64 places.'>PyThread_get_thread_ident</a>(<b>void</b>)
<a name='L236'><font color='red'>{</font>
<a name='L237'>    <b>volatile</b> pthread_t threadid;
<a name='L238'>    <b>if</b> (!initialized)
<a name='L239'>        <a href='../S/3145.html#L73' title='Defined at 73 in Python/thread.c.'>PyThread_init_thread</a>();
<a name='L240'>    <i><font color='green'>/* Jump through some hoops for Alpha OSF/1 */</font></i>
<a name='L241'>    threadid = pthread_self();
<a name='L242'><font color='darkred'>#if</font> <a href='../D/4738.html' title='Multiple defined in 6 places.'>SIZEOF_PTHREAD_T</a> &lt;= <a href='../D/4734.html' title='Multiple defined in 7 places.'>SIZEOF_LONG</a>
<a name='L243'>    <b>return</b> (<b>long</b>) threadid;
<a name='L244'><font color='darkred'>#else</font>
<a name='L245'>    <b>return</b> (<b>long</b>) *(<b>long</b> *) &amp;threadid;
<a name='L246'><font color='darkred'>#endif</font>
<a name='L247'><font color='red'>}</font>
<a name='L248'>
<a name='L249'><b>void</b>
<a name='L250'><a href='../S/2615.html#L1017' title='Refered from 1017 in Modules/_threadmodule.c.'>PyThread_exit_thread</a>(<b>void</b>)
<a name='L251'><font color='red'>{</font>
<a name='L252'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_exit_thread called\n"));
<a name='L253'>    <b>if</b> (!initialized) <font color='red'>{</font>
<a name='L254'>        exit(0);
<a name='L255'>    <font color='red'>}</font>
<a name='L256'><font color='red'>}</font>
<a name='L257'>
<a name='L258'><font color='darkred'>#ifdef</font> <a href='../D/5399.html' title='Multiple defined in 2 places.'>USE_SEMAPHORES</a>
<a name='L259'>
<a name='L260'><i><font color='green'>/*</font></i>
<a name='L261'><i><font color='green'> * Lock support.</font></i>
<a name='L262'><i><font color='green'> */</font></i>
<a name='L263'>
<a name='L264'><a href='../S/572.html#L5' title='Defined at 5 in Include/pythread.h.'>PyThread_type_lock</a>
<a name='L265'><a href='../R/3452.html' title='Multiple refered from 21 places.'>PyThread_allocate_lock</a>(<b>void</b>)
<a name='L266'><font color='red'>{</font>
<a name='L267'>    sem_t *<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L268'>    <b>int</b> status, <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 0;
<a name='L269'>
<a name='L270'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_allocate_lock called\n"));
<a name='L271'>    <b>if</b> (!initialized)
<a name='L272'>        <a href='../S/3145.html#L73' title='Defined at 73 in Python/thread.c.'>PyThread_init_thread</a>();
<a name='L273'>
<a name='L274'>    <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a> = (sem_t *)malloc(<b>sizeof</b>(sem_t));
<a name='L275'>
<a name='L276'>    <b>if</b> (<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>) <font color='red'>{</font>
<a name='L277'>        status = sem_init(<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>,0,1);
<a name='L278'>        <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("sem_init");
<a name='L279'>
<a name='L280'>        <b>if</b> (<a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a>) <font color='red'>{</font>
<a name='L281'>            free((<b>void</b> *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>);
<a name='L282'>            <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L283'>        <font color='red'>}</font>
<a name='L284'>    <font color='red'>}</font>
<a name='L285'>
<a name='L286'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_allocate_lock() -&gt; %p\n", <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>));
<a name='L287'>    <b>return</b> (<a href='../S/572.html#L5' title='Defined at 5 in Include/pythread.h.'>PyThread_type_lock</a>)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L288'><font color='red'>}</font>
<a name='L289'>
<a name='L290'><b>void</b>
<a name='L291'><a href='../R/3457.html' title='Multiple refered from 15 places.'>PyThread_free_lock</a>(PyThread_type_lock lock)
<a name='L292'><font color='red'>{</font>
<a name='L293'>    sem_t *thelock = (sem_t *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L294'>    <b>int</b> status, <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 0;
<a name='L295'>
<a name='L296'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_free_lock(%p) called\n", <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>));
<a name='L297'>
<a name='L298'>    <b>if</b> (!thelock)
<a name='L299'>        <b>return</b>;
<a name='L300'>
<a name='L301'>    status = sem_destroy(thelock);
<a name='L302'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("sem_destroy");
<a name='L303'>
<a name='L304'>    free((<b>void</b> *)thelock);
<a name='L305'><font color='red'>}</font>
<a name='L306'>
<a name='L307'><i><font color='green'>/*</font></i>
<a name='L308'><i><font color='green'> * As of February 2002, Cygwin thread implementations mistakenly report error</font></i>
<a name='L309'><i><font color='green'> * codes in the return value of the sem_ calls (like the pthread_ functions).</font></i>
<a name='L310'><i><font color='green'> * Correct implementations return -1 and put the code in errno. This supports</font></i>
<a name='L311'><i><font color='green'> * either.</font></i>
<a name='L312'><i><font color='green'> */</font></i>
<a name='L313'><b>static</b> <b>int</b>
<a name='L314'><a href='../R/7813.html' title='Multiple refered from 3 places.'>fix_status</a>(<b>int</b> status)
<a name='L315'><font color='red'>{</font>
<a name='L316'>    <b>return</b> (status == -1) ? errno : status;
<a name='L317'><font color='red'>}</font>
<a name='L318'>
<a name='L319'><a href='../D/3446.html' title='Multiple defined in 2 places.'>PyLockStatus</a>
<a name='L320'><a href='../R/3451.html' title='Multiple refered from 3 places.'>PyThread_acquire_lock_timed</a>(PyThread_type_lock lock, PY_TIMEOUT_T microseconds,
<a name='L321'>                            <b>int</b> intr_flag)
<a name='L322'><font color='red'>{</font>
<a name='L323'>    <a href='../D/3446.html' title='Multiple defined in 2 places.'>PyLockStatus</a> success;
<a name='L324'>    sem_t *thelock = (sem_t *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L325'>    <b>int</b> status, <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 0;
<a name='L326'>    <b>struct</b> timespec ts;
<a name='L327'>
<a name='L328'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_acquire_lock_timed(%p, %lld, %d) called\n",
<a name='L329'>             <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>, microseconds, intr_flag));
<a name='L330'>
<a name='L331'>    <b>if</b> (microseconds &gt; 0)
<a name='L332'>        <a href='../S/3152.html#L94' title='Defined at 94 in Python/thread_pthread.h.'>MICROSECONDS_TO_TIMESPEC</a>(microseconds, ts);
<a name='L333'>    <b>do</b> <font color='red'>{</font>
<a name='L334'>        <b>if</b> (microseconds &gt; 0)
<a name='L335'>            status = <a href='../S/3152.html#L314' title='Defined at 314 in Python/thread_pthread.h.'>fix_status</a>(<a href='../S/2585.html#L205' title='Defined at 205 in Modules/_multiprocessing/semaphore.c.'>sem_timedwait</a>(thelock, &amp;ts));
<a name='L336'>        <b>else</b> <b>if</b> (microseconds == 0)
<a name='L337'>            status = <a href='../S/3152.html#L314' title='Defined at 314 in Python/thread_pthread.h.'>fix_status</a>(sem_trywait(thelock));
<a name='L338'>        <b>else</b>
<a name='L339'>            status = <a href='../S/3152.html#L314' title='Defined at 314 in Python/thread_pthread.h.'>fix_status</a>(sem_wait(thelock));
<a name='L340'>        <i><font color='green'>/* Retry if interrupted by a signal, unless the caller wants to be</font></i>
<a name='L341'><i><font color='green'>           notified.  */</font></i>
<a name='L342'>    <font color='red'>}</font> <b>while</b> (!intr_flag &amp;&amp; status == EINTR);
<a name='L343'>
<a name='L344'>    <i><font color='green'>/* Don't check the status if we're stopping because of an interrupt.  */</font></i>
<a name='L345'>    <b>if</b> (!(intr_flag &amp;&amp; status == EINTR)) <font color='red'>{</font>
<a name='L346'>        <b>if</b> (microseconds &gt; 0) <font color='red'>{</font>
<a name='L347'>            <b>if</b> (status != ETIMEDOUT)
<a name='L348'>                <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("sem_timedwait");
<a name='L349'>        <font color='red'>}</font>
<a name='L350'>        <b>else</b> <b>if</b> (microseconds == 0) <font color='red'>{</font>
<a name='L351'>            <b>if</b> (status != EAGAIN)
<a name='L352'>                <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("sem_trywait");
<a name='L353'>        <font color='red'>}</font>
<a name='L354'>        <b>else</b> <font color='red'>{</font>
<a name='L355'>            <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("sem_wait");
<a name='L356'>        <font color='red'>}</font>
<a name='L357'>    <font color='red'>}</font>
<a name='L358'>
<a name='L359'>    <b>if</b> (status == 0) <font color='red'>{</font>
<a name='L360'>        success = <a href='../S/572.html#L16' title='Defined at 16 in Include/pythread.h.'>PY_LOCK_ACQUIRED</a>;
<a name='L361'>    <font color='red'>}</font> <b>else</b> <b>if</b> (intr_flag &amp;&amp; status == EINTR) <font color='red'>{</font>
<a name='L362'>        success = <a href='../S/572.html#L17' title='Defined at 17 in Include/pythread.h.'>PY_LOCK_INTR</a>;
<a name='L363'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L364'>        success = <a href='../S/572.html#L15' title='Defined at 15 in Include/pythread.h.'>PY_LOCK_FAILURE</a>;
<a name='L365'>    <font color='red'>}</font>
<a name='L366'>
<a name='L367'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_acquire_lock_timed(%p, %lld, %d) -&gt; %d\n",
<a name='L368'>             <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>, microseconds, intr_flag, success));
<a name='L369'>    <b>return</b> success;
<a name='L370'><font color='red'>}</font>
<a name='L371'>
<a name='L372'><b>void</b>
<a name='L373'><a href='../R/3462.html' title='Multiple refered from 31 places.'>PyThread_release_lock</a>(PyThread_type_lock lock)
<a name='L374'><font color='red'>{</font>
<a name='L375'>    sem_t *thelock = (sem_t *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L376'>    <b>int</b> status, <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 0;
<a name='L377'>
<a name='L378'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_release_lock(%p) called\n", <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>));
<a name='L379'>
<a name='L380'>    status = sem_post(thelock);
<a name='L381'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("sem_post");
<a name='L382'><font color='red'>}</font>
<a name='L383'>
<a name='L384'><font color='darkred'>#else</font> <i><font color='green'>/* USE_SEMAPHORES */</font></i>
<a name='L385'>
<a name='L386'><i><font color='green'>/*</font></i>
<a name='L387'><i><font color='green'> * Lock support.</font></i>
<a name='L388'><i><font color='green'> */</font></i>
<a name='L389'><a href='../S/572.html#L5' title='Defined at 5 in Include/pythread.h.'>PyThread_type_lock</a>
<a name='L390'><a href='../R/3452.html' title='Multiple refered from 21 places.'>PyThread_allocate_lock</a>(<b>void</b>)
<a name='L391'><font color='red'>{</font>
<a name='L392'>    <a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a> *<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L393'>    <b>int</b> status, <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 0;
<a name='L394'>
<a name='L395'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_allocate_lock called\n"));
<a name='L396'>    <b>if</b> (!initialized)
<a name='L397'>        <a href='../S/3145.html#L73' title='Defined at 73 in Python/thread.c.'>PyThread_init_thread</a>();
<a name='L398'>
<a name='L399'>    <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a> = (<a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a> *) malloc(<b>sizeof</b>(<a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a>));
<a name='L400'>    <b>if</b> (<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>) <font color='red'>{</font>
<a name='L401'>        memset((<b>void</b> *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>, '\0', <b>sizeof</b>(<a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a>));
<a name='L402'>        <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>-&gt;locked = 0;
<a name='L403'>
<a name='L404'>        status = pthread_mutex_init(&amp;<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>-&gt;mut,
<a name='L405'>                                    <a href='../S/3152.html#L57' title='Defined at 57 in Python/thread_pthread.h.'>pthread_mutexattr_default</a>);
<a name='L406'>        <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_mutex_init");
<a name='L407'>        <i><font color='green'>/* Mark the pthread mutex underlying a Python mutex as</font></i>
<a name='L408'><i><font color='green'>           pure happens-before.  We can't simply mark the</font></i>
<a name='L409'><i><font color='green'>           Python-level mutex as a mutex because it can be</font></i>
<a name='L410'><i><font color='green'>           acquired and released in different threads, which</font></i>
<a name='L411'><i><font color='green'>           will cause errors. */</font></i>
<a name='L412'>        <a href='../D/6268.html' title='Multiple defined in 2 places.'>_Py_ANNOTATE_PURE_HAPPENS_BEFORE_MUTEX</a>(&amp;<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>-&gt;mut);
<a name='L413'>
<a name='L414'>        status = pthread_cond_init(&amp;<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>-&gt;lock_released,
<a name='L415'>                                   <a href='../S/3152.html#L60' title='Defined at 60 in Python/thread_pthread.h.'>pthread_condattr_default</a>);
<a name='L416'>        <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_cond_init");
<a name='L417'>
<a name='L418'>        <b>if</b> (<a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a>) <font color='red'>{</font>
<a name='L419'>            free((<b>void</b> *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>);
<a name='L420'>            <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a> = 0;
<a name='L421'>        <font color='red'>}</font>
<a name='L422'>    <font color='red'>}</font>
<a name='L423'>
<a name='L424'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_allocate_lock() -&gt; %p\n", <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>));
<a name='L425'>    <b>return</b> (<a href='../S/572.html#L5' title='Defined at 5 in Include/pythread.h.'>PyThread_type_lock</a>) <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L426'><font color='red'>}</font>
<a name='L427'>
<a name='L428'><b>void</b>
<a name='L429'><a href='../R/3457.html' title='Multiple refered from 15 places.'>PyThread_free_lock</a>(PyThread_type_lock lock)
<a name='L430'><font color='red'>{</font>
<a name='L431'>    <a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a> *thelock = (<a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a> *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L432'>    <b>int</b> status, <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 0;
<a name='L433'>
<a name='L434'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_free_lock(%p) called\n", <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>));
<a name='L435'>
<a name='L436'>    status = pthread_mutex_destroy( &amp;thelock-&gt;mut );
<a name='L437'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_mutex_destroy");
<a name='L438'>
<a name='L439'>    status = pthread_cond_destroy( &amp;thelock-&gt;lock_released );
<a name='L440'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_cond_destroy");
<a name='L441'>
<a name='L442'>    free((<b>void</b> *)thelock);
<a name='L443'><font color='red'>}</font>
<a name='L444'>
<a name='L445'><a href='../D/3446.html' title='Multiple defined in 2 places.'>PyLockStatus</a>
<a name='L446'><a href='../R/3451.html' title='Multiple refered from 3 places.'>PyThread_acquire_lock_timed</a>(PyThread_type_lock lock, PY_TIMEOUT_T microseconds,
<a name='L447'>                            <b>int</b> intr_flag)
<a name='L448'><font color='red'>{</font>
<a name='L449'>    <a href='../D/3446.html' title='Multiple defined in 2 places.'>PyLockStatus</a> success;
<a name='L450'>    <a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a> *thelock = (<a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a> *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L451'>    <b>int</b> status, <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 0;
<a name='L452'>
<a name='L453'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_acquire_lock_timed(%p, %lld, %d) called\n",
<a name='L454'>             <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>, microseconds, intr_flag));
<a name='L455'>
<a name='L456'>    status = pthread_mutex_lock( &amp;thelock-&gt;mut );
<a name='L457'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_mutex_lock[1]");
<a name='L458'>
<a name='L459'>    <b>if</b> (thelock-&gt;locked == 0) <font color='red'>{</font>
<a name='L460'>        success = <a href='../S/572.html#L16' title='Defined at 16 in Include/pythread.h.'>PY_LOCK_ACQUIRED</a>;
<a name='L461'>    <font color='red'>}</font> <b>else</b> <b>if</b> (microseconds == 0) <font color='red'>{</font>
<a name='L462'>        success = <a href='../S/572.html#L15' title='Defined at 15 in Include/pythread.h.'>PY_LOCK_FAILURE</a>;
<a name='L463'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L464'>        <b>struct</b> timespec ts;
<a name='L465'>        <b>if</b> (microseconds &gt; 0)
<a name='L466'>            <a href='../S/3152.html#L94' title='Defined at 94 in Python/thread_pthread.h.'>MICROSECONDS_TO_TIMESPEC</a>(microseconds, ts);
<a name='L467'>        <i><font color='green'>/* continue trying until we get the lock */</font></i>
<a name='L468'>
<a name='L469'>        <i><font color='green'>/* mut must be locked by me -- part of the condition</font></i>
<a name='L470'><i><font color='green'>         * protocol */</font></i>
<a name='L471'>        success = <a href='../S/572.html#L15' title='Defined at 15 in Include/pythread.h.'>PY_LOCK_FAILURE</a>;
<a name='L472'>        <b>while</b> (success == <a href='../S/572.html#L15' title='Defined at 15 in Include/pythread.h.'>PY_LOCK_FAILURE</a>) <font color='red'>{</font>
<a name='L473'>            <b>if</b> (microseconds &gt; 0) <font color='red'>{</font>
<a name='L474'>                status = pthread_cond_timedwait(
<a name='L475'>                    &amp;thelock-&gt;lock_released,
<a name='L476'>                    &amp;thelock-&gt;mut, &amp;ts);
<a name='L477'>                <b>if</b> (status == ETIMEDOUT)
<a name='L478'>                    <b>break</b>;
<a name='L479'>                <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_cond_timed_wait");
<a name='L480'>            <font color='red'>}</font>
<a name='L481'>            <b>else</b> <font color='red'>{</font>
<a name='L482'>                status = pthread_cond_wait(
<a name='L483'>                    &amp;thelock-&gt;lock_released,
<a name='L484'>                    &amp;thelock-&gt;mut);
<a name='L485'>                <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_cond_wait");
<a name='L486'>            <font color='red'>}</font>
<a name='L487'>
<a name='L488'>            <b>if</b> (intr_flag &amp;&amp; status == 0 &amp;&amp; thelock-&gt;locked) <font color='red'>{</font>
<a name='L489'>                <i><font color='green'>/* We were woken up, but didn't get the lock.  We probably received</font></i>
<a name='L490'><i><font color='green'>                 * a signal.  Return PY_LOCK_INTR to allow the caller to handle</font></i>
<a name='L491'><i><font color='green'>                 * it and retry.  */</font></i>
<a name='L492'>                success = <a href='../S/572.html#L17' title='Defined at 17 in Include/pythread.h.'>PY_LOCK_INTR</a>;
<a name='L493'>                <b>break</b>;
<a name='L494'>            <font color='red'>}</font> <b>else</b> <b>if</b> (status == 0 &amp;&amp; !thelock-&gt;locked) <font color='red'>{</font>
<a name='L495'>                success = <a href='../S/572.html#L16' title='Defined at 16 in Include/pythread.h.'>PY_LOCK_ACQUIRED</a>;
<a name='L496'>            <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L497'>                success = <a href='../S/572.html#L15' title='Defined at 15 in Include/pythread.h.'>PY_LOCK_FAILURE</a>;
<a name='L498'>            <font color='red'>}</font>
<a name='L499'>        <font color='red'>}</font>
<a name='L500'>    <font color='red'>}</font>
<a name='L501'>    <b>if</b> (success == <a href='../S/572.html#L16' title='Defined at 16 in Include/pythread.h.'>PY_LOCK_ACQUIRED</a>) thelock-&gt;locked = 1;
<a name='L502'>    status = pthread_mutex_unlock( &amp;thelock-&gt;mut );
<a name='L503'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_mutex_unlock[1]");
<a name='L504'>
<a name='L505'>    <b>if</b> (<a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a>) success = <a href='../S/572.html#L15' title='Defined at 15 in Include/pythread.h.'>PY_LOCK_FAILURE</a>;
<a name='L506'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_acquire_lock_timed(%p, %lld, %d) -&gt; %d\n",
<a name='L507'>             <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>, microseconds, intr_flag, success));
<a name='L508'>    <b>return</b> success;
<a name='L509'><font color='red'>}</font>
<a name='L510'>
<a name='L511'><b>void</b>
<a name='L512'><a href='../R/3462.html' title='Multiple refered from 31 places.'>PyThread_release_lock</a>(PyThread_type_lock lock)
<a name='L513'><font color='red'>{</font>
<a name='L514'>    <a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a> *thelock = (<a href='../S/3152.html#L127' title='Defined at 127 in Python/thread_pthread.h.'>pthread_lock</a> *)<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>;
<a name='L515'>    <b>int</b> status, <a href='../D/8389.html' title='Multiple defined in 3 places.'>error</a> = 0;
<a name='L516'>
<a name='L517'>    <a href='../D/8255.html' title='Multiple defined in 2 places.'>dprintf</a>(("PyThread_release_lock(%p) called\n", <a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>));
<a name='L518'>
<a name='L519'>    status = pthread_mutex_lock( &amp;thelock-&gt;mut );
<a name='L520'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_mutex_lock[3]");
<a name='L521'>
<a name='L522'>    thelock-&gt;locked = 0;
<a name='L523'>
<a name='L524'>    status = pthread_mutex_unlock( &amp;thelock-&gt;mut );
<a name='L525'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_mutex_unlock[3]");
<a name='L526'>
<a name='L527'>    <i><font color='green'>/* wake up someone (anyone, if any) waiting on the lock */</font></i>
<a name='L528'>    status = pthread_cond_signal( &amp;thelock-&gt;lock_released );
<a name='L529'>    <a href='../D/538.html' title='Multiple defined in 2 places.'>CHECK_STATUS</a>("pthread_cond_signal");
<a name='L530'><font color='red'>}</font>
<a name='L531'>
<a name='L532'><font color='darkred'>#endif</font> <i><font color='green'>/* USE_SEMAPHORES */</font></i>
<a name='L533'>
<a name='L534'><b>int</b>
<a name='L535'><a href='../R/3450.html' title='Multiple refered from 35 places.'>PyThread_acquire_lock</a>(PyThread_type_lock lock, <b>int</b> waitflag)
<a name='L536'><font color='red'>{</font>
<a name='L537'>    <b>return</b> <a href='../D/3847.html' title='Multiple defined in 3 places.'>PyThread_acquire_lock_timed</a>(<a href='../S/3148.html#L9' title='Defined at 9 in Python/thread_lwp.h.'>lock</a>, waitflag ? -1 : 0, <i><font color='green'>/*intr_flag=*/</font></i>0);
<a name='L538'><font color='red'>}</font>
<a name='L539'>
<a name='L540'><i><font color='green'>/* set the thread stack size.</font></i>
<a name='L541'><i><font color='green'> * Return 0 if size is valid, -1 if size is invalid,</font></i>
<a name='L542'><i><font color='green'> * -2 if setting stack size is not supported.</font></i>
<a name='L543'><i><font color='green'> */</font></i>
<a name='L544'><b>static</b> <b>int</b>
<a name='L545'><a href='../S/3152.html#L583' title='Refered from 583 in Python/thread_pthread.h.'>_pythread_pthread_set_stacksize</a>(<a href='../D/11182.html' title='Multiple defined in 2 places.'>size_t</a> size)
<a name='L546'><font color='red'>{</font>
<a name='L547'><font color='darkred'>#if</font> <b>defined</b>(<a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>)
<a name='L548'>    pthread_attr_t attrs;
<a name='L549'>    <a href='../D/11182.html' title='Multiple defined in 2 places.'>size_t</a> tss_min;
<a name='L550'>    <b>int</b> rc = 0;
<a name='L551'><font color='darkred'>#endif</font>
<a name='L552'>
<a name='L553'>    <i><font color='green'>/* set to default */</font></i>
<a name='L554'>    <b>if</b> (size == 0) <font color='red'>{</font>
<a name='L555'>        _pythread_stacksize = 0;
<a name='L556'>        <b>return</b> 0;
<a name='L557'>    <font color='red'>}</font>
<a name='L558'>
<a name='L559'><font color='darkred'>#if</font> <b>defined</b>(<a href='../D/5146.html' title='Multiple defined in 2 places.'>THREAD_STACK_SIZE</a>)
<a name='L560'><font color='darkred'>#if</font> <b>defined</b>(PTHREAD_STACK_MIN)
<a name='L561'>    tss_min = PTHREAD_STACK_MIN &gt; <a href='../S/3152.html#L22' title='Defined at 22 in Python/thread_pthread.h.'>THREAD_STACK_MIN</a> ? PTHREAD_STACK_MIN
<a name='L562'>                                                   : <a href='../S/3152.html#L22' title='Defined at 22 in Python/thread_pthread.h.'>THREAD_STACK_MIN</a>;
<a name='L563'><font color='darkred'>#else</font>
<a name='L564'>    tss_min = <a href='../S/3152.html#L22' title='Defined at 22 in Python/thread_pthread.h.'>THREAD_STACK_MIN</a>;
<a name='L565'><font color='darkred'>#endif</font>
<a name='L566'>    <b>if</b> (size &gt;= tss_min) <font color='red'>{</font>
<a name='L567'>        <i><font color='green'>/* validate stack size by setting thread attribute */</font></i>
<a name='L568'>        <b>if</b> (pthread_attr_init(&amp;attrs) == 0) <font color='red'>{</font>
<a name='L569'>            rc = pthread_attr_setstacksize(&amp;attrs, size);
<a name='L570'>            pthread_attr_destroy(&amp;attrs);
<a name='L571'>            <b>if</b> (rc == 0) <font color='red'>{</font>
<a name='L572'>                _pythread_stacksize = size;
<a name='L573'>                <b>return</b> 0;
<a name='L574'>            <font color='red'>}</font>
<a name='L575'>        <font color='red'>}</font>
<a name='L576'>    <font color='red'>}</font>
<a name='L577'>    <b>return</b> -1;
<a name='L578'><font color='darkred'>#else</font>
<a name='L579'>    <b>return</b> -2;
<a name='L580'><font color='darkred'>#endif</font>
<a name='L581'><font color='red'>}</font>
<a name='L582'>
<a name='L583'><font color='darkred'>#define</font> <a href='../R/4535.html' title='Multiple refered from 2 places.'>THREAD_SET_STACKSIZE</a>(x) <a href='../S/3152.html#L545' title='Defined at 545 in Python/thread_pthread.h.'>_pythread_pthread_set_stacksize</a>(x)
<a name='L584'>
<a name='L585'><font color='darkred'>#define</font> <a href='../R/3714.html' title='Multiple refered from 2 places.'>Py_HAVE_NATIVE_TLS</a>
<a name='L586'>
<a name='L587'><b>int</b>
<a name='L588'><a href='../S/3134.html#L571' title='Refered from 571 in Python/pystate.c.'>PyThread_create_key</a>(<b>void</b>)
<a name='L589'><font color='red'>{</font>
<a name='L590'>    pthread_key_t <a href='../S/3145.html#L213' title='Defined at 213 in Python/thread.c.'>key</a>;
<a name='L591'>    <b>int</b> fail = pthread_key_create(&amp;<a href='../S/3145.html#L213' title='Defined at 213 in Python/thread.c.'>key</a>, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>);
<a name='L592'>    <b>return</b> fail ? -1 : <a href='../S/3145.html#L213' title='Defined at 213 in Python/thread.c.'>key</a>;
<a name='L593'><font color='red'>}</font>
<a name='L594'>
<a name='L595'><b>void</b>
<a name='L596'><a href='../S/3134.html#L584' title='Refered from 584 in Python/pystate.c.'>PyThread_delete_key</a>(<b>int</b> key)
<a name='L597'><font color='red'>{</font>
<a name='L598'>    pthread_key_delete(<a href='../S/3145.html#L213' title='Defined at 213 in Python/thread.c.'>key</a>);
<a name='L599'><font color='red'>}</font>
<a name='L600'>
<a name='L601'><b>void</b>
<a name='L602'><a href='../R/3455.html' title='Multiple refered from 2 places.'>PyThread_delete_key_value</a>(<b>int</b> key)
<a name='L603'><font color='red'>{</font>
<a name='L604'>    pthread_setspecific(<a href='../S/3145.html#L213' title='Defined at 213 in Python/thread.c.'>key</a>, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>);
<a name='L605'><font color='red'>}</font>
<a name='L606'>
<a name='L607'><b>int</b>
<a name='L608'><a href='../S/3134.html#L616' title='Refered from 616 in Python/pystate.c.'>PyThread_set_key_value</a>(<b>int</b> key, <b>void</b> *value)
<a name='L609'><font color='red'>{</font>
<a name='L610'>    <b>int</b> fail;
<a name='L611'>    <b>void</b> *oldValue = pthread_getspecific(<a href='../S/3145.html#L213' title='Defined at 213 in Python/thread.c.'>key</a>);
<a name='L612'>    <b>if</b> (oldValue != <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L613'>        <b>return</b> 0;
<a name='L614'>    fail = pthread_setspecific(<a href='../S/3145.html#L213' title='Defined at 213 in Python/thread.c.'>key</a>, <a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>);
<a name='L615'>    <b>return</b> fail ? -1 : 0;
<a name='L616'><font color='red'>}</font>
<a name='L617'>
<a name='L618'><b>void</b> *
<a name='L619'><a href='../R/3458.html' title='Multiple refered from 6 places.'>PyThread_get_key_value</a>(<b>int</b> key)
<a name='L620'><font color='red'>{</font>
<a name='L621'>    <b>return</b> pthread_getspecific(<a href='../S/3145.html#L213' title='Defined at 213 in Python/thread.c.'>key</a>);
<a name='L622'><font color='red'>}</font>
<a name='L623'>
<a name='L624'><b>void</b>
<a name='L625'><a href='../R/3448.html' title='Multiple refered from 2 places.'>PyThread_ReInitTLS</a>(<b>void</b>)
<a name='L626'><font color='red'>{</font><font color='red'>}</font>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L137'>[^]</a><a href='#L625'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
