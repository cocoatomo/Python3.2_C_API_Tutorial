<html>
<head>
<title>Include/pyfpe.h</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.8.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/3349.html'>Include</a>/pyfpe.h</h2>
<i><font color='green'>/* [&lt;][&gt;][^][v][top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2><a href='../J/71.html' title='Multiple included from 2 places.'>INCLUDED FROM</a></h2>
<hr>
<pre>
<a name='L1'><font color='darkred'>#ifndef</font> <a href='../S/560.html#L2' title='Defined at 2 in Include/pyfpe.h.'>Py_PYFPE_H</a>
<a name='L2'><font color='darkred'>#define</font> <a href='../S/560.html#L1' title='Refered from 1 in Include/pyfpe.h.'>Py_PYFPE_H</a>
<a name='L3'><font color='darkred'>#ifdef</font> __cplusplus
<a name='L4'><b>extern</b> "C" <font color='red'>{</font>
<a name='L5'><font color='darkred'>#endif</font>
<a name='L6'><i><font color='green'>/*</font></i>
<a name='L7'><i><font color='green'>     ---------------------------------------------------------------------  </font></i>
<a name='L8'><i><font color='green'>    /                       Copyright (c) 1996.                           \ </font></i>
<a name='L9'><i><font color='green'>   |          The Regents of the University of California.                 |</font></i>
<a name='L10'><i><font color='green'>   |                        All rights reserved.                           |</font></i>
<a name='L11'><i><font color='green'>   |                                                                       |</font></i>
<a name='L12'><i><font color='green'>   |   Permission to use, copy, modify, and distribute this software for   |</font></i>
<a name='L13'><i><font color='green'>   |   any purpose without fee is hereby granted, provided that this en-   |</font></i>
<a name='L14'><i><font color='green'>   |   tire notice is included in all copies of any software which is or   |</font></i>
<a name='L15'><i><font color='green'>   |   includes  a  copy  or  modification  of  this software and in all   |</font></i>
<a name='L16'><i><font color='green'>   |   copies of the supporting documentation for such software.           |</font></i>
<a name='L17'><i><font color='green'>   |                                                                       |</font></i>
<a name='L18'><i><font color='green'>   |   This  work was produced at the University of California, Lawrence   |</font></i>
<a name='L19'><i><font color='green'>   |   Livermore National Laboratory under  contract  no.  W-7405-ENG-48   |</font></i>
<a name='L20'><i><font color='green'>   |   between  the  U.S.  Department  of  Energy and The Regents of the   |</font></i>
<a name='L21'><i><font color='green'>   |   University of California for the operation of UC LLNL.              |</font></i>
<a name='L22'><i><font color='green'>   |                                                                       |</font></i>
<a name='L23'><i><font color='green'>   |                              DISCLAIMER                               |</font></i>
<a name='L24'><i><font color='green'>   |                                                                       |</font></i>
<a name='L25'><i><font color='green'>   |   This  software was prepared as an account of work sponsored by an   |</font></i>
<a name='L26'><i><font color='green'>   |   agency of the United States Government. Neither the United States   |</font></i>
<a name='L27'><i><font color='green'>   |   Government  nor the University of California nor any of their em-   |</font></i>
<a name='L28'><i><font color='green'>   |   ployees, makes any warranty, express or implied, or  assumes  any   |</font></i>
<a name='L29'><i><font color='green'>   |   liability  or  responsibility  for the accuracy, completeness, or   |</font></i>
<a name='L30'><i><font color='green'>   |   usefulness of any information,  apparatus,  product,  or  process   |</font></i>
<a name='L31'><i><font color='green'>   |   disclosed,   or  represents  that  its  use  would  not  infringe   |</font></i>
<a name='L32'><i><font color='green'>   |   privately-owned rights. Reference herein to any specific  commer-   |</font></i>
<a name='L33'><i><font color='green'>   |   cial  products,  process,  or  service  by trade name, trademark,   |</font></i>
<a name='L34'><i><font color='green'>   |   manufacturer, or otherwise, does not  necessarily  constitute  or   |</font></i>
<a name='L35'><i><font color='green'>   |   imply  its endorsement, recommendation, or favoring by the United   |</font></i>
<a name='L36'><i><font color='green'>   |   States Government or the University of California. The views  and   |</font></i>
<a name='L37'><i><font color='green'>   |   opinions  of authors expressed herein do not necessarily state or   |</font></i>
<a name='L38'><i><font color='green'>   |   reflect those of the United States Government or  the  University   |</font></i>
<a name='L39'><i><font color='green'>   |   of  California,  and shall not be used for advertising or product   |</font></i>
<a name='L40'><i><font color='green'>    \  endorsement purposes.                                              / </font></i>
<a name='L41'><i><font color='green'>     ---------------------------------------------------------------------  </font></i>
<a name='L42'><i><font color='green'>*/</font></i>
<a name='L43'>
<a name='L44'><i><font color='green'>/*</font></i>
<a name='L45'><i><font color='green'> *       Define macros for handling SIGFPE.</font></i>
<a name='L46'><i><font color='green'> *       Lee Busby, LLNL, November, 1996</font></i>
<a name='L47'><i><font color='green'> *       busby1@llnl.gov</font></i>
<a name='L48'><i><font color='green'> * </font></i>
<a name='L49'><i><font color='green'> *********************************************</font></i>
<a name='L50'><i><font color='green'> * Overview of the system for handling SIGFPE:</font></i>
<a name='L51'><i><font color='green'> * </font></i>
<a name='L52'><i><font color='green'> * This file (Include/pyfpe.h) defines a couple of "wrapper" macros for</font></i>
<a name='L53'><i><font color='green'> * insertion into your Python C code of choice. Their proper use is</font></i>
<a name='L54'><i><font color='green'> * discussed below. The file Python/pyfpe.c defines a pair of global</font></i>
<a name='L55'><i><font color='green'> * variables PyFPE_jbuf and PyFPE_counter which are used by the signal</font></i>
<a name='L56'><i><font color='green'> * handler for SIGFPE to decide if a particular exception was protected</font></i>
<a name='L57'><i><font color='green'> * by the macros. The signal handler itself, and code for enabling the</font></i>
<a name='L58'><i><font color='green'> * generation of SIGFPE in the first place, is in a (new) Python module</font></i>
<a name='L59'><i><font color='green'> * named fpectl. This module is standard in every respect. It can be loaded</font></i>
<a name='L60'><i><font color='green'> * either statically or dynamically as you choose, and like any other</font></i>
<a name='L61'><i><font color='green'> * Python module, has no effect until you import it.</font></i>
<a name='L62'><i><font color='green'> * </font></i>
<a name='L63'><i><font color='green'> * In the general case, there are three steps toward handling SIGFPE in any</font></i>
<a name='L64'><i><font color='green'> * Python code:</font></i>
<a name='L65'><i><font color='green'> * </font></i>
<a name='L66'><i><font color='green'> * 1) Add the *_PROTECT macros to your C code as required to protect</font></i>
<a name='L67'><i><font color='green'> *    dangerous floating point sections.</font></i>
<a name='L68'><i><font color='green'> * </font></i>
<a name='L69'><i><font color='green'> * 2) Turn on the inclusion of the code by adding the ``--with-fpectl''</font></i>
<a name='L70'><i><font color='green'> *    flag at the time you run configure.  If the fpectl or other modules</font></i>
<a name='L71'><i><font color='green'> *    which use the *_PROTECT macros are to be dynamically loaded, be</font></i>
<a name='L72'><i><font color='green'> *    sure they are compiled with WANT_SIGFPE_HANDLER defined.</font></i>
<a name='L73'><i><font color='green'> * </font></i>
<a name='L74'><i><font color='green'> * 3) When python is built and running, import fpectl, and execute</font></i>
<a name='L75'><i><font color='green'> *    fpectl.turnon_sigfpe(). This sets up the signal handler and enables</font></i>
<a name='L76'><i><font color='green'> *    generation of SIGFPE whenever an exception occurs. From this point</font></i>
<a name='L77'><i><font color='green'> *    on, any properly trapped SIGFPE should result in the Python</font></i>
<a name='L78'><i><font color='green'> *    FloatingPointError exception.</font></i>
<a name='L79'><i><font color='green'> * </font></i>
<a name='L80'><i><font color='green'> * Step 1 has been done already for the Python kernel code, and should be</font></i>
<a name='L81'><i><font color='green'> * done soon for the NumPy array package.  Step 2 is usually done once at</font></i>
<a name='L82'><i><font color='green'> * python install time. Python's behavior with respect to SIGFPE is not</font></i>
<a name='L83'><i><font color='green'> * changed unless you also do step 3. Thus you can control this new</font></i>
<a name='L84'><i><font color='green'> * facility at compile time, or run time, or both.</font></i>
<a name='L85'><i><font color='green'> * </font></i>
<a name='L86'><i><font color='green'> ******************************** </font></i>
<a name='L87'><i><font color='green'> * Using the macros in your code:</font></i>
<a name='L88'><i><font color='green'> * </font></i>
<a name='L89'><i><font color='green'> * static PyObject *foobar(PyObject *self,PyObject *args)</font></i>
<a name='L90'><i><font color='green'> * {</font></i>
<a name='L91'><i><font color='green'> *     ....</font></i>
<a name='L92'><i><font color='green'> *     PyFPE_START_PROTECT("Error in foobar", return 0)</font></i>
<a name='L93'><i><font color='green'> *     result = dangerous_op(somearg1, somearg2, ...);</font></i>
<a name='L94'><i><font color='green'> *     PyFPE_END_PROTECT(result)</font></i>
<a name='L95'><i><font color='green'> *     ....</font></i>
<a name='L96'><i><font color='green'> * }</font></i>
<a name='L97'><i><font color='green'> * </font></i>
<a name='L98'><i><font color='green'> * If a floating point error occurs in dangerous_op, foobar returns 0 (NULL),</font></i>
<a name='L99'><i><font color='green'> * after setting the associated value of the FloatingPointError exception to</font></i>
<a name='L100'><i><font color='green'> * "Error in foobar". ``Dangerous_op'' can be a single operation, or a block</font></i>
<a name='L101'><i><font color='green'> * of code, function calls, or any combination, so long as no alternate</font></i>
<a name='L102'><i><font color='green'> * return is possible before the PyFPE_END_PROTECT macro is reached.</font></i>
<a name='L103'><i><font color='green'> * </font></i>
<a name='L104'><i><font color='green'> * The macros can only be used in a function context where an error return</font></i>
<a name='L105'><i><font color='green'> * can be recognized as signaling a Python exception. (Generally, most</font></i>
<a name='L106'><i><font color='green'> * functions that return a PyObject * will qualify.)</font></i>
<a name='L107'><i><font color='green'> * </font></i>
<a name='L108'><i><font color='green'> * Guido's original design suggestion for PyFPE_START_PROTECT and</font></i>
<a name='L109'><i><font color='green'> * PyFPE_END_PROTECT had them open and close a local block, with a locally</font></i>
<a name='L110'><i><font color='green'> * defined jmp_buf and jmp_buf pointer. This would allow recursive nesting</font></i>
<a name='L111'><i><font color='green'> * of the macros. The Ansi C standard makes it clear that such local</font></i>
<a name='L112'><i><font color='green'> * variables need to be declared with the "volatile" type qualifier to keep</font></i>
<a name='L113'><i><font color='green'> * setjmp from corrupting their values. Some current implementations seem</font></i>
<a name='L114'><i><font color='green'> * to be more restrictive. For example, the HPUX man page for setjmp says</font></i>
<a name='L115'><i><font color='green'> * </font></i>
<a name='L116'><i><font color='green'> *   Upon the return from a setjmp() call caused by a longjmp(), the</font></i>
<a name='L117'><i><font color='green'> *   values of any non-static local variables belonging to the routine</font></i>
<a name='L118'><i><font color='green'> *   from which setjmp() was called are undefined. Code which depends on</font></i>
<a name='L119'><i><font color='green'> *   such values is not guaranteed to be portable.</font></i>
<a name='L120'><i><font color='green'> * </font></i>
<a name='L121'><i><font color='green'> * I therefore decided on a more limited form of nesting, using a counter</font></i>
<a name='L122'><i><font color='green'> * variable (PyFPE_counter) to keep track of any recursion.  If an exception</font></i>
<a name='L123'><i><font color='green'> * occurs in an ``inner'' pair of macros, the return will apparently</font></i>
<a name='L124'><i><font color='green'> * come from the outermost level.</font></i>
<a name='L125'><i><font color='green'> * </font></i>
<a name='L126'><i><font color='green'> */</font></i>
<a name='L127'>
<a name='L128'><font color='darkred'>#ifdef</font> WANT_SIGFPE_HANDLER
<a name='L129'><font color='darkred'>#include</font> &lt;signal.h&gt;
<a name='L130'><font color='darkred'>#include</font> &lt;setjmp.h&gt;
<a name='L131'><font color='darkred'>#include</font> &lt;math.h&gt;
<a name='L132'><b>extern</b> jmp_buf PyFPE_jbuf;
<a name='L133'><b>extern</b> <b>int</b> PyFPE_counter;
<a name='L134'><b>extern</b> <b>double</b> <a href='../S/3132.html#L20' title='Defined at 20 in Python/pyfpe.c.'>PyFPE_dummy</a>(<b>void</b> *);
<a name='L135'>
<a name='L136'><font color='darkred'>#define</font> <a href='../R/2939.html' title='Multiple refered from 41 places.'>PyFPE_START_PROTECT</a>(err_string, leave_stmt) \
<a name='L137'><b>if</b> (!PyFPE_counter++ &amp;&amp; setjmp(PyFPE_jbuf)) <font color='red'>{</font> \
<a name='L138'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_FloatingPointError, <a href='../S/2695.html#L550' title='Defined at 550 in Modules/parsermodule.c.'>err_string</a>); \
<a name='L139'>        PyFPE_counter = 0; \
<a name='L140'>        leave_stmt; \
<a name='L141'><font color='red'>}</font>
<a name='L142'>
<a name='L143'><i><font color='green'>/*</font></i>
<a name='L144'><i><font color='green'> * This (following) is a heck of a way to decrement a counter. However,</font></i>
<a name='L145'><i><font color='green'> * unless the macro argument is provided, code optimizers will sometimes move</font></i>
<a name='L146'><i><font color='green'> * this statement so that it gets executed *before* the unsafe expression</font></i>
<a name='L147'><i><font color='green'> * which we're trying to protect.  That pretty well messes things up,</font></i>
<a name='L148'><i><font color='green'> * of course.</font></i>
<a name='L149'><i><font color='green'> * </font></i>
<a name='L150'><i><font color='green'> * If the expression(s) you're trying to protect don't happen to return a</font></i>
<a name='L151'><i><font color='green'> * value, you will need to manufacture a dummy result just to preserve the</font></i>
<a name='L152'><i><font color='green'> * correct ordering of statements.  Note that the macro passes the address</font></i>
<a name='L153'><i><font color='green'> * of its argument (so you need to give it something which is addressable).</font></i>
<a name='L154'><i><font color='green'> * If your expression returns multiple results, pass the last such result</font></i>
<a name='L155'><i><font color='green'> * to PyFPE_END_PROTECT.</font></i>
<a name='L156'><i><font color='green'> * </font></i>
<a name='L157'><i><font color='green'> * Note that PyFPE_dummy returns a double, which is cast to int.</font></i>
<a name='L158'><i><font color='green'> * This seeming insanity is to tickle the Floating Point Unit (FPU).</font></i>
<a name='L159'><i><font color='green'> * If an exception has occurred in a preceding floating point operation,</font></i>
<a name='L160'><i><font color='green'> * some architectures (notably Intel 80x86) will not deliver the interrupt</font></i>
<a name='L161'><i><font color='green'> * until the *next* floating point operation.  This is painful if you've</font></i>
<a name='L162'><i><font color='green'> * already decremented PyFPE_counter.</font></i>
<a name='L163'><i><font color='green'> */</font></i>
<a name='L164'><font color='darkred'>#define</font> <a href='../R/2938.html' title='Multiple refered from 41 places.'>PyFPE_END_PROTECT</a>(v) PyFPE_counter -= (<b>int</b>)<a href='../S/3132.html#L20' title='Defined at 20 in Python/pyfpe.c.'>PyFPE_dummy</a>(&amp;(v));
<a name='L165'>
<a name='L166'><font color='darkred'>#else</font>
<a name='L167'>
<a name='L168'><font color='darkred'>#define</font> <a href='../R/2939.html' title='Multiple refered from 41 places.'>PyFPE_START_PROTECT</a>(err_string, leave_stmt)
<a name='L169'><font color='darkred'>#define</font> <a href='../R/2938.html' title='Multiple refered from 41 places.'>PyFPE_END_PROTECT</a>(v)
<a name='L170'>
<a name='L171'><font color='darkred'>#endif</font>
<a name='L172'>
<a name='L173'><font color='darkred'>#ifdef</font> __cplusplus
<a name='L174'><font color='red'>}</font>
<a name='L175'><font color='darkred'>#endif</font>
<a name='L176'><font color='darkred'>#endif</font> <i><font color='green'>/* !Py_PYFPE_H */</font></i>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;][^][v]<a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
