<html>
<head>
<title>Objects/stringlib/formatter.h</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.8.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/3391.html'>Objects</a>/<a href='../files/3392.html'>stringlib</a>/formatter.h</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L23'>[^]</a><a href='#L1475'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2><a href='3108.html#L14' title='Included from 14 in Python/formatter_unicode.c.'>INCLUDED FROM</a></h2>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L23' title='Defined at 23.'>unknown_presentation_type</a>
<li><a href='#L48' title='Defined at 48.'>invalid_comma_type</a>
<li><a href='#L73' title='Defined at 73.'>get_integer</a>
<li><a href='#L109' title='Defined at 109.'>Py_LOCAL_INLINE</a>
<li><a href='#L121' title='Defined at 121.'>Py_LOCAL_INLINE</a>
<li><a href='#L148' title='Defined at 148.'>DEBUG_PRINT_FORMAT_SPEC</a>
<li><a href='#L171' title='Defined at 171.'>parse_internal_render_format_spec</a>
<li><a href='#L308' title='Defined at 308.'>calc_padding</a>
<li><a href='#L343' title='Defined at 343.'>fill_padding</a>
<li><a href='#L413' title='Defined at 413.'>parse_number</a>
<li><a href='#L438' title='Defined at 438.'>calc_number_widths</a>
<li><a href='#L556' title='Defined at 556.'>fill_number</a>
<li><a href='#L639' title='Defined at 639.'>get_locale_info</a>
<li><a href='#L673' title='Defined at 673.'>format_string_internal</a>
<li><a href='#L740' title='Defined at 740.'>format_int_or_long_internal</a>
<li><a href='#L906' title='Defined at 906.'>strtounicode</a>
<li><a href='#L916' title='Defined at 916.'>format_float_internal</a>
<li><a href='#L1056' title='Defined at 1056.'>format_complex_internal</a>
<li><a href='#L1277' title='Defined at 1277.'>FORMAT_STRING</a>
<li><a href='#L1314' title='Defined at 1314.'>format_int_or_long</a>
<li><a href='#L1384' title='Defined at 1384.'>long_format</a>
<li><a href='#L1395' title='Defined at 1395.'>FORMAT_LONG</a>
<li><a href='#L1407' title='Defined at 1407.'>int_format</a>
<li><a href='#L1416' title='Defined at 1416.'>FORMAT_INT</a>
<li><a href='#L1427' title='Defined at 1427.'>FORMAT_FLOAT</a>
<li><a href='#L1475' title='Defined at 1475.'>FORMAT_COMPLEX</a>
</ol>
<hr>
<pre>
<a name='L1'><i><font color='green'>/* implements the string, long, and float formatters.  that is,</font></i>
<a name='L2'><i><font color='green'>   string.__format__, etc. */</font></i>
<a name='L3'>
<a name='L4'><font color='darkred'>#include</font> &lt;locale.h&gt;
<a name='L5'>
<a name='L6'><i><font color='green'>/* Before including this, you must include either:</font></i>
<a name='L7'><i><font color='green'>   stringlib/unicodedefs.h</font></i>
<a name='L8'><i><font color='green'>   stringlib/stringdefs.h</font></i>
<a name='L9'><i><font color='green'></font></i>
<a name='L10'><i><font color='green'>   Also, you should define the names:</font></i>
<a name='L11'><i><font color='green'>   FORMAT_STRING</font></i>
<a name='L12'><i><font color='green'>   FORMAT_LONG</font></i>
<a name='L13'><i><font color='green'>   FORMAT_FLOAT</font></i>
<a name='L14'><i><font color='green'>   FORMAT_COMPLEX</font></i>
<a name='L15'><i><font color='green'>   to be whatever you want the public names of these functions to</font></i>
<a name='L16'><i><font color='green'>   be.  These are the only non-static functions defined here.</font></i>
<a name='L17'><i><font color='green'>*/</font></i>
<a name='L18'>
<a name='L19'><i><font color='green'>/* Raises an exception about an unknown presentation type for this</font></i>
<a name='L20'><i><font color='green'> * type. */</font></i>
<a name='L21'>
<a name='L22'><b>static</b> <b>void</b>
<a name='L23'><a href='../R/11163.html' title='Multiple refered from 4 places.'>unknown_presentation_type</a>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> presentation_type,
<a name='L24'>                          <b>const</b> <b>char</b>* type_name)
<a name='L25'><font color='red'>{</font>
<a name='L26'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L27'>    <i><font color='green'>/* If STRINGLIB_CHAR is Py_UNICODE, %c might be out-of-range,</font></i>
<a name='L28'><i><font color='green'>       hence the two cases. If it is char, gcc complains that the</font></i>
<a name='L29'><i><font color='green'>       condition below is always true, hence the ifdef. */</font></i>
<a name='L30'>    <b>if</b> (presentation_type &gt; 32 &amp;&amp; presentation_type &lt; 128)
<a name='L31'><font color='darkred'>#endif</font>
<a name='L32'>        <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_ValueError,
<a name='L33'>                     "Unknown format code '%c' "
<a name='L34'>                     "for object of type '%.200s'",
<a name='L35'>                     (<b>char</b>)presentation_type,
<a name='L36'>                     <a href='../S/2824.html#L205' title='Defined at 205 in Objects/typeobject.c.'>type_name</a>);
<a name='L37'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L38'>    <b>else</b>
<a name='L39'>        <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_ValueError,
<a name='L40'>                     "Unknown format code '\\x%x' "
<a name='L41'>                     "for object of type '%.200s'",
<a name='L42'>                     (<b>unsigned</b> <b>int</b>)presentation_type,
<a name='L43'>                     <a href='../S/2824.html#L205' title='Defined at 205 in Objects/typeobject.c.'>type_name</a>);
<a name='L44'><font color='darkred'>#endif</font>
<a name='L45'><font color='red'>}</font>
<a name='L46'>
<a name='L47'><b>static</b> <b>void</b>
<a name='L48'><a href='../S/2813.html#L298' title='Refered from 298 in Objects/stringlib/formatter.h.'>invalid_comma_type</a>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> presentation_type)
<a name='L49'><font color='red'>{</font>
<a name='L50'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L51'>    <i><font color='green'>/* See comment in unknown_presentation_type */</font></i>
<a name='L52'>    <b>if</b> (presentation_type &gt; 32 &amp;&amp; presentation_type &lt; 128)
<a name='L53'><font color='darkred'>#endif</font>
<a name='L54'>        <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_ValueError,
<a name='L55'>                     "Cannot specify ',' with '%c'.",
<a name='L56'>                     (<b>char</b>)presentation_type);
<a name='L57'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L58'>    <b>else</b>
<a name='L59'>        <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_ValueError,
<a name='L60'>                     "Cannot specify ',' with '\\x%x'.",
<a name='L61'>                     (<b>unsigned</b> <b>int</b>)presentation_type);
<a name='L62'><font color='darkred'>#endif</font>
<a name='L63'><font color='red'>}</font>
<a name='L64'>
<a name='L65'><i><font color='green'>/*</font></i>
<a name='L66'><i><font color='green'>    get_integer consumes 0 or more decimal digit characters from an</font></i>
<a name='L67'><i><font color='green'>    input string, updates *result with the corresponding positive</font></i>
<a name='L68'><i><font color='green'>    integer, and returns the number of digits consumed.</font></i>
<a name='L69'><i><font color='green'></font></i>
<a name='L70'><i><font color='green'>    returns -1 on error.</font></i>
<a name='L71'><i><font color='green'>*/</font></i>
<a name='L72'><b>static</b> <b>int</b>
<a name='L73'><a href='../R/8063.html' title='Multiple refered from 4 places.'>get_integer</a>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> **ptr, <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *end,
<a name='L74'>                  <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> *result)
<a name='L75'><font color='red'>{</font>
<a name='L76'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> accumulator, digitval, oldaccumulator;
<a name='L77'>    <b>int</b> numdigits;
<a name='L78'>    accumulator = numdigits = 0;
<a name='L79'>    <b>for</b> (;;(*ptr)++, numdigits++) <font color='red'>{</font>
<a name='L80'>        <b>if</b> (*ptr &gt;= end)
<a name='L81'>            <b>break</b>;
<a name='L82'>        digitval = <a href='../D/5006.html' title='Multiple defined in 2 places.'>STRINGLIB_TODECIMAL</a>(**ptr);
<a name='L83'>        <b>if</b> (digitval &lt; 0)
<a name='L84'>            <b>break</b>;
<a name='L85'>        <i><font color='green'>/*</font></i>
<a name='L86'><i><font color='green'>           This trick was copied from old Unicode format code.  It's cute,</font></i>
<a name='L87'><i><font color='green'>           but would really suck on an old machine with a slow divide</font></i>
<a name='L88'><i><font color='green'>           implementation.  Fortunately, in the normal case we do not</font></i>
<a name='L89'><i><font color='green'>           expect too many digits.</font></i>
<a name='L90'><i><font color='green'>        */</font></i>
<a name='L91'>        oldaccumulator = accumulator;
<a name='L92'>        accumulator *= 10;
<a name='L93'>        <b>if</b> ((accumulator+10)/10 != oldaccumulator+1) <font color='red'>{</font>
<a name='L94'>            <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_ValueError,
<a name='L95'>                         "Too many decimal digits in format string");
<a name='L96'>            <b>return</b> -1;
<a name='L97'>        <font color='red'>}</font>
<a name='L98'>        accumulator += digitval;
<a name='L99'>    <font color='red'>}</font>
<a name='L100'>    *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = accumulator;
<a name='L101'>    <b>return</b> numdigits;
<a name='L102'><font color='red'>}</font>
<a name='L103'>
<a name='L104'><i><font color='green'>/************************************************************************/</font></i>
<a name='L105'><i><font color='green'>/*********** standard format specifier parsing **************************/</font></i>
<a name='L106'><i><font color='green'>/************************************************************************/</font></i>
<a name='L107'>
<a name='L108'><i><font color='green'>/* returns true if this character is a specifier alignment token */</font></i>
<a name='L109'>Py_LOCAL_INLINE(<b>int</b>)
<a name='L110'>is_alignment_token(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> c)
<a name='L111'><font color='red'>{</font>
<a name='L112'>    <b>switch</b> (c) <font color='red'>{</font>
<a name='L113'>    <b>case</b> '&lt;': <b>case</b> '&gt;': <b>case</b> '=': <b>case</b> '^':
<a name='L114'>        <b>return</b> 1;
<a name='L115'>    <b>default</b>:
<a name='L116'>        <b>return</b> 0;
<a name='L117'>    <font color='red'>}</font>
<a name='L118'><font color='red'>}</font>
<a name='L119'>
<a name='L120'><i><font color='green'>/* returns true if this character is a sign element */</font></i>
<a name='L121'>Py_LOCAL_INLINE(<b>int</b>)
<a name='L122'>is_sign_element(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> c)
<a name='L123'><font color='red'>{</font>
<a name='L124'>    <b>switch</b> (c) <font color='red'>{</font>
<a name='L125'>    <b>case</b> ' ': <b>case</b> '+': <b>case</b> '-':
<a name='L126'>        <b>return</b> 1;
<a name='L127'>    <b>default</b>:
<a name='L128'>        <b>return</b> 0;
<a name='L129'>    <font color='red'>}</font>
<a name='L130'><font color='red'>}</font>
<a name='L131'>
<a name='L132'>
<a name='L133'><b>typedef</b> <b>struct</b> <font color='red'>{</font>
<a name='L134'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> fill_char;
<a name='L135'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>;
<a name='L136'>    <b>int</b> alternate;
<a name='L137'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> sign;
<a name='L138'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> width;
<a name='L139'>    <b>int</b> thousands_separators;
<a name='L140'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> precision;
<a name='L141'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> type;
<a name='L142'><font color='red'>}</font> <a href='../R/1635.html' title='Multiple refered from 5 places.'>InternalFormatSpec</a>;
<a name='L143'>
<a name='L144'>
<a name='L145'><font color='darkred'>#if</font> 0
<a name='L146'><i><font color='green'>/* Occassionally useful for debugging. Should normally be commented out. */</font></i>
<a name='L147'><b>static</b> <b>void</b>
<a name='L148'>DEBUG_PRINT_FORMAT_SPEC(InternalFormatSpec *format)
<a name='L149'><font color='red'>{</font>
<a name='L150'>    printf("internal format spec: fill_char %d\n", format-&gt;fill_char);
<a name='L151'>    printf("internal format spec: align %d\n", format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>);
<a name='L152'>    printf("internal format spec: alternate %d\n", format-&gt;alternate);
<a name='L153'>    printf("internal format spec: sign %d\n", format-&gt;sign);
<a name='L154'>    printf("internal format spec: width %zd\n", format-&gt;width);
<a name='L155'>    printf("internal format spec: thousands_separators %d\n",
<a name='L156'>           format-&gt;thousands_separators);
<a name='L157'>    printf("internal format spec: precision %zd\n", format-&gt;precision);
<a name='L158'>    printf("internal format spec: type %c\n", format-&gt;type);
<a name='L159'>    printf("\n");
<a name='L160'><font color='red'>}</font>
<a name='L161'><font color='darkred'>#endif</font>
<a name='L162'>
<a name='L163'>
<a name='L164'><i><font color='green'>/*</font></i>
<a name='L165'><i><font color='green'>  ptr points to the start of the format_spec, end points just past its end.</font></i>
<a name='L166'><i><font color='green'>  fills in format with the parsed information.</font></i>
<a name='L167'><i><font color='green'>  returns 1 on success, 0 on failure.</font></i>
<a name='L168'><i><font color='green'>  if failure, sets the exception</font></i>
<a name='L169'><i><font color='green'>*/</font></i>
<a name='L170'><b>static</b> <b>int</b>
<a name='L171'><a href='../R/9457.html' title='Multiple refered from 4 places.'>parse_internal_render_format_spec</a>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *format_spec,
<a name='L172'>                                  <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> format_spec_len,
<a name='L173'>                                  InternalFormatSpec *format,
<a name='L174'>                                  <b>char</b> default_type,
<a name='L175'>                                  <b>char</b> default_align)
<a name='L176'><font color='red'>{</font>
<a name='L177'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *ptr = format_spec;
<a name='L178'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *end = format_spec + format_spec_len;
<a name='L179'>
<a name='L180'>    <i><font color='green'>/* end-ptr is used throughout this code to specify the length of</font></i>
<a name='L181'><i><font color='green'>       the input string */</font></i>
<a name='L182'>
<a name='L183'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> consumed;
<a name='L184'>    <b>int</b> align_specified = 0;
<a name='L185'>
<a name='L186'>    format-&gt;fill_char = '\0';
<a name='L187'>    format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = default_align;
<a name='L188'>    format-&gt;alternate = 0;
<a name='L189'>    format-&gt;sign = '\0';
<a name='L190'>    format-&gt;width = -1;
<a name='L191'>    format-&gt;thousands_separators = 0;
<a name='L192'>    format-&gt;precision = -1;
<a name='L193'>    format-&gt;type = default_type;
<a name='L194'>
<a name='L195'>    <i><font color='green'>/* If the second char is an alignment token,</font></i>
<a name='L196'><i><font color='green'>       then parse the fill char */</font></i>
<a name='L197'>    <b>if</b> (end-ptr &gt;= 2 &amp;&amp; is_alignment_token(ptr[1])) <font color='red'>{</font>
<a name='L198'>        format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = ptr[1];
<a name='L199'>        format-&gt;fill_char = ptr[0];
<a name='L200'>        align_specified = 1;
<a name='L201'>        ptr += 2;
<a name='L202'>    <font color='red'>}</font>
<a name='L203'>    <b>else</b> <b>if</b> (end-ptr &gt;= 1 &amp;&amp; is_alignment_token(ptr[0])) <font color='red'>{</font>
<a name='L204'>        format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = ptr[0];
<a name='L205'>        align_specified = 1;
<a name='L206'>        ++ptr;
<a name='L207'>    <font color='red'>}</font>
<a name='L208'>
<a name='L209'>    <i><font color='green'>/* Parse the various sign options */</font></i>
<a name='L210'>    <b>if</b> (end-ptr &gt;= 1 &amp;&amp; is_sign_element(ptr[0])) <font color='red'>{</font>
<a name='L211'>        format-&gt;sign = ptr[0];
<a name='L212'>        ++ptr;
<a name='L213'>    <font color='red'>}</font>
<a name='L214'>
<a name='L215'>    <i><font color='green'>/* If the next character is #, we're in alternate mode.  This only</font></i>
<a name='L216'><i><font color='green'>       applies to integers. */</font></i>
<a name='L217'>    <b>if</b> (end-ptr &gt;= 1 &amp;&amp; ptr[0] == '#') <font color='red'>{</font>
<a name='L218'>        format-&gt;alternate = 1;
<a name='L219'>        ++ptr;
<a name='L220'>    <font color='red'>}</font>
<a name='L221'>
<a name='L222'>    <i><font color='green'>/* The special case for 0-padding (backwards compat) */</font></i>
<a name='L223'>    <b>if</b> (format-&gt;fill_char == '\0' &amp;&amp; end-ptr &gt;= 1 &amp;&amp; ptr[0] == '0') <font color='red'>{</font>
<a name='L224'>        format-&gt;fill_char = '0';
<a name='L225'>        <b>if</b> (!align_specified) <font color='red'>{</font>
<a name='L226'>            format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = '=';
<a name='L227'>        <font color='red'>}</font>
<a name='L228'>        ++ptr;
<a name='L229'>    <font color='red'>}</font>
<a name='L230'>
<a name='L231'>    consumed = <a href='../D/8865.html' title='Multiple defined in 2 places.'>get_integer</a>(&amp;ptr, end, &amp;format-&gt;width);
<a name='L232'>    <b>if</b> (consumed == -1)
<a name='L233'>        <i><font color='green'>/* Overflow error. Exception already set. */</font></i>
<a name='L234'>        <b>return</b> 0;
<a name='L235'>
<a name='L236'>    <i><font color='green'>/* If consumed is 0, we didn't consume any characters for the</font></i>
<a name='L237'><i><font color='green'>       width. In that case, reset the width to -1, because</font></i>
<a name='L238'><i><font color='green'>       get_integer() will have set it to zero. -1 is how we record</font></i>
<a name='L239'><i><font color='green'>       that the width wasn't specified. */</font></i>
<a name='L240'>    <b>if</b> (consumed == 0)
<a name='L241'>        format-&gt;width = -1;
<a name='L242'>
<a name='L243'>    <i><font color='green'>/* Comma signifies add thousands separators */</font></i>
<a name='L244'>    <b>if</b> (end-ptr &amp;&amp; ptr[0] == ',') <font color='red'>{</font>
<a name='L245'>        format-&gt;thousands_separators = 1;
<a name='L246'>        ++ptr;
<a name='L247'>    <font color='red'>}</font>
<a name='L248'>
<a name='L249'>    <i><font color='green'>/* Parse field precision */</font></i>
<a name='L250'>    <b>if</b> (end-ptr &amp;&amp; ptr[0] == '.') <font color='red'>{</font>
<a name='L251'>        ++ptr;
<a name='L252'>
<a name='L253'>        consumed = <a href='../D/8865.html' title='Multiple defined in 2 places.'>get_integer</a>(&amp;ptr, end, &amp;format-&gt;precision);
<a name='L254'>        <b>if</b> (consumed == -1)
<a name='L255'>            <i><font color='green'>/* Overflow error. Exception already set. */</font></i>
<a name='L256'>            <b>return</b> 0;
<a name='L257'>
<a name='L258'>        <i><font color='green'>/* Not having a precision after a dot is an error. */</font></i>
<a name='L259'>        <b>if</b> (consumed == 0) <font color='red'>{</font>
<a name='L260'>            <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_ValueError,
<a name='L261'>                         "Format specifier missing precision");
<a name='L262'>            <b>return</b> 0;
<a name='L263'>        <font color='red'>}</font>
<a name='L264'>
<a name='L265'>    <font color='red'>}</font>
<a name='L266'>
<a name='L267'>    <i><font color='green'>/* Finally, parse the type field. */</font></i>
<a name='L268'>
<a name='L269'>    <b>if</b> (end-ptr &gt; 1) <font color='red'>{</font>
<a name='L270'>        <i><font color='green'>/* More than one char remain, invalid conversion spec. */</font></i>
<a name='L271'>        <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_ValueError, "Invalid conversion specification");
<a name='L272'>        <b>return</b> 0;
<a name='L273'>    <font color='red'>}</font>
<a name='L274'>
<a name='L275'>    <b>if</b> (end-ptr == 1) <font color='red'>{</font>
<a name='L276'>        format-&gt;type = ptr[0];
<a name='L277'>        ++ptr;
<a name='L278'>    <font color='red'>}</font>
<a name='L279'>
<a name='L280'>    <i><font color='green'>/* Do as much validating as we can, just by looking at the format</font></i>
<a name='L281'><i><font color='green'>       specifier.  Do not take into account what type of formatting</font></i>
<a name='L282'><i><font color='green'>       we're doing (int, float, string). */</font></i>
<a name='L283'>
<a name='L284'>    <b>if</b> (format-&gt;thousands_separators) <font color='red'>{</font>
<a name='L285'>        <b>switch</b> (format-&gt;type) <font color='red'>{</font>
<a name='L286'>        <b>case</b> 'd':
<a name='L287'>        <b>case</b> 'e':
<a name='L288'>        <b>case</b> 'f':
<a name='L289'>        <b>case</b> 'g':
<a name='L290'>        <b>case</b> 'E':
<a name='L291'>        <b>case</b> 'G':
<a name='L292'>        <b>case</b> '%':
<a name='L293'>        <b>case</b> 'F':
<a name='L294'>        <b>case</b> '\0':
<a name='L295'>            <i><font color='green'>/* These are allowed. See PEP 378.*/</font></i>
<a name='L296'>            <b>break</b>;
<a name='L297'>        <b>default</b>:
<a name='L298'>            <a href='../S/2813.html#L48' title='Defined at 48 in Objects/stringlib/formatter.h.'>invalid_comma_type</a>(format-&gt;type);
<a name='L299'>            <b>return</b> 0;
<a name='L300'>        <font color='red'>}</font>
<a name='L301'>    <font color='red'>}</font>
<a name='L302'>
<a name='L303'>    <b>return</b> 1;
<a name='L304'><font color='red'>}</font>
<a name='L305'>
<a name='L306'><i><font color='green'>/* Calculate the padding needed. */</font></i>
<a name='L307'><b>static</b> <b>void</b>
<a name='L308'><a href='../R/6542.html' title='Multiple refered from 2 places.'>calc_padding</a>(<a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> nchars, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> width, <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> align,
<a name='L309'>             <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> *n_lpadding, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> *n_rpadding,
<a name='L310'>             <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> *n_total)
<a name='L311'><font color='red'>{</font>
<a name='L312'>    <b>if</b> (width &gt;= 0) <font color='red'>{</font>
<a name='L313'>        <b>if</b> (nchars &gt; width)
<a name='L314'>            *n_total = nchars;
<a name='L315'>        <b>else</b>
<a name='L316'>            *n_total = width;
<a name='L317'>    <font color='red'>}</font>
<a name='L318'>    <b>else</b> <font color='red'>{</font>
<a name='L319'>        <i><font color='green'>/* not specified, use all of the chars and no more */</font></i>
<a name='L320'>        *n_total = nchars;
<a name='L321'>    <font color='red'>}</font>
<a name='L322'>
<a name='L323'>    <i><font color='green'>/* Figure out how much leading space we need, based on the</font></i>
<a name='L324'><i><font color='green'>       aligning */</font></i>
<a name='L325'>    <b>if</b> (<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> == '&gt;')
<a name='L326'>        *n_lpadding = *n_total - nchars;
<a name='L327'>    <b>else</b> <b>if</b> (<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> == '^')
<a name='L328'>        *n_lpadding = (*n_total - nchars) / 2;
<a name='L329'>    <b>else</b> <b>if</b> (<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> == '&lt;' || <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> == '=')
<a name='L330'>        *n_lpadding = 0;
<a name='L331'>    <b>else</b> <font color='red'>{</font>
<a name='L332'>        <i><font color='green'>/* We should never have an unspecified alignment. */</font></i>
<a name='L333'>        *n_lpadding = 0;
<a name='L334'>        <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(0);
<a name='L335'>    <font color='red'>}</font>
<a name='L336'>
<a name='L337'>    *n_rpadding = *n_total - nchars - *n_lpadding;
<a name='L338'><font color='red'>}</font>
<a name='L339'>
<a name='L340'><i><font color='green'>/* Do the padding, and return a pointer to where the caller-supplied</font></i>
<a name='L341'><i><font color='green'>   content goes. */</font></i>
<a name='L342'><b>static</b> <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *
<a name='L343'><a href='../R/7784.html' title='Multiple refered from 2 places.'>fill_padding</a>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *p, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> nchars, <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> fill_char,
<a name='L344'>             <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_lpadding, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_rpadding)
<a name='L345'><font color='red'>{</font>
<a name='L346'>    <i><font color='green'>/* Pad on left. */</font></i>
<a name='L347'>    <b>if</b> (n_lpadding)
<a name='L348'>        <a href='../D/4986.html' title='Multiple defined in 2 places.'>STRINGLIB_FILL</a>(p, fill_char, n_lpadding);
<a name='L349'>
<a name='L350'>    <i><font color='green'>/* Pad on right. */</font></i>
<a name='L351'>    <b>if</b> (n_rpadding)
<a name='L352'>        <a href='../D/4986.html' title='Multiple defined in 2 places.'>STRINGLIB_FILL</a>(p + nchars + n_lpadding, fill_char, n_rpadding);
<a name='L353'>
<a name='L354'>    <i><font color='green'>/* Pointer to the user content. */</font></i>
<a name='L355'>    <b>return</b> p + n_lpadding;
<a name='L356'><font color='red'>}</font>
<a name='L357'>
<a name='L358'><font color='darkred'>#if</font> <b>defined</b> <a href='../D/1290.html' title='Multiple defined in 2 places.'>FORMAT_FLOAT</a> || <b>defined</b> <a href='../D/1292.html' title='Multiple defined in 2 places.'>FORMAT_LONG</a> || <b>defined</b> <a href='../D/1289.html' title='Multiple defined in 2 places.'>FORMAT_COMPLEX</a>
<a name='L359'><i><font color='green'>/************************************************************************/</font></i>
<a name='L360'><i><font color='green'>/*********** common routines for numeric formatting *********************/</font></i>
<a name='L361'><i><font color='green'>/************************************************************************/</font></i>
<a name='L362'>
<a name='L363'><i><font color='green'>/* Locale type codes. */</font></i>
<a name='L364'><font color='darkred'>#define</font> <a href='../R/1779.html' title='Multiple refered from 4 places.'>LT_CURRENT_LOCALE</a> 0
<a name='L365'><font color='darkred'>#define</font> <a href='../R/1780.html' title='Multiple refered from 4 places.'>LT_DEFAULT_LOCALE</a> 1
<a name='L366'><font color='darkred'>#define</font> <a href='../R/1781.html' title='Multiple refered from 4 places.'>LT_NO_LOCALE</a> 2
<a name='L367'>
<a name='L368'><i><font color='green'>/* Locale info needed for formatting integers and the part of floats</font></i>
<a name='L369'><i><font color='green'>   before and including the decimal. Note that locales only support</font></i>
<a name='L370'><i><font color='green'>   8-bit chars, not unicode. */</font></i>
<a name='L371'><b>typedef</b> <b>struct</b> <font color='red'>{</font>
<a name='L372'>    <b>char</b> *decimal_point;
<a name='L373'>    <b>char</b> *thousands_sep;
<a name='L374'>    <b>char</b> *grouping;
<a name='L375'><font color='red'>}</font> <a href='../R/1798.html' title='Multiple refered from 3 places.'>LocaleInfo</a>;
<a name='L376'>
<a name='L377'><i><font color='green'>/* describes the layout for an integer, see the comment in</font></i>
<a name='L378'><i><font color='green'>   calc_number_widths() for details */</font></i>
<a name='L379'><b>typedef</b> <b>struct</b> <font color='red'>{</font>
<a name='L380'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_lpadding;
<a name='L381'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_prefix;
<a name='L382'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_spadding;
<a name='L383'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_rpadding;
<a name='L384'>    <b>char</b> sign;
<a name='L385'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_sign;      <i><font color='green'>/* number of digits needed for sign (0/1) */</font></i>
<a name='L386'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_grouped_digits; <i><font color='green'>/* Space taken up by the digits, including</font></i>
<a name='L387'><i><font color='green'>                                    any grouping chars. */</font></i>
<a name='L388'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_decimal;   <i><font color='green'>/* 0 if only an integer */</font></i>
<a name='L389'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_remainder; <i><font color='green'>/* Digits in decimal and/or exponent part,</font></i>
<a name='L390'><i><font color='green'>                               excluding the decimal itself, if</font></i>
<a name='L391'><i><font color='green'>                               present. */</font></i>
<a name='L392'>
<a name='L393'>    <i><font color='green'>/* These 2 are not the widths of fields, but are needed by</font></i>
<a name='L394'><i><font color='green'>       STRINGLIB_GROUPING. */</font></i>
<a name='L395'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_digits;    <i><font color='green'>/* The number of digits before a decimal</font></i>
<a name='L396'><i><font color='green'>                               or exponent. */</font></i>
<a name='L397'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_min_width; <i><font color='green'>/* The min_width we used when we computed</font></i>
<a name='L398'><i><font color='green'>                               the n_grouped_digits width. */</font></i>
<a name='L399'><font color='red'>}</font> <a href='../R/2172.html' title='Multiple refered from 4 places.'>NumberFieldWidths</a>;
<a name='L400'>
<a name='L401'>
<a name='L402'><i><font color='green'>/* Given a number of the form:</font></i>
<a name='L403'><i><font color='green'>   digits[remainder]</font></i>
<a name='L404'><i><font color='green'>   where ptr points to the start and end points to the end, find where</font></i>
<a name='L405'><i><font color='green'>    the integer part ends. This could be a decimal, an exponent, both,</font></i>
<a name='L406'><i><font color='green'>    or neither.</font></i>
<a name='L407'><i><font color='green'>   If a decimal point is present, set *has_decimal and increment</font></i>
<a name='L408'><i><font color='green'>    remainder beyond it.</font></i>
<a name='L409'><i><font color='green'>   Results are undefined (but shouldn't crash) for improperly</font></i>
<a name='L410'><i><font color='green'>    formatted strings.</font></i>
<a name='L411'><i><font color='green'>*/</font></i>
<a name='L412'><b>static</b> <b>void</b>
<a name='L413'><a href='../R/9458.html' title='Multiple refered from 3 places.'>parse_number</a>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *ptr, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> len,
<a name='L414'>             <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> *n_remainder, <b>int</b> *has_decimal)
<a name='L415'><font color='red'>{</font>
<a name='L416'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *end = ptr + len;
<a name='L417'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *remainder;
<a name='L418'>
<a name='L419'>    <b>while</b> (ptr&lt;end &amp;&amp; isdigit(*ptr))
<a name='L420'>        ++ptr;
<a name='L421'>    remainder = ptr;
<a name='L422'>
<a name='L423'>    <i><font color='green'>/* Does remainder start with a decimal point? */</font></i>
<a name='L424'>    *has_decimal = ptr&lt;end &amp;&amp; *remainder == '.';
<a name='L425'>
<a name='L426'>    <i><font color='green'>/* Skip the decimal point. */</font></i>
<a name='L427'>    <b>if</b> (*has_decimal)
<a name='L428'>        remainder++;
<a name='L429'>
<a name='L430'>    *n_remainder = end - remainder;
<a name='L431'><font color='red'>}</font>
<a name='L432'>
<a name='L433'><i><font color='green'>/* not all fields of format are used.  for example, precision is</font></i>
<a name='L434'><i><font color='green'>   unused.  should this take discrete params in order to be more clear</font></i>
<a name='L435'><i><font color='green'>   about what it does?  or is passing a single format parameter easier</font></i>
<a name='L436'><i><font color='green'>   and more efficient enough to justify a little obfuscation? */</font></i>
<a name='L437'><b>static</b> <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a>
<a name='L438'><a href='../R/6541.html' title='Multiple refered from 4 places.'>calc_number_widths</a>(NumberFieldWidths *spec, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_prefix,
<a name='L439'>                   <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> sign_char, <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *number,
<a name='L440'>                   <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_number, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_remainder,
<a name='L441'>                   <b>int</b> has_decimal, <b>const</b> LocaleInfo *locale,
<a name='L442'>                   <b>const</b> InternalFormatSpec *format)
<a name='L443'><font color='red'>{</font>
<a name='L444'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_non_digit_non_padding;
<a name='L445'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_padding;
<a name='L446'>
<a name='L447'>    spec-&gt;n_digits = n_number - n_remainder - (has_decimal?1:0);
<a name='L448'>    spec-&gt;n_lpadding = 0;
<a name='L449'>    spec-&gt;n_prefix = n_prefix;
<a name='L450'>    spec-&gt;n_decimal = has_decimal ? strlen(locale-&gt;decimal_point) : 0;
<a name='L451'>    spec-&gt;n_remainder = n_remainder;
<a name='L452'>    spec-&gt;n_spadding = 0;
<a name='L453'>    spec-&gt;n_rpadding = 0;
<a name='L454'>    spec-&gt;sign = '\0';
<a name='L455'>    spec-&gt;n_sign = 0;
<a name='L456'>
<a name='L457'>    <i><font color='green'>/* the output will look like:</font></i>
<a name='L458'><i><font color='green'>       |                                                                                         |</font></i>
<a name='L459'><i><font color='green'>       | &lt;lpadding&gt; &lt;sign&gt; &lt;prefix&gt; &lt;spadding&gt; &lt;grouped_digits&gt; &lt;decimal&gt; &lt;remainder&gt; &lt;rpadding&gt; |</font></i>
<a name='L460'><i><font color='green'>       |                                                                                         |</font></i>
<a name='L461'><i><font color='green'></font></i>
<a name='L462'><i><font color='green'>       sign is computed from format-&gt;sign and the actual</font></i>
<a name='L463'><i><font color='green'>       sign of the number</font></i>
<a name='L464'><i><font color='green'></font></i>
<a name='L465'><i><font color='green'>       prefix is given (it's for the '0x' prefix)</font></i>
<a name='L466'><i><font color='green'></font></i>
<a name='L467'><i><font color='green'>       digits is already known</font></i>
<a name='L468'><i><font color='green'></font></i>
<a name='L469'><i><font color='green'>       the total width is either given, or computed from the</font></i>
<a name='L470'><i><font color='green'>       actual digits</font></i>
<a name='L471'><i><font color='green'></font></i>
<a name='L472'><i><font color='green'>       only one of lpadding, spadding, and rpadding can be non-zero,</font></i>
<a name='L473'><i><font color='green'>       and it's calculated from the width and other fields</font></i>
<a name='L474'><i><font color='green'>    */</font></i>
<a name='L475'>
<a name='L476'>    <i><font color='green'>/* compute the various parts we're going to write */</font></i>
<a name='L477'>    <b>switch</b> (format-&gt;sign) <font color='red'>{</font>
<a name='L478'>    <b>case</b> '+':
<a name='L479'>        <i><font color='green'>/* always put a + or - */</font></i>
<a name='L480'>        spec-&gt;n_sign = 1;
<a name='L481'>        spec-&gt;sign = (sign_char == '-' ? '-' : '+');
<a name='L482'>        <b>break</b>;
<a name='L483'>    <b>case</b> ' ':
<a name='L484'>        spec-&gt;n_sign = 1;
<a name='L485'>        spec-&gt;sign = (sign_char == '-' ? '-' : ' ');
<a name='L486'>        <b>break</b>;
<a name='L487'>    <b>default</b>:
<a name='L488'>        <i><font color='green'>/* Not specified, or the default (-) */</font></i>
<a name='L489'>        <b>if</b> (sign_char == '-') <font color='red'>{</font>
<a name='L490'>            spec-&gt;n_sign = 1;
<a name='L491'>            spec-&gt;sign = '-';
<a name='L492'>        <font color='red'>}</font>
<a name='L493'>    <font color='red'>}</font>
<a name='L494'>
<a name='L495'>    <i><font color='green'>/* The number of chars used for non-digits and non-padding. */</font></i>
<a name='L496'>    n_non_digit_non_padding = spec-&gt;n_sign + spec-&gt;n_prefix + spec-&gt;n_decimal +
<a name='L497'>        spec-&gt;n_remainder;
<a name='L498'>
<a name='L499'>    <i><font color='green'>/* min_width can go negative, that's okay. format-&gt;width == -1 means</font></i>
<a name='L500'><i><font color='green'>       we don't care. */</font></i>
<a name='L501'>    <b>if</b> (format-&gt;fill_char == '0' &amp;&amp; format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> == '=')
<a name='L502'>        spec-&gt;n_min_width = format-&gt;width - n_non_digit_non_padding;
<a name='L503'>    <b>else</b>
<a name='L504'>        spec-&gt;n_min_width = 0;
<a name='L505'>
<a name='L506'>    <b>if</b> (spec-&gt;n_digits == 0)
<a name='L507'>        <i><font color='green'>/* This case only occurs when using 'c' formatting, we need</font></i>
<a name='L508'><i><font color='green'>           to special case it because the grouping code always wants</font></i>
<a name='L509'><i><font color='green'>           to have at least one character. */</font></i>
<a name='L510'>        spec-&gt;n_grouped_digits = 0;
<a name='L511'>    <b>else</b>
<a name='L512'>        spec-&gt;n_grouped_digits = <a href='../D/4988.html' title='Multiple defined in 2 places.'>STRINGLIB_GROUPING</a>(<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, 0, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>,
<a name='L513'>                                                    spec-&gt;n_digits,
<a name='L514'>                                                    spec-&gt;n_min_width,
<a name='L515'>                                                    locale-&gt;grouping,
<a name='L516'>                                                    locale-&gt;thousands_sep);
<a name='L517'>
<a name='L518'>    <i><font color='green'>/* Given the desired width and the total of digit and non-digit</font></i>
<a name='L519'><i><font color='green'>       space we consume, see if we need any padding. format-&gt;width can</font></i>
<a name='L520'><i><font color='green'>       be negative (meaning no padding), but this code still works in</font></i>
<a name='L521'><i><font color='green'>       that case. */</font></i>
<a name='L522'>    n_padding = format-&gt;width -
<a name='L523'>                        (n_non_digit_non_padding + spec-&gt;n_grouped_digits);
<a name='L524'>    <b>if</b> (n_padding &gt; 0) <font color='red'>{</font>
<a name='L525'>        <i><font color='green'>/* Some padding is needed. Determine if it's left, space, or right. */</font></i>
<a name='L526'>        <b>switch</b> (format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>) <font color='red'>{</font>
<a name='L527'>        <b>case</b> '&lt;':
<a name='L528'>            spec-&gt;n_rpadding = n_padding;
<a name='L529'>            <b>break</b>;
<a name='L530'>        <b>case</b> '^':
<a name='L531'>            spec-&gt;n_lpadding = n_padding / 2;
<a name='L532'>            spec-&gt;n_rpadding = n_padding - spec-&gt;n_lpadding;
<a name='L533'>            <b>break</b>;
<a name='L534'>        <b>case</b> '=':
<a name='L535'>            spec-&gt;n_spadding = n_padding;
<a name='L536'>            <b>break</b>;
<a name='L537'>        <b>case</b> '&gt;':
<a name='L538'>            spec-&gt;n_lpadding = n_padding;
<a name='L539'>            <b>break</b>;
<a name='L540'>        <b>default</b>:
<a name='L541'>            <i><font color='green'>/* Shouldn't get here, but treat it as '&gt;' */</font></i>
<a name='L542'>            spec-&gt;n_lpadding = n_padding;
<a name='L543'>            <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(0);
<a name='L544'>            <b>break</b>;
<a name='L545'>        <font color='red'>}</font>
<a name='L546'>    <font color='red'>}</font>
<a name='L547'>    <b>return</b> spec-&gt;n_lpadding + spec-&gt;n_sign + spec-&gt;n_prefix +
<a name='L548'>        spec-&gt;n_spadding + spec-&gt;n_grouped_digits + spec-&gt;n_decimal +
<a name='L549'>        spec-&gt;n_remainder + spec-&gt;n_rpadding;
<a name='L550'><font color='red'>}</font>
<a name='L551'>
<a name='L552'><i><font color='green'>/* Fill in the digit parts of a numbers's string representation,</font></i>
<a name='L553'><i><font color='green'>   as determined in calc_number_widths().</font></i>
<a name='L554'><i><font color='green'>   No error checking, since we know the buffer is the correct size. */</font></i>
<a name='L555'><b>static</b> <b>void</b>
<a name='L556'><a href='../R/7783.html' title='Multiple refered from 4 places.'>fill_number</a>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *buf, <b>const</b> NumberFieldWidths *spec,
<a name='L557'>            <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *digits, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_digits,
<a name='L558'>            <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *prefix, <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> fill_char,
<a name='L559'>            LocaleInfo *locale, <b>int</b> toupper)
<a name='L560'><font color='red'>{</font>
<a name='L561'>    <i><font color='green'>/* Used to keep track of digits, decimal, and remainder. */</font></i>
<a name='L562'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *p = digits;
<a name='L563'>
<a name='L564'><font color='darkred'>#ifndef</font> NDEBUG
<a name='L565'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> r;
<a name='L566'><font color='darkred'>#endif</font>
<a name='L567'>
<a name='L568'>    <b>if</b> (spec-&gt;n_lpadding) <font color='red'>{</font>
<a name='L569'>        <a href='../D/4986.html' title='Multiple defined in 2 places.'>STRINGLIB_FILL</a>(buf, fill_char, spec-&gt;n_lpadding);
<a name='L570'>        buf += spec-&gt;n_lpadding;
<a name='L571'>    <font color='red'>}</font>
<a name='L572'>    <b>if</b> (spec-&gt;n_sign == 1) <font color='red'>{</font>
<a name='L573'>        *buf++ = spec-&gt;sign;
<a name='L574'>    <font color='red'>}</font>
<a name='L575'>    <b>if</b> (spec-&gt;n_prefix) <font color='red'>{</font>
<a name='L576'>        <a href='../S/2664.html#L75' title='Defined at 75 in Modules/expat/xmlparse.c.'>memmove</a>(buf,
<a name='L577'>                <a href='../S/2664.html#L148' title='Defined at 148 in Modules/expat/xmlparse.c.'>prefix</a>,
<a name='L578'>                spec-&gt;n_prefix * <b>sizeof</b>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a>));
<a name='L579'>        <b>if</b> (<a href='../D/11820.html' title='Multiple defined in 2 places.'>toupper</a>) <font color='red'>{</font>
<a name='L580'>            <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> t;
<a name='L581'>            <b>for</b> (t = 0; t &lt; spec-&gt;n_prefix; ++t)
<a name='L582'>                buf[t] = <a href='../D/5009.html' title='Multiple defined in 2 places.'>STRINGLIB_TOUPPER</a>(buf[t]);
<a name='L583'>        <font color='red'>}</font>
<a name='L584'>        buf += spec-&gt;n_prefix;
<a name='L585'>    <font color='red'>}</font>
<a name='L586'>    <b>if</b> (spec-&gt;n_spadding) <font color='red'>{</font>
<a name='L587'>        <a href='../D/4986.html' title='Multiple defined in 2 places.'>STRINGLIB_FILL</a>(buf, fill_char, spec-&gt;n_spadding);
<a name='L588'>        buf += spec-&gt;n_spadding;
<a name='L589'>    <font color='red'>}</font>
<a name='L590'>
<a name='L591'>    <i><font color='green'>/* Only for type 'c' special case, it has no digits. */</font></i>
<a name='L592'>    <b>if</b> (spec-&gt;n_digits != 0) <font color='red'>{</font>
<a name='L593'>        <i><font color='green'>/* Fill the digits with InsertThousandsGrouping. */</font></i>
<a name='L594'><font color='darkred'>#ifndef</font> NDEBUG
<a name='L595'>        r =
<a name='L596'><font color='darkred'>#endif</font>
<a name='L597'>            <a href='../D/4988.html' title='Multiple defined in 2 places.'>STRINGLIB_GROUPING</a>(buf, spec-&gt;n_grouped_digits, digits,
<a name='L598'>                               spec-&gt;n_digits, spec-&gt;n_min_width,
<a name='L599'>                               locale-&gt;grouping, locale-&gt;thousands_sep);
<a name='L600'><font color='darkred'>#ifndef</font> NDEBUG
<a name='L601'>        <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(r == spec-&gt;n_grouped_digits);
<a name='L602'><font color='darkred'>#endif</font>
<a name='L603'>        p += spec-&gt;n_digits;
<a name='L604'>    <font color='red'>}</font>
<a name='L605'>    <b>if</b> (<a href='../D/11820.html' title='Multiple defined in 2 places.'>toupper</a>) <font color='red'>{</font>
<a name='L606'>        <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> t;
<a name='L607'>        <b>for</b> (t = 0; t &lt; spec-&gt;n_grouped_digits; ++t)
<a name='L608'>            buf[t] = <a href='../D/5009.html' title='Multiple defined in 2 places.'>STRINGLIB_TOUPPER</a>(buf[t]);
<a name='L609'>    <font color='red'>}</font>
<a name='L610'>    buf += spec-&gt;n_grouped_digits;
<a name='L611'>
<a name='L612'>    <b>if</b> (spec-&gt;n_decimal) <font color='red'>{</font>
<a name='L613'>        <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> t;
<a name='L614'>        <b>for</b> (t = 0; t &lt; spec-&gt;n_decimal; ++t)
<a name='L615'>            buf[t] = locale-&gt;decimal_point[t];
<a name='L616'>        buf += spec-&gt;n_decimal;
<a name='L617'>        p += 1;
<a name='L618'>    <font color='red'>}</font>
<a name='L619'>
<a name='L620'>    <b>if</b> (spec-&gt;n_remainder) <font color='red'>{</font>
<a name='L621'>        <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a>(buf, p, spec-&gt;n_remainder * <b>sizeof</b>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a>));
<a name='L622'>        buf += spec-&gt;n_remainder;
<a name='L623'>        p += spec-&gt;n_remainder;
<a name='L624'>    <font color='red'>}</font>
<a name='L625'>
<a name='L626'>    <b>if</b> (spec-&gt;n_rpadding) <font color='red'>{</font>
<a name='L627'>        <a href='../D/4986.html' title='Multiple defined in 2 places.'>STRINGLIB_FILL</a>(buf, fill_char, spec-&gt;n_rpadding);
<a name='L628'>        buf += spec-&gt;n_rpadding;
<a name='L629'>    <font color='red'>}</font>
<a name='L630'><font color='red'>}</font>
<a name='L631'>
<a name='L632'><b>static</b> <b>char</b> no_grouping[1] = <font color='red'>{</font>CHAR_MAX<font color='red'>}</font>;
<a name='L633'>
<a name='L634'><i><font color='green'>/* Find the decimal point character(s?), thousands_separator(s?), and</font></i>
<a name='L635'><i><font color='green'>   grouping description, either for the current locale if type is</font></i>
<a name='L636'><i><font color='green'>   LT_CURRENT_LOCALE, a hard-coded locale if LT_DEFAULT_LOCALE, or</font></i>
<a name='L637'><i><font color='green'>   none if LT_NO_LOCALE. */</font></i>
<a name='L638'><b>static</b> <b>void</b>
<a name='L639'><a href='../R/8068.html' title='Multiple refered from 3 places.'>get_locale_info</a>(<b>int</b> type, LocaleInfo *locale_info)
<a name='L640'><font color='red'>{</font>
<a name='L641'>    <b>switch</b> (type) <font color='red'>{</font>
<a name='L642'>    <b>case</b> <a href='../S/2813.html#L364' title='Defined at 364 in Objects/stringlib/formatter.h.'>LT_CURRENT_LOCALE</a>: <font color='red'>{</font>
<a name='L643'>        <b>struct</b> lconv *locale_data = localeconv();
<a name='L644'>        locale_info-&gt;decimal_point = locale_data-&gt;decimal_point;
<a name='L645'>        locale_info-&gt;thousands_sep = locale_data-&gt;thousands_sep;
<a name='L646'>        locale_info-&gt;grouping = locale_data-&gt;grouping;
<a name='L647'>        <b>break</b>;
<a name='L648'>    <font color='red'>}</font>
<a name='L649'>    <b>case</b> <a href='../S/2813.html#L365' title='Defined at 365 in Objects/stringlib/formatter.h.'>LT_DEFAULT_LOCALE</a>:
<a name='L650'>        locale_info-&gt;decimal_point = ".";
<a name='L651'>        locale_info-&gt;thousands_sep = ",";
<a name='L652'>        locale_info-&gt;grouping = "\3"; <i><font color='green'>/* Group every 3 characters.  The</font></i>
<a name='L653'><i><font color='green'>                                         (implicit) trailing 0 means repeat</font></i>
<a name='L654'><i><font color='green'>                                         infinitely. */</font></i>
<a name='L655'>        <b>break</b>;
<a name='L656'>    <b>case</b> <a href='../S/2813.html#L366' title='Defined at 366 in Objects/stringlib/formatter.h.'>LT_NO_LOCALE</a>:
<a name='L657'>        locale_info-&gt;decimal_point = ".";
<a name='L658'>        locale_info-&gt;thousands_sep = "";
<a name='L659'>        locale_info-&gt;grouping = no_grouping;
<a name='L660'>        <b>break</b>;
<a name='L661'>    <b>default</b>:
<a name='L662'>        <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(0);
<a name='L663'>    <font color='red'>}</font>
<a name='L664'><font color='red'>}</font>
<a name='L665'>
<a name='L666'><font color='darkred'>#endif</font> <i><font color='green'>/* FORMAT_FLOAT || FORMAT_LONG || FORMAT_COMPLEX */</font></i>
<a name='L667'>
<a name='L668'><i><font color='green'>/************************************************************************/</font></i>
<a name='L669'><i><font color='green'>/*********** string formatting ******************************************/</font></i>
<a name='L670'><i><font color='green'>/************************************************************************/</font></i>
<a name='L671'>
<a name='L672'><b>static</b> <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L673'><a href='../S/2813.html#L1300' title='Refered from 1300 in Objects/stringlib/formatter.h.'>format_string_internal</a>(PyObject *value, <b>const</b> InternalFormatSpec *format)
<a name='L674'><font color='red'>{</font>
<a name='L675'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> lpad;
<a name='L676'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> rpad;
<a name='L677'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> total;
<a name='L678'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *p;
<a name='L679'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> len = <a href='../D/4994.html' title='Multiple defined in 3 places.'>STRINGLIB_LEN</a>(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>);
<a name='L680'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L681'>
<a name='L682'>    <i><font color='green'>/* sign is not allowed on strings */</font></i>
<a name='L683'>    <b>if</b> (format-&gt;sign != '\0') <font color='red'>{</font>
<a name='L684'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L685'>                        "Sign not allowed in string format specifier");
<a name='L686'>        <b>goto</b> done;
<a name='L687'>    <font color='red'>}</font>
<a name='L688'>
<a name='L689'>    <i><font color='green'>/* alternate is not allowed on strings */</font></i>
<a name='L690'>    <b>if</b> (format-&gt;alternate) <font color='red'>{</font>
<a name='L691'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L692'>                        "Alternate form (#) not allowed in string format "
<a name='L693'>                        "specifier");
<a name='L694'>        <b>goto</b> done;
<a name='L695'>    <font color='red'>}</font>
<a name='L696'>
<a name='L697'>    <i><font color='green'>/* '=' alignment not allowed on strings */</font></i>
<a name='L698'>    <b>if</b> (format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> == '=') <font color='red'>{</font>
<a name='L699'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L700'>                        "'=' alignment not allowed "
<a name='L701'>                        "in string format specifier");
<a name='L702'>        <b>goto</b> done;
<a name='L703'>    <font color='red'>}</font>
<a name='L704'>
<a name='L705'>    <i><font color='green'>/* if precision is specified, output no more that format.precision</font></i>
<a name='L706'><i><font color='green'>       characters */</font></i>
<a name='L707'>    <b>if</b> (format-&gt;precision &gt;= 0 &amp;&amp; len &gt;= format-&gt;precision) <font color='red'>{</font>
<a name='L708'>        len = format-&gt;precision;
<a name='L709'>    <font color='red'>}</font>
<a name='L710'>
<a name='L711'>    <a href='../S/2813.html#L308' title='Defined at 308 in Objects/stringlib/formatter.h.'>calc_padding</a>(len, format-&gt;width, format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>, &amp;lpad, &amp;rpad, &amp;total);
<a name='L712'>
<a name='L713'>    <i><font color='green'>/* allocate the resulting string */</font></i>
<a name='L714'>    <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../D/4997.html' title='Multiple defined in 3 places.'>STRINGLIB_NEW</a>(<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, total);
<a name='L715'>    <b>if</b> (<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L716'>        <b>goto</b> done;
<a name='L717'>
<a name='L718'>    <i><font color='green'>/* Write into that space. First the padding. */</font></i>
<a name='L719'>    p = <a href='../S/2813.html#L343' title='Defined at 343 in Objects/stringlib/formatter.h.'>fill_padding</a>(<a href='../D/5003.html' title='Multiple defined in 3 places.'>STRINGLIB_STR</a>(<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>), len,
<a name='L720'>                     format-&gt;fill_char=='\0'?' ':format-&gt;fill_char,
<a name='L721'>                     lpad, rpad);
<a name='L722'>
<a name='L723'>    <i><font color='green'>/* Then the source string. */</font></i>
<a name='L724'>    <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a>(p, <a href='../D/5003.html' title='Multiple defined in 3 places.'>STRINGLIB_STR</a>(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>), len * <b>sizeof</b>(<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a>));
<a name='L725'>
<a name='L726'>done:
<a name='L727'>    <b>return</b> <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>;
<a name='L728'><font color='red'>}</font>
<a name='L729'>
<a name='L730'>
<a name='L731'><i><font color='green'>/************************************************************************/</font></i>
<a name='L732'><i><font color='green'>/*********** long formatting ********************************************/</font></i>
<a name='L733'><i><font color='green'>/************************************************************************/</font></i>
<a name='L734'>
<a name='L735'><font color='darkred'>#if</font> <b>defined</b> <a href='../D/1292.html' title='Multiple defined in 2 places.'>FORMAT_LONG</a> || <b>defined</b> <a href='../S/2813.html#L1416' title='Defined at 1416 in Objects/stringlib/formatter.h.'>FORMAT_INT</a>
<a name='L736'><b>typedef</b> <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a>*
<a name='L737'>(*IntOrLongToString)(PyObject *value, <b>int</b> base);
<a name='L738'>
<a name='L739'><b>static</b> <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L740'><a href='../S/2813.html#L1347' title='Refered from 1347 in Objects/stringlib/formatter.h.'>format_int_or_long_internal</a>(PyObject *value, <b>const</b> InternalFormatSpec *format,
<a name='L741'>                            IntOrLongToString tostring)
<a name='L742'><font color='red'>{</font>
<a name='L743'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L744'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *tmp = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L745'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *pnumeric_chars;
<a name='L746'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> numeric_char;
<a name='L747'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> sign_char = '\0';
<a name='L748'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_digits;       <i><font color='green'>/* count of digits need from the computed</font></i>
<a name='L749'><i><font color='green'>                                  string */</font></i>
<a name='L750'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_remainder = 0; <i><font color='green'>/* Used only for 'c' formatting, which</font></i>
<a name='L751'><i><font color='green'>                                   produces non-digits */</font></i>
<a name='L752'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_prefix = 0;   <i><font color='green'>/* Count of prefix chars, (e.g., '0x') */</font></i>
<a name='L753'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_total;
<a name='L754'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *<a href='../S/2664.html#L148' title='Defined at 148 in Modules/expat/xmlparse.c.'>prefix</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L755'>    <a href='../S/2813.html#L399' title='Defined at 399 in Objects/stringlib/formatter.h.'>NumberFieldWidths</a> spec;
<a name='L756'>    <b>long</b> x;
<a name='L757'>
<a name='L758'>    <i><font color='green'>/* Locale settings, either from the actual locale or</font></i>
<a name='L759'><i><font color='green'>       from a hard-code pseudo-locale */</font></i>
<a name='L760'>    <a href='../S/2813.html#L375' title='Defined at 375 in Objects/stringlib/formatter.h.'>LocaleInfo</a> locale;
<a name='L761'>
<a name='L762'>    <i><font color='green'>/* no precision allowed on integers */</font></i>
<a name='L763'>    <b>if</b> (format-&gt;precision != -1) <font color='red'>{</font>
<a name='L764'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L765'>                        "Precision not allowed in integer format specifier");
<a name='L766'>        <b>goto</b> done;
<a name='L767'>    <font color='red'>}</font>
<a name='L768'>
<a name='L769'>    <i><font color='green'>/* special case for character formatting */</font></i>
<a name='L770'>    <b>if</b> (format-&gt;type == 'c') <font color='red'>{</font>
<a name='L771'>        <i><font color='green'>/* error to specify a sign */</font></i>
<a name='L772'>        <b>if</b> (format-&gt;sign != '\0') <font color='red'>{</font>
<a name='L773'>            <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L774'>                            "Sign not allowed with integer"
<a name='L775'>                            " format specifier 'c'");
<a name='L776'>            <b>goto</b> done;
<a name='L777'>        <font color='red'>}</font>
<a name='L778'>
<a name='L779'>        <i><font color='green'>/* taken from unicodeobject.c formatchar() */</font></i>
<a name='L780'>        <i><font color='green'>/* Integer input truncated to a character */</font></i>
<a name='L781'><i><font color='green'>/* XXX: won't work for int */</font></i>
<a name='L782'>        x = <a href='../S/2799.html#L416' title='Defined at 416 in Objects/longobject.c.'>PyLong_AsLong</a>(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>);
<a name='L783'>        <b>if</b> (x == -1 &amp;&amp; <a href='../D/3154.html' title='Multiple defined in 2 places.'>PyErr_Occurred</a>())
<a name='L784'>            <b>goto</b> done;
<a name='L785'><font color='darkred'>#ifdef</font> <a href='../S/587.html#L79' title='Defined at 79 in Include/unicodeobject.h.'>Py_UNICODE_WIDE</a>
<a name='L786'>        <b>if</b> (x &lt; 0 || x &gt; 0x10ffff) <font color='red'>{</font>
<a name='L787'>            <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_OverflowError,
<a name='L788'>                            "%c arg not in range(0x110000) "
<a name='L789'>                            "(wide Python build)");
<a name='L790'>            <b>goto</b> done;
<a name='L791'>        <font color='red'>}</font>
<a name='L792'><font color='darkred'>#else</font>
<a name='L793'>        <b>if</b> (x &lt; 0 || x &gt; 0xffff) <font color='red'>{</font>
<a name='L794'>            <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_OverflowError,
<a name='L795'>                            "%c arg not in range(0x10000) "
<a name='L796'>                            "(narrow Python build)");
<a name='L797'>            <b>goto</b> done;
<a name='L798'>        <font color='red'>}</font>
<a name='L799'><font color='darkred'>#endif</font>
<a name='L800'>        numeric_char = (<a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a>)x;
<a name='L801'>        pnumeric_chars = &amp;numeric_char;
<a name='L802'>        n_digits = 1;
<a name='L803'>
<a name='L804'>        <i><font color='green'>/* As a sort-of hack, we tell calc_number_widths that we only</font></i>
<a name='L805'><i><font color='green'>           have "remainder" characters. calc_number_widths thinks</font></i>
<a name='L806'><i><font color='green'>           these are characters that don't get formatted, only copied</font></i>
<a name='L807'><i><font color='green'>           into the output string. We do this for 'c' formatting,</font></i>
<a name='L808'><i><font color='green'>           because the characters are likely to be non-digits. */</font></i>
<a name='L809'>        n_remainder = 1;
<a name='L810'>    <font color='red'>}</font>
<a name='L811'>    <b>else</b> <font color='red'>{</font>
<a name='L812'>        <b>int</b> base;
<a name='L813'>        <b>int</b> leading_chars_to_skip = 0;  <i><font color='green'>/* Number of characters added by</font></i>
<a name='L814'><i><font color='green'>                                           PyNumber_ToBase that we want to</font></i>
<a name='L815'><i><font color='green'>                                           skip over. */</font></i>
<a name='L816'>
<a name='L817'>        <i><font color='green'>/* Compute the base and how many characters will be added by</font></i>
<a name='L818'><i><font color='green'>           PyNumber_ToBase */</font></i>
<a name='L819'>        <b>switch</b> (format-&gt;type) <font color='red'>{</font>
<a name='L820'>        <b>case</b> 'b':
<a name='L821'>            base = 2;
<a name='L822'>            leading_chars_to_skip = 2; <i><font color='green'>/* 0b */</font></i>
<a name='L823'>            <b>break</b>;
<a name='L824'>        <b>case</b> 'o':
<a name='L825'>            base = 8;
<a name='L826'>            leading_chars_to_skip = 2; <i><font color='green'>/* 0o */</font></i>
<a name='L827'>            <b>break</b>;
<a name='L828'>        <b>case</b> 'x':
<a name='L829'>        <b>case</b> 'X':
<a name='L830'>            base = 16;
<a name='L831'>            leading_chars_to_skip = 2; <i><font color='green'>/* 0x */</font></i>
<a name='L832'>            <b>break</b>;
<a name='L833'>        <b>default</b>:  <i><font color='green'>/* shouldn't be needed, but stops a compiler warning */</font></i>
<a name='L834'>        <b>case</b> 'd':
<a name='L835'>        <b>case</b> 'n':
<a name='L836'>            base = 10;
<a name='L837'>            <b>break</b>;
<a name='L838'>        <font color='red'>}</font>
<a name='L839'>
<a name='L840'>        <i><font color='green'>/* The number of prefix chars is the same as the leading</font></i>
<a name='L841'><i><font color='green'>           chars to skip */</font></i>
<a name='L842'>        <b>if</b> (format-&gt;alternate)
<a name='L843'>            n_prefix = leading_chars_to_skip;
<a name='L844'>
<a name='L845'>        <i><font color='green'>/* Do the hard part, converting to a string in a given base */</font></i>
<a name='L846'>        tmp = tostring(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>, base);
<a name='L847'>        <b>if</b> (tmp == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L848'>            <b>goto</b> done;
<a name='L849'>
<a name='L850'>        pnumeric_chars = <a href='../D/5003.html' title='Multiple defined in 3 places.'>STRINGLIB_STR</a>(tmp);
<a name='L851'>        n_digits = <a href='../D/4994.html' title='Multiple defined in 3 places.'>STRINGLIB_LEN</a>(tmp);
<a name='L852'>
<a name='L853'>        <a href='../S/2664.html#L148' title='Defined at 148 in Modules/expat/xmlparse.c.'>prefix</a> = pnumeric_chars;
<a name='L854'>
<a name='L855'>        <i><font color='green'>/* Remember not to modify what pnumeric_chars points to.  it</font></i>
<a name='L856'><i><font color='green'>           might be interned.  Only modify it after we copy it into a</font></i>
<a name='L857'><i><font color='green'>           newly allocated output buffer. */</font></i>
<a name='L858'>
<a name='L859'>        <i><font color='green'>/* Is a sign character present in the output?  If so, remember it</font></i>
<a name='L860'><i><font color='green'>           and skip it */</font></i>
<a name='L861'>        <b>if</b> (pnumeric_chars[0] == '-') <font color='red'>{</font>
<a name='L862'>            sign_char = pnumeric_chars[0];
<a name='L863'>            ++<a href='../S/2664.html#L148' title='Defined at 148 in Modules/expat/xmlparse.c.'>prefix</a>;
<a name='L864'>            ++leading_chars_to_skip;
<a name='L865'>        <font color='red'>}</font>
<a name='L866'>
<a name='L867'>        <i><font color='green'>/* Skip over the leading chars (0x, 0b, etc.) */</font></i>
<a name='L868'>        n_digits -= leading_chars_to_skip;
<a name='L869'>        pnumeric_chars += leading_chars_to_skip;
<a name='L870'>    <font color='red'>}</font>
<a name='L871'>
<a name='L872'>    <i><font color='green'>/* Determine the grouping, separator, and decimal point, if any. */</font></i>
<a name='L873'>    <a href='../S/2813.html#L639' title='Defined at 639 in Objects/stringlib/formatter.h.'>get_locale_info</a>(format-&gt;type == 'n' ? <a href='../S/2813.html#L364' title='Defined at 364 in Objects/stringlib/formatter.h.'>LT_CURRENT_LOCALE</a> :
<a name='L874'>                    (format-&gt;thousands_separators ?
<a name='L875'>                     <a href='../S/2813.html#L365' title='Defined at 365 in Objects/stringlib/formatter.h.'>LT_DEFAULT_LOCALE</a> :
<a name='L876'>                     <a href='../S/2813.html#L366' title='Defined at 366 in Objects/stringlib/formatter.h.'>LT_NO_LOCALE</a>),
<a name='L877'>                    &amp;locale);
<a name='L878'>
<a name='L879'>    <i><font color='green'>/* Calculate how much memory we'll need. */</font></i>
<a name='L880'>    n_total = <a href='../S/2813.html#L438' title='Defined at 438 in Objects/stringlib/formatter.h.'>calc_number_widths</a>(&amp;spec, n_prefix, sign_char, pnumeric_chars,
<a name='L881'>                       n_digits, n_remainder, 0, &amp;locale, format);
<a name='L882'>
<a name='L883'>    <i><font color='green'>/* Allocate the memory. */</font></i>
<a name='L884'>    <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../D/4997.html' title='Multiple defined in 3 places.'>STRINGLIB_NEW</a>(<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, n_total);
<a name='L885'>    <b>if</b> (!<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>)
<a name='L886'>        <b>goto</b> done;
<a name='L887'>
<a name='L888'>    <i><font color='green'>/* Populate the memory. */</font></i>
<a name='L889'>    <a href='../S/2813.html#L556' title='Defined at 556 in Objects/stringlib/formatter.h.'>fill_number</a>(<a href='../D/5003.html' title='Multiple defined in 3 places.'>STRINGLIB_STR</a>(<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>), &amp;spec, pnumeric_chars, n_digits,
<a name='L890'>                <a href='../S/2664.html#L148' title='Defined at 148 in Modules/expat/xmlparse.c.'>prefix</a>, format-&gt;fill_char == '\0' ? ' ' : format-&gt;fill_char,
<a name='L891'>                &amp;locale, format-&gt;type == 'X');
<a name='L892'>
<a name='L893'>done:
<a name='L894'>    <a href='../S/544.html#L767' title='Defined at 767 in Include/object.h.'>Py_XDECREF</a>(tmp);
<a name='L895'>    <b>return</b> <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>;
<a name='L896'><font color='red'>}</font>
<a name='L897'><font color='darkred'>#endif</font> <i><font color='green'>/* defined FORMAT_LONG || defined FORMAT_INT */</font></i>
<a name='L898'>
<a name='L899'><i><font color='green'>/************************************************************************/</font></i>
<a name='L900'><i><font color='green'>/*********** float formatting *******************************************/</font></i>
<a name='L901'><i><font color='green'>/************************************************************************/</font></i>
<a name='L902'>
<a name='L903'><font color='darkred'>#ifdef</font> <a href='../D/1290.html' title='Multiple defined in 2 places.'>FORMAT_FLOAT</a>
<a name='L904'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L905'><b>static</b> <b>void</b>
<a name='L906'><a href='../R/10589.html' title='Multiple refered from 3 places.'>strtounicode</a>(Py_UNICODE *buffer, <b>const</b> <b>char</b> *charbuffer, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> len)
<a name='L907'><font color='red'>{</font>
<a name='L908'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> i;
<a name='L909'>    <b>for</b> (i = 0; i &lt; len; ++i)
<a name='L910'>        <a href='../S/2664.html#L607' title='Defined at 607 in Modules/expat/xmlparse.c.'>buffer</a>[i] = (<a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a>)charbuffer[i];
<a name='L911'><font color='red'>}</font>
<a name='L912'><font color='darkred'>#endif</font>
<a name='L913'>
<a name='L914'><i><font color='green'>/* much of this is taken from unicodeobject.c */</font></i>
<a name='L915'><b>static</b> <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L916'><a href='../R/7889.html' title='Multiple refered from 2 places.'>format_float_internal</a>(PyObject *value,
<a name='L917'>                      <b>const</b> InternalFormatSpec *format)
<a name='L918'><font color='red'>{</font>
<a name='L919'>    <b>char</b> *buf = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;       <i><font color='green'>/* buffer returned from PyOS_double_to_string */</font></i>
<a name='L920'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_digits;
<a name='L921'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_remainder;
<a name='L922'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_total;
<a name='L923'>    <b>int</b> has_decimal;
<a name='L924'>    <b>double</b> val;
<a name='L925'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> precision = format-&gt;precision;
<a name='L926'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> default_precision = 6;
<a name='L927'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> type = format-&gt;type;
<a name='L928'>    <b>int</b> add_pct = 0;
<a name='L929'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *p;
<a name='L930'>    <a href='../S/2813.html#L399' title='Defined at 399 in Objects/stringlib/formatter.h.'>NumberFieldWidths</a> spec;
<a name='L931'>    <b>int</b> <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> = 0;
<a name='L932'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L933'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> sign_char = '\0';
<a name='L934'>    <b>int</b> float_type; <i><font color='green'>/* Used to see if we have a nan, inf, or regular float. */</font></i>
<a name='L935'>
<a name='L936'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L937'>    <a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a> *unicode_tmp = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L938'><font color='darkred'>#endif</font>
<a name='L939'>
<a name='L940'>    <i><font color='green'>/* Locale settings, either from the actual locale or</font></i>
<a name='L941'><i><font color='green'>       from a hard-code pseudo-locale */</font></i>
<a name='L942'>    <a href='../S/2813.html#L375' title='Defined at 375 in Objects/stringlib/formatter.h.'>LocaleInfo</a> locale;
<a name='L943'>
<a name='L944'>    <b>if</b> (format-&gt;alternate)
<a name='L945'>        <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= Py_DTSF_ALT;
<a name='L946'>
<a name='L947'>    <b>if</b> (type == '\0') <font color='red'>{</font>
<a name='L948'>        <i><font color='green'>/* Omitted type specifier.  Behaves in the same way as repr(x)</font></i>
<a name='L949'><i><font color='green'>           and str(x) if no precision is given, else like 'g', but with</font></i>
<a name='L950'><i><font color='green'>           at least one digit after the decimal point. */</font></i>
<a name='L951'>        <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= Py_DTSF_ADD_DOT_0;
<a name='L952'>        type = 'r';
<a name='L953'>        default_precision = 0;
<a name='L954'>    <font color='red'>}</font>
<a name='L955'>
<a name='L956'>    <b>if</b> (type == 'n')
<a name='L957'>        <i><font color='green'>/* 'n' is the same as 'g', except for the locale used to</font></i>
<a name='L958'><i><font color='green'>           format the result. We take care of that later. */</font></i>
<a name='L959'>        type = 'g';
<a name='L960'>
<a name='L961'>    val = <a href='../S/2791.html#L244' title='Defined at 244 in Objects/floatobject.c.'>PyFloat_AsDouble</a>(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>);
<a name='L962'>    <b>if</b> (val == -1.0 &amp;&amp; <a href='../D/3154.html' title='Multiple defined in 2 places.'>PyErr_Occurred</a>())
<a name='L963'>        <b>goto</b> done;
<a name='L964'>
<a name='L965'>    <b>if</b> (type == '%') <font color='red'>{</font>
<a name='L966'>        type = 'f';
<a name='L967'>        val *= 100;
<a name='L968'>        add_pct = 1;
<a name='L969'>    <font color='red'>}</font>
<a name='L970'>
<a name='L971'>    <b>if</b> (precision &lt; 0)
<a name='L972'>        precision = default_precision;
<a name='L973'>    <b>else</b> <b>if</b> (type == 'r')
<a name='L974'>        type = 'g';
<a name='L975'>
<a name='L976'>    <i><font color='green'>/* Cast "type", because if we're in unicode we need to pass a</font></i>
<a name='L977'><i><font color='green'>       8-bit char. This is safe, because we've restricted what "type"</font></i>
<a name='L978'><i><font color='green'>       can be. */</font></i>
<a name='L979'>    buf = PyOS_double_to_string(val, (<b>char</b>)type, precision, <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a>,
<a name='L980'>                                &amp;float_type);
<a name='L981'>    <b>if</b> (buf == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L982'>        <b>goto</b> done;
<a name='L983'>    n_digits = strlen(buf);
<a name='L984'>
<a name='L985'>    <b>if</b> (add_pct) <font color='red'>{</font>
<a name='L986'>        <i><font color='green'>/* We know that buf has a trailing zero (since we just called</font></i>
<a name='L987'><i><font color='green'>           strlen() on it), and we don't use that fact any more. So we</font></i>
<a name='L988'><i><font color='green'>           can just write over the trailing zero. */</font></i>
<a name='L989'>        buf[n_digits] = '%';
<a name='L990'>        n_digits += 1;
<a name='L991'>    <font color='red'>}</font>
<a name='L992'>
<a name='L993'>    <i><font color='green'>/* Since there is no unicode version of PyOS_double_to_string,</font></i>
<a name='L994'><i><font color='green'>       just use the 8 bit version and then convert to unicode. */</font></i>
<a name='L995'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L996'>    unicode_tmp = (<a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a>*)<a href='../S/2803.html#L1769' title='Defined at 1769 in Objects/object.c.'>PyMem_Malloc</a>((n_digits)*<b>sizeof</b>(<a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a>));
<a name='L997'>    <b>if</b> (unicode_tmp == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L998'>        <a href='../S/3106.html#L334' title='Defined at 334 in Python/errors.c.'>PyErr_NoMemory</a>();
<a name='L999'>        <b>goto</b> done;
<a name='L1000'>    <font color='red'>}</font>
<a name='L1001'>    <a href='../S/2813.html#L906' title='Defined at 906 in Objects/stringlib/formatter.h.'>strtounicode</a>(unicode_tmp, buf, n_digits);
<a name='L1002'>    p = unicode_tmp;
<a name='L1003'><font color='darkred'>#else</font>
<a name='L1004'>    p = buf;
<a name='L1005'><font color='darkred'>#endif</font>
<a name='L1006'>
<a name='L1007'>    <i><font color='green'>/* Is a sign character present in the output?  If so, remember it</font></i>
<a name='L1008'><i><font color='green'>       and skip it */</font></i>
<a name='L1009'>    <b>if</b> (*p == '-') <font color='red'>{</font>
<a name='L1010'>        sign_char = *p;
<a name='L1011'>        ++p;
<a name='L1012'>        --n_digits;
<a name='L1013'>    <font color='red'>}</font>
<a name='L1014'>
<a name='L1015'>    <i><font color='green'>/* Determine if we have any "remainder" (after the digits, might include</font></i>
<a name='L1016'><i><font color='green'>       decimal or exponent or both (or neither)) */</font></i>
<a name='L1017'>    <a href='../S/2813.html#L413' title='Defined at 413 in Objects/stringlib/formatter.h.'>parse_number</a>(p, n_digits, &amp;n_remainder, &amp;has_decimal);
<a name='L1018'>
<a name='L1019'>    <i><font color='green'>/* Determine the grouping, separator, and decimal point, if any. */</font></i>
<a name='L1020'>    <a href='../S/2813.html#L639' title='Defined at 639 in Objects/stringlib/formatter.h.'>get_locale_info</a>(format-&gt;type == 'n' ? <a href='../S/2813.html#L364' title='Defined at 364 in Objects/stringlib/formatter.h.'>LT_CURRENT_LOCALE</a> :
<a name='L1021'>                    (format-&gt;thousands_separators ?
<a name='L1022'>                     <a href='../S/2813.html#L365' title='Defined at 365 in Objects/stringlib/formatter.h.'>LT_DEFAULT_LOCALE</a> :
<a name='L1023'>                     <a href='../S/2813.html#L366' title='Defined at 366 in Objects/stringlib/formatter.h.'>LT_NO_LOCALE</a>),
<a name='L1024'>                    &amp;locale);
<a name='L1025'>
<a name='L1026'>    <i><font color='green'>/* Calculate how much memory we'll need. */</font></i>
<a name='L1027'>    n_total = <a href='../S/2813.html#L438' title='Defined at 438 in Objects/stringlib/formatter.h.'>calc_number_widths</a>(&amp;spec, 0, sign_char, p, n_digits,
<a name='L1028'>                                 n_remainder, has_decimal, &amp;locale, format);
<a name='L1029'>
<a name='L1030'>    <i><font color='green'>/* Allocate the memory. */</font></i>
<a name='L1031'>    <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../D/4997.html' title='Multiple defined in 3 places.'>STRINGLIB_NEW</a>(<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, n_total);
<a name='L1032'>    <b>if</b> (<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L1033'>        <b>goto</b> done;
<a name='L1034'>
<a name='L1035'>    <i><font color='green'>/* Populate the memory. */</font></i>
<a name='L1036'>    <a href='../S/2813.html#L556' title='Defined at 556 in Objects/stringlib/formatter.h.'>fill_number</a>(<a href='../D/5003.html' title='Multiple defined in 3 places.'>STRINGLIB_STR</a>(<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>), &amp;spec, p, n_digits, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>,
<a name='L1037'>                format-&gt;fill_char == '\0' ? ' ' : format-&gt;fill_char, &amp;locale,
<a name='L1038'>                0);
<a name='L1039'>
<a name='L1040'>done:
<a name='L1041'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(buf);
<a name='L1042'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L1043'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(unicode_tmp);
<a name='L1044'><font color='darkred'>#endif</font>
<a name='L1045'>    <b>return</b> <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>;
<a name='L1046'><font color='red'>}</font>
<a name='L1047'><font color='darkred'>#endif</font> <i><font color='green'>/* FORMAT_FLOAT */</font></i>
<a name='L1048'>
<a name='L1049'><i><font color='green'>/************************************************************************/</font></i>
<a name='L1050'><i><font color='green'>/*********** complex formatting *****************************************/</font></i>
<a name='L1051'><i><font color='green'>/************************************************************************/</font></i>
<a name='L1052'>
<a name='L1053'><font color='darkred'>#ifdef</font> <a href='../D/1289.html' title='Multiple defined in 2 places.'>FORMAT_COMPLEX</a>
<a name='L1054'>
<a name='L1055'><b>static</b> <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L1056'><a href='../S/2813.html#L1506' title='Refered from 1506 in Objects/stringlib/formatter.h.'>format_complex_internal</a>(PyObject *value,
<a name='L1057'>                        <b>const</b> InternalFormatSpec *format)
<a name='L1058'><font color='red'>{</font>
<a name='L1059'>    <b>double</b> re;
<a name='L1060'>    <b>double</b> im;
<a name='L1061'>    <b>char</b> *re_buf = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;       <i><font color='green'>/* buffer returned from PyOS_double_to_string */</font></i>
<a name='L1062'>    <b>char</b> *im_buf = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;       <i><font color='green'>/* buffer returned from PyOS_double_to_string */</font></i>
<a name='L1063'>
<a name='L1064'>    <a href='../S/2813.html#L142' title='Defined at 142 in Objects/stringlib/formatter.h.'>InternalFormatSpec</a> tmp_format = *format;
<a name='L1065'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_re_digits;
<a name='L1066'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_im_digits;
<a name='L1067'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_re_remainder;
<a name='L1068'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_im_remainder;
<a name='L1069'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_re_total;
<a name='L1070'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> n_im_total;
<a name='L1071'>    <b>int</b> re_has_decimal;
<a name='L1072'>    <b>int</b> im_has_decimal;
<a name='L1073'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> precision = format-&gt;precision;
<a name='L1074'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> default_precision = 6;
<a name='L1075'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> type = format-&gt;type;
<a name='L1076'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *p_re;
<a name='L1077'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *p_im;
<a name='L1078'>    <a href='../S/2813.html#L399' title='Defined at 399 in Objects/stringlib/formatter.h.'>NumberFieldWidths</a> re_spec;
<a name='L1079'>    <a href='../S/2813.html#L399' title='Defined at 399 in Objects/stringlib/formatter.h.'>NumberFieldWidths</a> im_spec;
<a name='L1080'>    <b>int</b> <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> = 0;
<a name='L1081'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L1082'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *p;
<a name='L1083'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> re_sign_char = '\0';
<a name='L1084'>    <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> im_sign_char = '\0';
<a name='L1085'>    <b>int</b> re_float_type; <i><font color='green'>/* Used to see if we have a nan, inf, or regular float. */</font></i>
<a name='L1086'>    <b>int</b> im_float_type;
<a name='L1087'>    <b>int</b> add_parens = 0;
<a name='L1088'>    <b>int</b> skip_re = 0;
<a name='L1089'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> lpad;
<a name='L1090'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> rpad;
<a name='L1091'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> total;
<a name='L1092'>
<a name='L1093'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L1094'>    <a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a> *re_unicode_tmp = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L1095'>    <a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a> *im_unicode_tmp = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L1096'><font color='darkred'>#endif</font>
<a name='L1097'>
<a name='L1098'>    <i><font color='green'>/* Locale settings, either from the actual locale or</font></i>
<a name='L1099'><i><font color='green'>       from a hard-code pseudo-locale */</font></i>
<a name='L1100'>    <a href='../S/2813.html#L375' title='Defined at 375 in Objects/stringlib/formatter.h.'>LocaleInfo</a> locale;
<a name='L1101'>
<a name='L1102'>    <i><font color='green'>/* Zero padding is not allowed. */</font></i>
<a name='L1103'>    <b>if</b> (format-&gt;fill_char == '0') <font color='red'>{</font>
<a name='L1104'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L1105'>                        "Zero padding is not allowed in complex format "
<a name='L1106'>                        "specifier");
<a name='L1107'>        <b>goto</b> done;
<a name='L1108'>    <font color='red'>}</font>
<a name='L1109'>
<a name='L1110'>    <i><font color='green'>/* Neither is '=' alignment . */</font></i>
<a name='L1111'>    <b>if</b> (format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> == '=') <font color='red'>{</font>
<a name='L1112'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L1113'>                        "'=' alignment flag is not allowed in complex format "
<a name='L1114'>                        "specifier");
<a name='L1115'>        <b>goto</b> done;
<a name='L1116'>    <font color='red'>}</font>
<a name='L1117'>
<a name='L1118'>    re = <a href='../S/2784.html#L244' title='Defined at 244 in Objects/complexobject.c.'>PyComplex_RealAsDouble</a>(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>);
<a name='L1119'>    <b>if</b> (re == -1.0 &amp;&amp; <a href='../D/3154.html' title='Multiple defined in 2 places.'>PyErr_Occurred</a>())
<a name='L1120'>        <b>goto</b> done;
<a name='L1121'>    im = <a href='../S/2784.html#L255' title='Defined at 255 in Objects/complexobject.c.'>PyComplex_ImagAsDouble</a>(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>);
<a name='L1122'>    <b>if</b> (im == -1.0 &amp;&amp; <a href='../D/3154.html' title='Multiple defined in 2 places.'>PyErr_Occurred</a>())
<a name='L1123'>        <b>goto</b> done;
<a name='L1124'>
<a name='L1125'>    <b>if</b> (format-&gt;alternate)
<a name='L1126'>        <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= Py_DTSF_ALT;
<a name='L1127'>
<a name='L1128'>    <b>if</b> (type == '\0') <font color='red'>{</font>
<a name='L1129'>        <i><font color='green'>/* Omitted type specifier. Should be like str(self). */</font></i>
<a name='L1130'>        type = 'r';
<a name='L1131'>        default_precision = 0;
<a name='L1132'>        <b>if</b> (re == 0.0 &amp;&amp; <a href='../D/7796.html' title='Multiple defined in 2 places.'>copysign</a>(1.0, re) == 1.0)
<a name='L1133'>            skip_re = 1;
<a name='L1134'>        <b>else</b>
<a name='L1135'>            add_parens = 1;
<a name='L1136'>    <font color='red'>}</font>
<a name='L1137'>
<a name='L1138'>    <b>if</b> (type == 'n')
<a name='L1139'>        <i><font color='green'>/* 'n' is the same as 'g', except for the locale used to</font></i>
<a name='L1140'><i><font color='green'>           format the result. We take care of that later. */</font></i>
<a name='L1141'>        type = 'g';
<a name='L1142'>
<a name='L1143'>    <b>if</b> (precision &lt; 0)
<a name='L1144'>        precision = default_precision;
<a name='L1145'>    <b>else</b> <b>if</b> (type == 'r')
<a name='L1146'>        type = 'g';
<a name='L1147'>
<a name='L1148'>    <i><font color='green'>/* Cast "type", because if we're in unicode we need to pass a</font></i>
<a name='L1149'><i><font color='green'>       8-bit char. This is safe, because we've restricted what "type"</font></i>
<a name='L1150'><i><font color='green'>       can be. */</font></i>
<a name='L1151'>    re_buf = PyOS_double_to_string(re, (<b>char</b>)type, precision, <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a>,
<a name='L1152'>                                   &amp;re_float_type);
<a name='L1153'>    <b>if</b> (re_buf == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L1154'>        <b>goto</b> done;
<a name='L1155'>    im_buf = PyOS_double_to_string(im, (<b>char</b>)type, precision, <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a>,
<a name='L1156'>                                   &amp;im_float_type);
<a name='L1157'>    <b>if</b> (im_buf == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L1158'>        <b>goto</b> done;
<a name='L1159'>
<a name='L1160'>    n_re_digits = strlen(re_buf);
<a name='L1161'>    n_im_digits = strlen(im_buf);
<a name='L1162'>
<a name='L1163'>    <i><font color='green'>/* Since there is no unicode version of PyOS_double_to_string,</font></i>
<a name='L1164'><i><font color='green'>       just use the 8 bit version and then convert to unicode. */</font></i>
<a name='L1165'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L1166'>    re_unicode_tmp = (<a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a>*)<a href='../S/2803.html#L1769' title='Defined at 1769 in Objects/object.c.'>PyMem_Malloc</a>((n_re_digits)*<b>sizeof</b>(<a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a>));
<a name='L1167'>    <b>if</b> (re_unicode_tmp == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L1168'>        <a href='../S/3106.html#L334' title='Defined at 334 in Python/errors.c.'>PyErr_NoMemory</a>();
<a name='L1169'>        <b>goto</b> done;
<a name='L1170'>    <font color='red'>}</font>
<a name='L1171'>    <a href='../S/2813.html#L906' title='Defined at 906 in Objects/stringlib/formatter.h.'>strtounicode</a>(re_unicode_tmp, re_buf, n_re_digits);
<a name='L1172'>    p_re = re_unicode_tmp;
<a name='L1173'>
<a name='L1174'>    im_unicode_tmp = (<a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a>*)<a href='../S/2803.html#L1769' title='Defined at 1769 in Objects/object.c.'>PyMem_Malloc</a>((n_im_digits)*<b>sizeof</b>(<a href='../S/587.html#L135' title='Defined at 135 in Include/unicodeobject.h.'>Py_UNICODE</a>));
<a name='L1175'>    <b>if</b> (im_unicode_tmp == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L1176'>        <a href='../S/3106.html#L334' title='Defined at 334 in Python/errors.c.'>PyErr_NoMemory</a>();
<a name='L1177'>        <b>goto</b> done;
<a name='L1178'>    <font color='red'>}</font>
<a name='L1179'>    <a href='../S/2813.html#L906' title='Defined at 906 in Objects/stringlib/formatter.h.'>strtounicode</a>(im_unicode_tmp, im_buf, n_im_digits);
<a name='L1180'>    p_im = im_unicode_tmp;
<a name='L1181'><font color='darkred'>#else</font>
<a name='L1182'>    p_re = re_buf;
<a name='L1183'>    p_im = im_buf;
<a name='L1184'><font color='darkred'>#endif</font>
<a name='L1185'>
<a name='L1186'>    <i><font color='green'>/* Is a sign character present in the output?  If so, remember it</font></i>
<a name='L1187'><i><font color='green'>       and skip it */</font></i>
<a name='L1188'>    <b>if</b> (*p_re == '-') <font color='red'>{</font>
<a name='L1189'>        re_sign_char = *p_re;
<a name='L1190'>        ++p_re;
<a name='L1191'>        --n_re_digits;
<a name='L1192'>    <font color='red'>}</font>
<a name='L1193'>    <b>if</b> (*p_im == '-') <font color='red'>{</font>
<a name='L1194'>        im_sign_char = *p_im;
<a name='L1195'>        ++p_im;
<a name='L1196'>        --n_im_digits;
<a name='L1197'>    <font color='red'>}</font>
<a name='L1198'>
<a name='L1199'>    <i><font color='green'>/* Determine if we have any "remainder" (after the digits, might include</font></i>
<a name='L1200'><i><font color='green'>       decimal or exponent or both (or neither)) */</font></i>
<a name='L1201'>    <a href='../S/2813.html#L413' title='Defined at 413 in Objects/stringlib/formatter.h.'>parse_number</a>(p_re, n_re_digits, &amp;n_re_remainder, &amp;re_has_decimal);
<a name='L1202'>    <a href='../S/2813.html#L413' title='Defined at 413 in Objects/stringlib/formatter.h.'>parse_number</a>(p_im, n_im_digits, &amp;n_im_remainder, &amp;im_has_decimal);
<a name='L1203'>
<a name='L1204'>    <i><font color='green'>/* Determine the grouping, separator, and decimal point, if any. */</font></i>
<a name='L1205'>    <a href='../S/2813.html#L639' title='Defined at 639 in Objects/stringlib/formatter.h.'>get_locale_info</a>(format-&gt;type == 'n' ? <a href='../S/2813.html#L364' title='Defined at 364 in Objects/stringlib/formatter.h.'>LT_CURRENT_LOCALE</a> :
<a name='L1206'>                    (format-&gt;thousands_separators ?
<a name='L1207'>                     <a href='../S/2813.html#L365' title='Defined at 365 in Objects/stringlib/formatter.h.'>LT_DEFAULT_LOCALE</a> :
<a name='L1208'>                     <a href='../S/2813.html#L366' title='Defined at 366 in Objects/stringlib/formatter.h.'>LT_NO_LOCALE</a>),
<a name='L1209'>                    &amp;locale);
<a name='L1210'>
<a name='L1211'>    <i><font color='green'>/* Turn off any padding. We'll do it later after we've composed</font></i>
<a name='L1212'><i><font color='green'>       the numbers without padding. */</font></i>
<a name='L1213'>    tmp_format.fill_char = '\0';
<a name='L1214'>    tmp_format.<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = '&lt;';
<a name='L1215'>    tmp_format.width = -1;
<a name='L1216'>
<a name='L1217'>    <i><font color='green'>/* Calculate how much memory we'll need. */</font></i>
<a name='L1218'>    n_re_total = <a href='../S/2813.html#L438' title='Defined at 438 in Objects/stringlib/formatter.h.'>calc_number_widths</a>(&amp;re_spec, 0, re_sign_char, p_re,
<a name='L1219'>                                    n_re_digits, n_re_remainder,
<a name='L1220'>                                    re_has_decimal, &amp;locale, &amp;tmp_format);
<a name='L1221'>
<a name='L1222'>    <i><font color='green'>/* Same formatting, but always include a sign, unless the real part is</font></i>
<a name='L1223'><i><font color='green'>     * going to be omitted, in which case we use whatever sign convention was</font></i>
<a name='L1224'><i><font color='green'>     * requested by the original format. */</font></i>
<a name='L1225'>    <b>if</b> (!skip_re)
<a name='L1226'>        tmp_format.sign = '+';
<a name='L1227'>    n_im_total = <a href='../S/2813.html#L438' title='Defined at 438 in Objects/stringlib/formatter.h.'>calc_number_widths</a>(&amp;im_spec, 0, im_sign_char, p_im,
<a name='L1228'>                                    n_im_digits, n_im_remainder,
<a name='L1229'>                                    im_has_decimal, &amp;locale, &amp;tmp_format);
<a name='L1230'>
<a name='L1231'>    <b>if</b> (skip_re)
<a name='L1232'>        n_re_total = 0;
<a name='L1233'>
<a name='L1234'>    <i><font color='green'>/* Add 1 for the 'j', and optionally 2 for parens. */</font></i>
<a name='L1235'>    <a href='../S/2813.html#L308' title='Defined at 308 in Objects/stringlib/formatter.h.'>calc_padding</a>(n_re_total + n_im_total + 1 + add_parens * 2,
<a name='L1236'>                 format-&gt;width, format-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>, &amp;lpad, &amp;rpad, &amp;total);
<a name='L1237'>
<a name='L1238'>    <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../D/4997.html' title='Multiple defined in 3 places.'>STRINGLIB_NEW</a>(<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, total);
<a name='L1239'>    <b>if</b> (<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L1240'>        <b>goto</b> done;
<a name='L1241'>
<a name='L1242'>    <i><font color='green'>/* Populate the memory. First, the padding. */</font></i>
<a name='L1243'>    p = <a href='../S/2813.html#L343' title='Defined at 343 in Objects/stringlib/formatter.h.'>fill_padding</a>(<a href='../D/5003.html' title='Multiple defined in 3 places.'>STRINGLIB_STR</a>(<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>),
<a name='L1244'>                     n_re_total + n_im_total + 1 + add_parens * 2,
<a name='L1245'>                     format-&gt;fill_char=='\0' ? ' ' : format-&gt;fill_char,
<a name='L1246'>                     lpad, rpad);
<a name='L1247'>
<a name='L1248'>    <b>if</b> (add_parens)
<a name='L1249'>        *p++ = '(';
<a name='L1250'>
<a name='L1251'>    <b>if</b> (!skip_re) <font color='red'>{</font>
<a name='L1252'>        <a href='../S/2813.html#L556' title='Defined at 556 in Objects/stringlib/formatter.h.'>fill_number</a>(p, &amp;re_spec, p_re, n_re_digits, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, 0, &amp;locale, 0);
<a name='L1253'>        p += n_re_total;
<a name='L1254'>    <font color='red'>}</font>
<a name='L1255'>    <a href='../S/2813.html#L556' title='Defined at 556 in Objects/stringlib/formatter.h.'>fill_number</a>(p, &amp;im_spec, p_im, n_im_digits, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, 0, &amp;locale, 0);
<a name='L1256'>    p += n_im_total;
<a name='L1257'>    *p++ = 'j';
<a name='L1258'>
<a name='L1259'>    <b>if</b> (add_parens)
<a name='L1260'>        *p++ = ')';
<a name='L1261'>
<a name='L1262'>done:
<a name='L1263'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(re_buf);
<a name='L1264'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(im_buf);
<a name='L1265'><font color='darkred'>#if</font> <a href='../D/4993.html' title='Multiple defined in 2 places.'>STRINGLIB_IS_UNICODE</a>
<a name='L1266'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(re_unicode_tmp);
<a name='L1267'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(im_unicode_tmp);
<a name='L1268'><font color='darkred'>#endif</font>
<a name='L1269'>    <b>return</b> <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>;
<a name='L1270'><font color='red'>}</font>
<a name='L1271'><font color='darkred'>#endif</font> <i><font color='green'>/* FORMAT_COMPLEX */</font></i>
<a name='L1272'>
<a name='L1273'><i><font color='green'>/************************************************************************/</font></i>
<a name='L1274'><i><font color='green'>/*********** built in formatters ****************************************/</font></i>
<a name='L1275'><i><font color='green'>/************************************************************************/</font></i>
<a name='L1276'><a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L1277'>FORMAT_STRING(PyObject *obj,
<a name='L1278'>              <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *format_spec,
<a name='L1279'>              <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> format_spec_len)
<a name='L1280'><font color='red'>{</font>
<a name='L1281'>    <a href='../S/2813.html#L142' title='Defined at 142 in Objects/stringlib/formatter.h.'>InternalFormatSpec</a> format;
<a name='L1282'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L1283'>
<a name='L1284'>    <i><font color='green'>/* check for the special case of zero length format spec, make</font></i>
<a name='L1285'><i><font color='green'>       it equivalent to str(obj) */</font></i>
<a name='L1286'>    <b>if</b> (format_spec_len == 0) <font color='red'>{</font>
<a name='L1287'>        <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../D/5008.html' title='Multiple defined in 3 places.'>STRINGLIB_TOSTR</a>(obj);
<a name='L1288'>        <b>goto</b> done;
<a name='L1289'>    <font color='red'>}</font>
<a name='L1290'>
<a name='L1291'>    <i><font color='green'>/* parse the format_spec */</font></i>
<a name='L1292'>    <b>if</b> (!<a href='../S/2813.html#L171' title='Defined at 171 in Objects/stringlib/formatter.h.'>parse_internal_render_format_spec</a>(format_spec, format_spec_len,
<a name='L1293'>                                           &amp;format, 's', '&lt;'))
<a name='L1294'>        <b>goto</b> done;
<a name='L1295'>
<a name='L1296'>    <i><font color='green'>/* type conversion? */</font></i>
<a name='L1297'>    <b>switch</b> (format.type) <font color='red'>{</font>
<a name='L1298'>    <b>case</b> 's':
<a name='L1299'>        <i><font color='green'>/* no type conversion needed, already a string.  do the formatting */</font></i>
<a name='L1300'>        <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2813.html#L673' title='Defined at 673 in Objects/stringlib/formatter.h.'>format_string_internal</a>(obj, &amp;format);
<a name='L1301'>        <b>break</b>;
<a name='L1302'>    <b>default</b>:
<a name='L1303'>        <i><font color='green'>/* unknown */</font></i>
<a name='L1304'>        <a href='../S/2813.html#L23' title='Defined at 23 in Objects/stringlib/formatter.h.'>unknown_presentation_type</a>(format.type, obj-&gt;ob_type-&gt;tp_name);
<a name='L1305'>        <b>goto</b> done;
<a name='L1306'>    <font color='red'>}</font>
<a name='L1307'>
<a name='L1308'>done:
<a name='L1309'>    <b>return</b> <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>;
<a name='L1310'><font color='red'>}</font>
<a name='L1311'>
<a name='L1312'><font color='darkred'>#if</font> <b>defined</b> <a href='../D/1292.html' title='Multiple defined in 2 places.'>FORMAT_LONG</a> || <b>defined</b> <a href='../S/2813.html#L1416' title='Defined at 1416 in Objects/stringlib/formatter.h.'>FORMAT_INT</a>
<a name='L1313'><b>static</b> <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a>*
<a name='L1314'><a href='../R/7891.html' title='Multiple refered from 2 places.'>format_int_or_long</a>(PyObject* obj,
<a name='L1315'>                   <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *format_spec,
<a name='L1316'>                   <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> format_spec_len,
<a name='L1317'>                   IntOrLongToString tostring)
<a name='L1318'><font color='red'>{</font>
<a name='L1319'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L1320'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *tmp = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L1321'>    <a href='../S/2813.html#L142' title='Defined at 142 in Objects/stringlib/formatter.h.'>InternalFormatSpec</a> format;
<a name='L1322'>
<a name='L1323'>    <i><font color='green'>/* check for the special case of zero length format spec, make</font></i>
<a name='L1324'><i><font color='green'>       it equivalent to str(obj) */</font></i>
<a name='L1325'>    <b>if</b> (format_spec_len == 0) <font color='red'>{</font>
<a name='L1326'>        <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../D/5008.html' title='Multiple defined in 3 places.'>STRINGLIB_TOSTR</a>(obj);
<a name='L1327'>        <b>goto</b> done;
<a name='L1328'>    <font color='red'>}</font>
<a name='L1329'>
<a name='L1330'>    <i><font color='green'>/* parse the format_spec */</font></i>
<a name='L1331'>    <b>if</b> (!<a href='../S/2813.html#L171' title='Defined at 171 in Objects/stringlib/formatter.h.'>parse_internal_render_format_spec</a>(format_spec,
<a name='L1332'>                                           format_spec_len,
<a name='L1333'>                                           &amp;format, 'd', '&gt;'))
<a name='L1334'>        <b>goto</b> done;
<a name='L1335'>
<a name='L1336'>    <i><font color='green'>/* type conversion? */</font></i>
<a name='L1337'>    <b>switch</b> (format.type) <font color='red'>{</font>
<a name='L1338'>    <b>case</b> 'b':
<a name='L1339'>    <b>case</b> 'c':
<a name='L1340'>    <b>case</b> 'd':
<a name='L1341'>    <b>case</b> 'o':
<a name='L1342'>    <b>case</b> 'x':
<a name='L1343'>    <b>case</b> 'X':
<a name='L1344'>    <b>case</b> 'n':
<a name='L1345'>        <i><font color='green'>/* no type conversion needed, already an int (or long).  do</font></i>
<a name='L1346'><i><font color='green'>           the formatting */</font></i>
<a name='L1347'>            <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2813.html#L740' title='Defined at 740 in Objects/stringlib/formatter.h.'>format_int_or_long_internal</a>(obj, &amp;format, tostring);
<a name='L1348'>        <b>break</b>;
<a name='L1349'>
<a name='L1350'>    <b>case</b> 'e':
<a name='L1351'>    <b>case</b> 'E':
<a name='L1352'>    <b>case</b> 'f':
<a name='L1353'>    <b>case</b> 'F':
<a name='L1354'>    <b>case</b> 'g':
<a name='L1355'>    <b>case</b> 'G':
<a name='L1356'>    <b>case</b> '%':
<a name='L1357'>        <i><font color='green'>/* convert to float */</font></i>
<a name='L1358'>        tmp = <a href='../S/2775.html#L1393' title='Defined at 1393 in Objects/abstract.c.'>PyNumber_Float</a>(obj);
<a name='L1359'>        <b>if</b> (tmp == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L1360'>            <b>goto</b> done;
<a name='L1361'>        <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2813.html#L916' title='Defined at 916 in Objects/stringlib/formatter.h.'>format_float_internal</a>(tmp, &amp;format);
<a name='L1362'>        <b>break</b>;
<a name='L1363'>
<a name='L1364'>    <b>default</b>:
<a name='L1365'>        <i><font color='green'>/* unknown */</font></i>
<a name='L1366'>        <a href='../S/2813.html#L23' title='Defined at 23 in Objects/stringlib/formatter.h.'>unknown_presentation_type</a>(format.type, obj-&gt;ob_type-&gt;tp_name);
<a name='L1367'>        <b>goto</b> done;
<a name='L1368'>    <font color='red'>}</font>
<a name='L1369'>
<a name='L1370'>done:
<a name='L1371'>    <a href='../S/544.html#L767' title='Defined at 767 in Include/object.h.'>Py_XDECREF</a>(tmp);
<a name='L1372'>    <b>return</b> <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>;
<a name='L1373'><font color='red'>}</font>
<a name='L1374'><font color='darkred'>#endif</font> <i><font color='green'>/* FORMAT_LONG || defined FORMAT_INT */</font></i>
<a name='L1375'>
<a name='L1376'><font color='darkred'>#ifdef</font> <a href='../D/1292.html' title='Multiple defined in 2 places.'>FORMAT_LONG</a>
<a name='L1377'><i><font color='green'>/* Need to define long_format as a function that will convert a long</font></i>
<a name='L1378'><i><font color='green'>   to a string.  In 3.0, _PyLong_Format has the correct signature.  In</font></i>
<a name='L1379'><i><font color='green'>   2.x, we need to fudge a few parameters */</font></i>
<a name='L1380'><font color='darkred'>#if</font> <a href='../S/549.html#L34' title='Defined at 34 in Include/patchlevel.h.'>PY_VERSION_HEX</a> &gt;= 0x03000000
<a name='L1381'><font color='darkred'>#define</font> <a href='../S/2813.html#L1400' title='Refered from 1400 in Objects/stringlib/formatter.h.'>long_format</a> <a href='../S/2799.html#L1660' title='Defined at 1660 in Objects/longobject.c.'>_PyLong_Format</a>
<a name='L1382'><font color='darkred'>#else</font>
<a name='L1383'><b>static</b> <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a>*
<a name='L1384'><a href='../S/2813.html#L1400' title='Refered from 1400 in Objects/stringlib/formatter.h.'>long_format</a>(PyObject* value, <b>int</b> base)
<a name='L1385'><font color='red'>{</font>
<a name='L1386'>    <i><font color='green'>/* Convert to base, don't add trailing 'L', and use the new octal</font></i>
<a name='L1387'><i><font color='green'>       format. We already know this is a long object */</font></i>
<a name='L1388'>    <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(PyLong_Check(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>));
<a name='L1389'>    <i><font color='green'>/* convert to base, don't add 'L', and use the new octal format */</font></i>
<a name='L1390'>    <b>return</b> <a href='../S/2799.html#L1660' title='Defined at 1660 in Objects/longobject.c.'>_PyLong_Format</a>(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>, base, 0, 1);
<a name='L1391'><font color='red'>}</font>
<a name='L1392'><font color='darkred'>#endif</font>
<a name='L1393'>
<a name='L1394'><a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L1395'><a href='../R/1154.html' title='Multiple refered from 4 places.'>FORMAT_LONG</a>(PyObject *obj,
<a name='L1396'>            <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *format_spec,
<a name='L1397'>            <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> format_spec_len)
<a name='L1398'><font color='red'>{</font>
<a name='L1399'>    <b>return</b> <a href='../S/2813.html#L1314' title='Defined at 1314 in Objects/stringlib/formatter.h.'>format_int_or_long</a>(obj, format_spec, format_spec_len,
<a name='L1400'>                              <a href='../D/9590.html' title='Multiple defined in 2 places.'>long_format</a>);
<a name='L1401'><font color='red'>}</font>
<a name='L1402'><font color='darkred'>#endif</font> <i><font color='green'>/* FORMAT_LONG */</font></i>
<a name='L1403'>
<a name='L1404'><font color='darkred'>#ifdef</font> <a href='../S/2813.html#L1416' title='Defined at 1416 in Objects/stringlib/formatter.h.'>FORMAT_INT</a>
<a name='L1405'><i><font color='green'>/* this is only used for 2.x, not 3.0 */</font></i>
<a name='L1406'><b>static</b> <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a>*
<a name='L1407'><a href='../S/2813.html#L1421' title='Refered from 1421 in Objects/stringlib/formatter.h.'>int_format</a>(PyObject* value, <b>int</b> base)
<a name='L1408'><font color='red'>{</font>
<a name='L1409'>    <i><font color='green'>/* Convert to base, and use the new octal format. We already</font></i>
<a name='L1410'><i><font color='green'>       know this is an int object */</font></i>
<a name='L1411'>    <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(PyInt_Check(<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>));
<a name='L1412'>    <b>return</b> _PyInt_Format((PyIntObject*)<a href='../S/2252.html#L27' title='Defined at 27 in Modules/_ctypes/ctypes.h.'>value</a>, base, 1);
<a name='L1413'><font color='red'>}</font>
<a name='L1414'>
<a name='L1415'><a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L1416'><a href='../R/1153.html' title='Multiple refered from 3 places.'>FORMAT_INT</a>(PyObject *obj,
<a name='L1417'>           <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *format_spec,
<a name='L1418'>           <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> format_spec_len)
<a name='L1419'><font color='red'>{</font>
<a name='L1420'>    <b>return</b> <a href='../S/2813.html#L1314' title='Defined at 1314 in Objects/stringlib/formatter.h.'>format_int_or_long</a>(obj, format_spec, format_spec_len,
<a name='L1421'>                              <a href='../S/2813.html#L1407' title='Defined at 1407 in Objects/stringlib/formatter.h.'>int_format</a>);
<a name='L1422'><font color='red'>}</font>
<a name='L1423'><font color='darkred'>#endif</font> <i><font color='green'>/* FORMAT_INT */</font></i>
<a name='L1424'>
<a name='L1425'><font color='darkred'>#ifdef</font> <a href='../D/1290.html' title='Multiple defined in 2 places.'>FORMAT_FLOAT</a>
<a name='L1426'><a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L1427'><a href='../R/1152.html' title='Multiple refered from 3 places.'>FORMAT_FLOAT</a>(PyObject *obj,
<a name='L1428'>             <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *format_spec,
<a name='L1429'>             <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> format_spec_len)
<a name='L1430'><font color='red'>{</font>
<a name='L1431'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L1432'>    <a href='../S/2813.html#L142' title='Defined at 142 in Objects/stringlib/formatter.h.'>InternalFormatSpec</a> format;
<a name='L1433'>
<a name='L1434'>    <i><font color='green'>/* check for the special case of zero length format spec, make</font></i>
<a name='L1435'><i><font color='green'>       it equivalent to str(obj) */</font></i>
<a name='L1436'>    <b>if</b> (format_spec_len == 0) <font color='red'>{</font>
<a name='L1437'>        <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../D/5008.html' title='Multiple defined in 3 places.'>STRINGLIB_TOSTR</a>(obj);
<a name='L1438'>        <b>goto</b> done;
<a name='L1439'>    <font color='red'>}</font>
<a name='L1440'>
<a name='L1441'>    <i><font color='green'>/* parse the format_spec */</font></i>
<a name='L1442'>    <b>if</b> (!<a href='../S/2813.html#L171' title='Defined at 171 in Objects/stringlib/formatter.h.'>parse_internal_render_format_spec</a>(format_spec,
<a name='L1443'>                                           format_spec_len,
<a name='L1444'>                                           &amp;format, '\0', '&gt;'))
<a name='L1445'>        <b>goto</b> done;
<a name='L1446'>
<a name='L1447'>    <i><font color='green'>/* type conversion? */</font></i>
<a name='L1448'>    <b>switch</b> (format.type) <font color='red'>{</font>
<a name='L1449'>    <b>case</b> '\0': <i><font color='green'>/* No format code: like 'g', but with at least one decimal. */</font></i>
<a name='L1450'>    <b>case</b> 'e':
<a name='L1451'>    <b>case</b> 'E':
<a name='L1452'>    <b>case</b> 'f':
<a name='L1453'>    <b>case</b> 'F':
<a name='L1454'>    <b>case</b> 'g':
<a name='L1455'>    <b>case</b> 'G':
<a name='L1456'>    <b>case</b> 'n':
<a name='L1457'>    <b>case</b> '%':
<a name='L1458'>        <i><font color='green'>/* no conversion, already a float.  do the formatting */</font></i>
<a name='L1459'>        <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2813.html#L916' title='Defined at 916 in Objects/stringlib/formatter.h.'>format_float_internal</a>(obj, &amp;format);
<a name='L1460'>        <b>break</b>;
<a name='L1461'>
<a name='L1462'>    <b>default</b>:
<a name='L1463'>        <i><font color='green'>/* unknown */</font></i>
<a name='L1464'>        <a href='../S/2813.html#L23' title='Defined at 23 in Objects/stringlib/formatter.h.'>unknown_presentation_type</a>(format.type, obj-&gt;ob_type-&gt;tp_name);
<a name='L1465'>        <b>goto</b> done;
<a name='L1466'>    <font color='red'>}</font>
<a name='L1467'>
<a name='L1468'>done:
<a name='L1469'>    <b>return</b> <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>;
<a name='L1470'><font color='red'>}</font>
<a name='L1471'><font color='darkred'>#endif</font> <i><font color='green'>/* FORMAT_FLOAT */</font></i>
<a name='L1472'>
<a name='L1473'><font color='darkred'>#ifdef</font> <a href='../D/1289.html' title='Multiple defined in 2 places.'>FORMAT_COMPLEX</a>
<a name='L1474'><a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *
<a name='L1475'><a href='../R/1151.html' title='Multiple refered from 3 places.'>FORMAT_COMPLEX</a>(PyObject *obj,
<a name='L1476'>               <a href='../D/4980.html' title='Multiple defined in 3 places.'>STRINGLIB_CHAR</a> *format_spec,
<a name='L1477'>               <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> format_spec_len)
<a name='L1478'><font color='red'>{</font>
<a name='L1479'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *<a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L1480'>    <a href='../S/2813.html#L142' title='Defined at 142 in Objects/stringlib/formatter.h.'>InternalFormatSpec</a> format;
<a name='L1481'>
<a name='L1482'>    <i><font color='green'>/* check for the special case of zero length format spec, make</font></i>
<a name='L1483'><i><font color='green'>       it equivalent to str(obj) */</font></i>
<a name='L1484'>    <b>if</b> (format_spec_len == 0) <font color='red'>{</font>
<a name='L1485'>        <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../D/5008.html' title='Multiple defined in 3 places.'>STRINGLIB_TOSTR</a>(obj);
<a name='L1486'>        <b>goto</b> done;
<a name='L1487'>    <font color='red'>}</font>
<a name='L1488'>
<a name='L1489'>    <i><font color='green'>/* parse the format_spec */</font></i>
<a name='L1490'>    <b>if</b> (!<a href='../S/2813.html#L171' title='Defined at 171 in Objects/stringlib/formatter.h.'>parse_internal_render_format_spec</a>(format_spec,
<a name='L1491'>                                           format_spec_len,
<a name='L1492'>                                           &amp;format, '\0', '&gt;'))
<a name='L1493'>        <b>goto</b> done;
<a name='L1494'>
<a name='L1495'>    <i><font color='green'>/* type conversion? */</font></i>
<a name='L1496'>    <b>switch</b> (format.type) <font color='red'>{</font>
<a name='L1497'>    <b>case</b> '\0': <i><font color='green'>/* No format code: like 'g', but with at least one decimal. */</font></i>
<a name='L1498'>    <b>case</b> 'e':
<a name='L1499'>    <b>case</b> 'E':
<a name='L1500'>    <b>case</b> 'f':
<a name='L1501'>    <b>case</b> 'F':
<a name='L1502'>    <b>case</b> 'g':
<a name='L1503'>    <b>case</b> 'G':
<a name='L1504'>    <b>case</b> 'n':
<a name='L1505'>        <i><font color='green'>/* no conversion, already a complex.  do the formatting */</font></i>
<a name='L1506'>        <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a> = <a href='../S/2813.html#L1056' title='Defined at 1056 in Objects/stringlib/formatter.h.'>format_complex_internal</a>(obj, &amp;format);
<a name='L1507'>        <b>break</b>;
<a name='L1508'>
<a name='L1509'>    <b>default</b>:
<a name='L1510'>        <i><font color='green'>/* unknown */</font></i>
<a name='L1511'>        <a href='../S/2813.html#L23' title='Defined at 23 in Objects/stringlib/formatter.h.'>unknown_presentation_type</a>(format.type, obj-&gt;ob_type-&gt;tp_name);
<a name='L1512'>        <b>goto</b> done;
<a name='L1513'>    <font color='red'>}</font>
<a name='L1514'>
<a name='L1515'>done:
<a name='L1516'>    <b>return</b> <a href='../S/2250.html#L579' title='Defined at 579 in Modules/_ctypes/callproc.c.'>result</a>;
<a name='L1517'><font color='red'>}</font>
<a name='L1518'><font color='darkred'>#endif</font> <i><font color='green'>/* FORMAT_COMPLEX */</font></i>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L23'>[^]</a><a href='#L1475'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
