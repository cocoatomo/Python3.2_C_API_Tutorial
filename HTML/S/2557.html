<html>
<head>
<title>Modules/_ctypes/stgdict.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.8.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/3353.html'>Modules</a>/<a href='../files/3354.html'>_ctypes</a>/stgdict.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L20'>[^]</a><a href='#L304'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L20' title='Defined at 20.'>PyCStgDict_init</a>
<li><a href='#L31' title='Defined at 31.'>PyCStgDict_clear</a>
<li><a href='#L42' title='Defined at 42.'>PyCStgDict_dealloc</a>
<li><a href='#L52' title='Defined at 52.'>PyCStgDict_clone</a>
<li><a href='#L149' title='Defined at 149.'>PyType_stgdict</a>
<li><a href='#L167' title='Defined at 167.'>PyObject_stgdict</a>
<li><a href='#L180' title='Defined at 180.'>MakeFields</a>
<li><a href='#L258' title='Defined at 258.'>MakeAnonFields</a>
<li><a href='#L304' title='Defined at 304.'>PyCStructUnionType_update_stgdict</a>
</ol>
<hr>
<pre>
<a name='L1'><font color='darkred'>#include</font> "<a href='570.html'>Python.h</a>"
<a name='L2'><font color='darkred'>#include</font> &lt;<a href='../I/325.html'>ffi.h</a>&gt;
<a name='L3'><font color='darkred'>#ifdef</font> <a href='../S/2906.html#L80' title='Defined at 80 in PC/pyconfig.h.'>MS_WIN32</a>
<a name='L4'><font color='darkred'>#include</font> &lt;windows.h&gt;
<a name='L5'><font color='darkred'>#include</font> &lt;malloc.h&gt;
<a name='L6'><font color='darkred'>#endif</font>
<a name='L7'><font color='darkred'>#include</font> "<a href='2252.html'>ctypes.h</a>"
<a name='L8'>
<a name='L9'><i><font color='green'>/******************************************************************/</font></i>
<a name='L10'><i><font color='green'>/*</font></i>
<a name='L11'><i><font color='green'>  StdDict - a dictionary subclass, containing additional C accessible fields</font></i>
<a name='L12'><i><font color='green'></font></i>
<a name='L13'><i><font color='green'>  XXX blabla more</font></i>
<a name='L14'><i><font color='green'>*/</font></i>
<a name='L15'>
<a name='L16'><i><font color='green'>/* Seems we need this, otherwise we get problems when calling</font></i>
<a name='L17'><i><font color='green'> * PyDict_SetItem() (ma_lookup is NULL)</font></i>
<a name='L18'><i><font color='green'> */</font></i>
<a name='L19'><b>static</b> <b>int</b>
<a name='L20'><a href='../S/2557.html#L141' title='Refered from 141 in Modules/_ctypes/stgdict.c.'>PyCStgDict_init</a>(StgDictObject *self, PyObject *args, PyObject *kwds)
<a name='L21'><font color='red'>{</font>
<a name='L22'>    <b>if</b> (PyDict_Type.tp_init((<a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *)self, <a href='../S/2858.html#L294' title='Defined at 294 in PC/bdist_wininst/install.c.'>args</a>, kwds) &lt; 0)
<a name='L23'>        <b>return</b> -1;
<a name='L24'>    self-&gt;format = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L25'>    self-&gt;ndim = 0;
<a name='L26'>    self-&gt;shape = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L27'>    <b>return</b> 0;
<a name='L28'><font color='red'>}</font>
<a name='L29'>
<a name='L30'><b>static</b> <b>int</b>
<a name='L31'><a href='../R/2618.html' title='Multiple refered from 2 places.'>PyCStgDict_clear</a>(StgDictObject *self)
<a name='L32'><font color='red'>{</font>
<a name='L33'>    <a href='../D/4095.html' title='Multiple defined in 2 places.'>Py_CLEAR</a>(self-&gt;proto);
<a name='L34'>    <a href='../D/4095.html' title='Multiple defined in 2 places.'>Py_CLEAR</a>(self-&gt;argtypes);
<a name='L35'>    <a href='../D/4095.html' title='Multiple defined in 2 places.'>Py_CLEAR</a>(self-&gt;converters);
<a name='L36'>    <a href='../D/4095.html' title='Multiple defined in 2 places.'>Py_CLEAR</a>(self-&gt;restype);
<a name='L37'>    <a href='../D/4095.html' title='Multiple defined in 2 places.'>Py_CLEAR</a>(self-&gt;checker);
<a name='L38'>    <b>return</b> 0;
<a name='L39'><font color='red'>}</font>
<a name='L40'>
<a name='L41'><b>static</b> <b>void</b>
<a name='L42'><a href='../S/2557.html#L110' title='Refered from 110 in Modules/_ctypes/stgdict.c.'>PyCStgDict_dealloc</a>(StgDictObject *self)
<a name='L43'><font color='red'>{</font>
<a name='L44'>    <a href='../S/2557.html#L31' title='Defined at 31 in Modules/_ctypes/stgdict.c.'>PyCStgDict_clear</a>(self);
<a name='L45'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(self-&gt;format);
<a name='L46'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(self-&gt;shape);
<a name='L47'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(self-&gt;ffi_type_pointer.elements);
<a name='L48'>    PyDict_Type.tp_dealloc((<a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *)self);
<a name='L49'><font color='red'>}</font>
<a name='L50'>
<a name='L51'><b>int</b>
<a name='L52'><a href='../R/2619.html' title='Multiple refered from 2 places.'>PyCStgDict_clone</a>(StgDictObject *dst, StgDictObject *src)
<a name='L53'><font color='red'>{</font>
<a name='L54'>    <b>char</b> *d, *s;
<a name='L55'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> size;
<a name='L56'>
<a name='L57'>    <a href='../S/2557.html#L31' title='Defined at 31 in Modules/_ctypes/stgdict.c.'>PyCStgDict_clear</a>(dst);
<a name='L58'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(dst-&gt;ffi_type_pointer.elements);
<a name='L59'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(dst-&gt;format);
<a name='L60'>    dst-&gt;format = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L61'>    <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(dst-&gt;shape);
<a name='L62'>    dst-&gt;shape = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L63'>    dst-&gt;ffi_type_pointer.elements = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L64'>
<a name='L65'>    d = (<b>char</b> *)dst;
<a name='L66'>    s = (<b>char</b> *)src;
<a name='L67'>    <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a>(d + <b>sizeof</b>(<a href='../S/517.html#L67' title='Defined at 67 in Include/dictobject.h.'>PyDictObject</a>),
<a name='L68'>           s + <b>sizeof</b>(<a href='../S/517.html#L67' title='Defined at 67 in Include/dictobject.h.'>PyDictObject</a>),
<a name='L69'>           <b>sizeof</b>(<a href='../S/2252.html#L219' title='Defined at 219 in Modules/_ctypes/ctypes.h.'>StgDictObject</a>) - <b>sizeof</b>(<a href='../S/517.html#L67' title='Defined at 67 in Include/dictobject.h.'>PyDictObject</a>));
<a name='L70'>
<a name='L71'>    <a href='../S/544.html#L766' title='Defined at 766 in Include/object.h.'>Py_XINCREF</a>(dst-&gt;proto);
<a name='L72'>    <a href='../S/544.html#L766' title='Defined at 766 in Include/object.h.'>Py_XINCREF</a>(dst-&gt;argtypes);
<a name='L73'>    <a href='../S/544.html#L766' title='Defined at 766 in Include/object.h.'>Py_XINCREF</a>(dst-&gt;converters);
<a name='L74'>    <a href='../S/544.html#L766' title='Defined at 766 in Include/object.h.'>Py_XINCREF</a>(dst-&gt;restype);
<a name='L75'>    <a href='../S/544.html#L766' title='Defined at 766 in Include/object.h.'>Py_XINCREF</a>(dst-&gt;checker);
<a name='L76'>
<a name='L77'>    <b>if</b> (src-&gt;format) <font color='red'>{</font>
<a name='L78'>        dst-&gt;format = <a href='../S/2803.html#L1769' title='Defined at 1769 in Objects/object.c.'>PyMem_Malloc</a>(strlen(src-&gt;format) + 1);
<a name='L79'>        <b>if</b> (dst-&gt;format == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L80'>            <b>return</b> -1;
<a name='L81'>        strcpy(dst-&gt;format, src-&gt;format);
<a name='L82'>    <font color='red'>}</font>
<a name='L83'>    <b>if</b> (src-&gt;shape) <font color='red'>{</font>
<a name='L84'>        dst-&gt;shape = <a href='../S/2803.html#L1769' title='Defined at 1769 in Objects/object.c.'>PyMem_Malloc</a>(<b>sizeof</b>(<a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a>) * src-&gt;ndim);
<a name='L85'>        <b>if</b> (dst-&gt;shape == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L86'>            <b>return</b> -1;
<a name='L87'>        <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a>(dst-&gt;shape, src-&gt;shape,
<a name='L88'>               <b>sizeof</b>(<a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a>) * src-&gt;ndim);
<a name='L89'>    <font color='red'>}</font>
<a name='L90'>
<a name='L91'>    <b>if</b> (src-&gt;ffi_type_pointer.elements == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L92'>        <b>return</b> 0;
<a name='L93'>    size = <b>sizeof</b>(<a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> *) * (src-&gt;length + 1);
<a name='L94'>    dst-&gt;ffi_type_pointer.elements = <a href='../S/2803.html#L1769' title='Defined at 1769 in Objects/object.c.'>PyMem_Malloc</a>(size);
<a name='L95'>    <b>if</b> (dst-&gt;ffi_type_pointer.elements == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L96'>        <a href='../S/3106.html#L334' title='Defined at 334 in Python/errors.c.'>PyErr_NoMemory</a>();
<a name='L97'>        <b>return</b> -1;
<a name='L98'>    <font color='red'>}</font>
<a name='L99'>    <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a>(dst-&gt;ffi_type_pointer.elements,
<a name='L100'>           src-&gt;ffi_type_pointer.elements,
<a name='L101'>           size);
<a name='L102'>    <b>return</b> 0;
<a name='L103'><font color='red'>}</font>
<a name='L104'>
<a name='L105'><a href='../D/3899.html' title='Multiple defined in 3 places.'>PyTypeObject</a> PyCStgDict_Type = <font color='red'>{</font>
<a name='L106'>    <a href='../D/4042.html' title='Multiple defined in 3 places.'>PyVarObject_HEAD_INIT</a>(<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, 0)
<a name='L107'>    "StgDict",
<a name='L108'>    <b>sizeof</b>(<a href='../S/2252.html#L219' title='Defined at 219 in Modules/_ctypes/ctypes.h.'>StgDictObject</a>),
<a name='L109'>    0,
<a name='L110'>    (<a href='../D/8095.html' title='Multiple defined in 2 places.'>destructor</a>)<a href='../S/2557.html#L42' title='Defined at 42 in Modules/_ctypes/stgdict.c.'>PyCStgDict_dealloc</a>,             <i><font color='green'>/* tp_dealloc */</font></i>
<a name='L111'>    0,                                          <i><font color='green'>/* tp_print */</font></i>
<a name='L112'>    0,                                          <i><font color='green'>/* tp_getattr */</font></i>
<a name='L113'>    0,                                          <i><font color='green'>/* tp_setattr */</font></i>
<a name='L114'>    0,                                          <i><font color='green'>/* tp_reserved */</font></i>
<a name='L115'>    0,                                          <i><font color='green'>/* tp_repr */</font></i>
<a name='L116'>    0,                                          <i><font color='green'>/* tp_as_number */</font></i>
<a name='L117'>    0,                                          <i><font color='green'>/* tp_as_sequence */</font></i>
<a name='L118'>    0,                                          <i><font color='green'>/* tp_as_mapping */</font></i>
<a name='L119'>    0,                                          <i><font color='green'>/* tp_hash */</font></i>
<a name='L120'>    0,                                          <i><font color='green'>/* tp_call */</font></i>
<a name='L121'>    0,                                          <i><font color='green'>/* tp_str */</font></i>
<a name='L122'>    0,                                          <i><font color='green'>/* tp_getattro */</font></i>
<a name='L123'>    0,                                          <i><font color='green'>/* tp_setattro */</font></i>
<a name='L124'>    0,                                          <i><font color='green'>/* tp_as_buffer */</font></i>
<a name='L125'>    Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE, <i><font color='green'>/* tp_flags */</font></i>
<a name='L126'>    0,                                          <i><font color='green'>/* tp_doc */</font></i>
<a name='L127'>    0,                                          <i><font color='green'>/* tp_traverse */</font></i>
<a name='L128'>    0,                                          <i><font color='green'>/* tp_clear */</font></i>
<a name='L129'>    0,                                          <i><font color='green'>/* tp_richcompare */</font></i>
<a name='L130'>    0,                                          <i><font color='green'>/* tp_weaklistoffset */</font></i>
<a name='L131'>    0,                                          <i><font color='green'>/* tp_iter */</font></i>
<a name='L132'>    0,                                          <i><font color='green'>/* tp_iternext */</font></i>
<a name='L133'>    0,                                          <i><font color='green'>/* tp_methods */</font></i>
<a name='L134'>    0,                                          <i><font color='green'>/* tp_members */</font></i>
<a name='L135'>    0,                                          <i><font color='green'>/* tp_getset */</font></i>
<a name='L136'>    0,                                          <i><font color='green'>/* tp_base */</font></i>
<a name='L137'>    0,                                          <i><font color='green'>/* tp_dict */</font></i>
<a name='L138'>    0,                                          <i><font color='green'>/* tp_descr_get */</font></i>
<a name='L139'>    0,                                          <i><font color='green'>/* tp_descr_set */</font></i>
<a name='L140'>    0,                                          <i><font color='green'>/* tp_dictoffset */</font></i>
<a name='L141'>    (initproc)<a href='../S/2557.html#L20' title='Defined at 20 in Modules/_ctypes/stgdict.c.'>PyCStgDict_init</a>,                          <i><font color='green'>/* tp_init */</font></i>
<a name='L142'>    0,                                          <i><font color='green'>/* tp_alloc */</font></i>
<a name='L143'>    0,                                          <i><font color='green'>/* tp_new */</font></i>
<a name='L144'>    0,                                          <i><font color='green'>/* tp_free */</font></i>
<a name='L145'><font color='red'>}</font>;
<a name='L146'>
<a name='L147'><i><font color='green'>/* May return NULL, but does not set an exception! */</font></i>
<a name='L148'><a href='../S/2252.html#L219' title='Defined at 219 in Modules/_ctypes/ctypes.h.'>StgDictObject</a> *
<a name='L149'><a href='../R/3512.html' title='Multiple refered from 50 places.'>PyType_stgdict</a>(PyObject *obj)
<a name='L150'><font color='red'>{</font>
<a name='L151'>    <a href='../D/3899.html' title='Multiple defined in 3 places.'>PyTypeObject</a> *type;
<a name='L152'>
<a name='L153'>    <b>if</b> (!PyType_Check(obj))
<a name='L154'>        <b>return</b> <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L155'>    type = (<a href='../D/3899.html' title='Multiple defined in 3 places.'>PyTypeObject</a> *)obj;
<a name='L156'>    <b>if</b> (!type-&gt;tp_dict || !<a href='../S/2252.html#L107' title='Defined at 107 in Modules/_ctypes/ctypes.h.'>PyCStgDict_CheckExact</a>(type-&gt;tp_dict))
<a name='L157'>        <b>return</b> <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L158'>    <b>return</b> (<a href='../S/2252.html#L219' title='Defined at 219 in Modules/_ctypes/ctypes.h.'>StgDictObject</a> *)type-&gt;tp_dict;
<a name='L159'><font color='red'>}</font>
<a name='L160'>
<a name='L161'><i><font color='green'>/* May return NULL, but does not set an exception! */</font></i>
<a name='L162'><i><font color='green'>/*</font></i>
<a name='L163'><i><font color='green'>  This function should be as fast as possible, so we don't call PyType_stgdict</font></i>
<a name='L164'><i><font color='green'>  above but inline the code, and avoid the PyType_Check().</font></i>
<a name='L165'><i><font color='green'>*/</font></i>
<a name='L166'><a href='../S/2252.html#L219' title='Defined at 219 in Modules/_ctypes/ctypes.h.'>StgDictObject</a> *
<a name='L167'><a href='../R/3303.html' title='Multiple refered from 30 places.'>PyObject_stgdict</a>(PyObject *self)
<a name='L168'><font color='red'>{</font>
<a name='L169'>    <a href='../D/3899.html' title='Multiple defined in 3 places.'>PyTypeObject</a> *type = self-&gt;ob_type;
<a name='L170'>    <b>if</b> (!type-&gt;tp_dict || !<a href='../S/2252.html#L107' title='Defined at 107 in Modules/_ctypes/ctypes.h.'>PyCStgDict_CheckExact</a>(type-&gt;tp_dict))
<a name='L171'>        <b>return</b> <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L172'>    <b>return</b> (<a href='../S/2252.html#L219' title='Defined at 219 in Modules/_ctypes/ctypes.h.'>StgDictObject</a> *)type-&gt;tp_dict;
<a name='L173'><font color='red'>}</font>
<a name='L174'>
<a name='L175'><i><font color='green'>/* descr is the descriptor for a field marked as anonymous.  Get all the</font></i>
<a name='L176'><i><font color='green'> _fields_ descriptors from descr-&gt;proto, create new descriptors with offset</font></i>
<a name='L177'><i><font color='green'> and index adjusted, and stuff them into type.</font></i>
<a name='L178'><i><font color='green'> */</font></i>
<a name='L179'><b>static</b> <b>int</b>
<a name='L180'><a href='../R/2007.html' title='Multiple refered from 2 places.'>MakeFields</a>(PyObject *type, CFieldObject *descr,
<a name='L181'>           <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> index, <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> offset)
<a name='L182'><font color='red'>{</font>
<a name='L183'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> i;
<a name='L184'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *fields;
<a name='L185'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *fieldlist;
<a name='L186'>
<a name='L187'>    fields = <a href='../S/2803.html#L779' title='Defined at 779 in Objects/object.c.'>PyObject_GetAttrString</a>(descr-&gt;proto, "_fields_");
<a name='L188'>    <b>if</b> (fields == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L189'>        <b>return</b> -1;
<a name='L190'>    fieldlist = <a href='../S/2775.html#L1836' title='Defined at 1836 in Objects/abstract.c.'>PySequence_Fast</a>(fields, "_fields_ must be a sequence");
<a name='L191'>    Py_DECREF(fields);
<a name='L192'>    <b>if</b> (fieldlist == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L193'>        <b>return</b> -1;
<a name='L194'>
<a name='L195'>    <b>for</b> (i = 0; i &lt; PySequence_Fast_GET_SIZE(fieldlist); ++i) <font color='red'>{</font>
<a name='L196'>        <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *pair = PySequence_Fast_GET_ITEM(fieldlist, i); <i><font color='green'>/* borrowed */</font></i>
<a name='L197'>        <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *fname, *ftype, *bits;
<a name='L198'>        <a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *fdescr;
<a name='L199'>        <a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *new_descr;
<a name='L200'>        <i><font color='green'>/* Convert to PyArg_UnpackTuple... */</font></i>
<a name='L201'>        <b>if</b> (!<a href='../D/2731.html' title='Multiple defined in 2 places.'>PyArg_ParseTuple</a>(pair, "OO|O", &amp;fname, &amp;ftype, &amp;bits)) <font color='red'>{</font>
<a name='L202'>            Py_DECREF(fieldlist);
<a name='L203'>            <b>return</b> -1;
<a name='L204'>        <font color='red'>}</font>
<a name='L205'>        fdescr = (<a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *)<a href='../S/2803.html#L822' title='Defined at 822 in Objects/object.c.'>PyObject_GetAttr</a>(descr-&gt;proto, fname);
<a name='L206'>        <b>if</b> (fdescr == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L207'>            Py_DECREF(fieldlist);
<a name='L208'>            <b>return</b> -1;
<a name='L209'>        <font color='red'>}</font>
<a name='L210'>        <b>if</b> (<a href='../D/4259.html' title='Multiple defined in 5 places.'>Py_TYPE</a>(fdescr) != &amp;PyCField_Type) <font color='red'>{</font>
<a name='L211'>            <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_TypeError, "unexpected type");
<a name='L212'>            Py_DECREF(fdescr);
<a name='L213'>            Py_DECREF(fieldlist);
<a name='L214'>            <b>return</b> -1;
<a name='L215'>        <font color='red'>}</font>
<a name='L216'>        <b>if</b> (fdescr-&gt;anonymous) <font color='red'>{</font>
<a name='L217'>            <b>int</b> rc = <a href='../S/2557.html#L180' title='Defined at 180 in Modules/_ctypes/stgdict.c.'>MakeFields</a>(type, fdescr,
<a name='L218'>                                index + fdescr-&gt;index,
<a name='L219'>                                offset + fdescr-&gt;offset);
<a name='L220'>            Py_DECREF(fdescr);
<a name='L221'>            <b>if</b> (rc == -1) <font color='red'>{</font>
<a name='L222'>                Py_DECREF(fieldlist);
<a name='L223'>                <b>return</b> -1;
<a name='L224'>            <font color='red'>}</font>
<a name='L225'>            <b>continue</b>;
<a name='L226'>        <font color='red'>}</font>
<a name='L227'>        new_descr = (<a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *)<a href='../S/2775.html#L2135' title='Defined at 2135 in Objects/abstract.c.'>PyObject_CallObject</a>((<a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *)&amp;PyCField_Type, <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>);
<a name='L228'>        <b>if</b> (new_descr == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L229'>            Py_DECREF(fdescr);
<a name='L230'>            Py_DECREF(fieldlist);
<a name='L231'>            <b>return</b> -1;
<a name='L232'>        <font color='red'>}</font>
<a name='L233'>        <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(<a href='../D/4259.html' title='Multiple defined in 5 places.'>Py_TYPE</a>(new_descr) == &amp;PyCField_Type);
<a name='L234'>        new_descr-&gt;size = fdescr-&gt;size;
<a name='L235'>        new_descr-&gt;offset = fdescr-&gt;offset + offset;
<a name='L236'>        new_descr-&gt;index = fdescr-&gt;index + index;
<a name='L237'>        new_descr-&gt;proto = fdescr-&gt;proto;
<a name='L238'>        <a href='../S/544.html#L766' title='Defined at 766 in Include/object.h.'>Py_XINCREF</a>(new_descr-&gt;proto);
<a name='L239'>        new_descr-&gt;getfunc = fdescr-&gt;getfunc;
<a name='L240'>        new_descr-&gt;setfunc = fdescr-&gt;setfunc;
<a name='L241'>
<a name='L242'>        Py_DECREF(fdescr);
<a name='L243'>
<a name='L244'>        <b>if</b> (-1 == <a href='../S/2803.html#L859' title='Defined at 859 in Objects/object.c.'>PyObject_SetAttr</a>(type, fname, (<a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *)new_descr)) <font color='red'>{</font>
<a name='L245'>            Py_DECREF(fieldlist);
<a name='L246'>            Py_DECREF(new_descr);
<a name='L247'>            <b>return</b> -1;
<a name='L248'>        <font color='red'>}</font>
<a name='L249'>        Py_DECREF(new_descr);
<a name='L250'>    <font color='red'>}</font>
<a name='L251'>    Py_DECREF(fieldlist);
<a name='L252'>    <b>return</b> 0;
<a name='L253'><font color='red'>}</font>
<a name='L254'>
<a name='L255'><i><font color='green'>/* Iterate over the names in the type's _anonymous_ attribute, if present,</font></i>
<a name='L256'><i><font color='green'> */</font></i>
<a name='L257'><b>static</b> <b>int</b>
<a name='L258'><a href='../S/2557.html#L562' title='Refered from 562 in Modules/_ctypes/stgdict.c.'>MakeAnonFields</a>(PyObject *type)
<a name='L259'><font color='red'>{</font>
<a name='L260'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *anon;
<a name='L261'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *anon_names;
<a name='L262'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> i;
<a name='L263'>
<a name='L264'>    anon = <a href='../S/2803.html#L779' title='Defined at 779 in Objects/object.c.'>PyObject_GetAttrString</a>(type, "_anonymous_");
<a name='L265'>    <b>if</b> (anon == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L266'>        <a href='../S/3106.html#L318' title='Defined at 318 in Python/errors.c.'>PyErr_Clear</a>();
<a name='L267'>        <b>return</b> 0;
<a name='L268'>    <font color='red'>}</font>
<a name='L269'>    anon_names = <a href='../S/2775.html#L1836' title='Defined at 1836 in Objects/abstract.c.'>PySequence_Fast</a>(anon, "_anonymous_ must be a sequence");
<a name='L270'>    Py_DECREF(anon);
<a name='L271'>    <b>if</b> (anon_names == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L272'>        <b>return</b> -1;
<a name='L273'>
<a name='L274'>    <b>for</b> (i = 0; i &lt; PySequence_Fast_GET_SIZE(anon_names); ++i) <font color='red'>{</font>
<a name='L275'>        <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *fname = PySequence_Fast_GET_ITEM(anon_names, i); <i><font color='green'>/* borrowed */</font></i>
<a name='L276'>        <a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *descr = (<a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *)<a href='../S/2803.html#L822' title='Defined at 822 in Objects/object.c.'>PyObject_GetAttr</a>(type, fname);
<a name='L277'>        <b>if</b> (descr == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L278'>            Py_DECREF(anon_names);
<a name='L279'>            <b>return</b> -1;
<a name='L280'>        <font color='red'>}</font>
<a name='L281'>        <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(<a href='../D/4259.html' title='Multiple defined in 5 places.'>Py_TYPE</a>(descr) == &amp;PyCField_Type);
<a name='L282'>        descr-&gt;anonymous = 1;
<a name='L283'>
<a name='L284'>        <i><font color='green'>/* descr is in the field descriptor. */</font></i>
<a name='L285'>        <b>if</b> (-1 == <a href='../S/2557.html#L180' title='Defined at 180 in Modules/_ctypes/stgdict.c.'>MakeFields</a>(type, (<a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *)descr,
<a name='L286'>                             ((<a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *)descr)-&gt;index,
<a name='L287'>                             ((<a href='../S/2252.html#L182' title='Defined at 182 in Modules/_ctypes/ctypes.h.'>CFieldObject</a> *)descr)-&gt;offset)) <font color='red'>{</font>
<a name='L288'>            Py_DECREF(descr);
<a name='L289'>            Py_DECREF(anon_names);
<a name='L290'>            <b>return</b> -1;
<a name='L291'>        <font color='red'>}</font>
<a name='L292'>        Py_DECREF(descr);
<a name='L293'>    <font color='red'>}</font>
<a name='L294'>
<a name='L295'>    Py_DECREF(anon_names);
<a name='L296'>    <b>return</b> 0;
<a name='L297'><font color='red'>}</font>
<a name='L298'>
<a name='L299'><i><font color='green'>/*</font></i>
<a name='L300'><i><font color='green'>  Retrive the (optional) _pack_ attribute from a type, the _fields_ attribute,</font></i>
<a name='L301'><i><font color='green'>  and create an StgDictObject.  Used for Structure and Union subclasses.</font></i>
<a name='L302'><i><font color='green'>*/</font></i>
<a name='L303'><b>int</b>
<a name='L304'><a href='../R/2624.html' title='Multiple refered from 3 places.'>PyCStructUnionType_update_stgdict</a>(PyObject *type, PyObject *fields, <b>int</b> isStruct)
<a name='L305'><font color='red'>{</font>
<a name='L306'>    <a href='../S/2252.html#L219' title='Defined at 219 in Modules/_ctypes/ctypes.h.'>StgDictObject</a> *stgdict, *basedict;
<a name='L307'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> len, offset, size, <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>, i;
<a name='L308'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> union_size, total_align;
<a name='L309'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> field_size = 0;
<a name='L310'>    <b>int</b> bitofs;
<a name='L311'>    <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *isPacked;
<a name='L312'>    <b>int</b> <a href='../S/2613.html#L1804' title='Defined at 1804 in Modules/_struct.c.'>pack</a> = 0;
<a name='L313'>    <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> ffi_ofs;
<a name='L314'>    <b>int</b> big_endian;
<a name='L315'>
<a name='L316'>    <i><font color='green'>/* HACK Alert: I cannot be bothered to fix ctypes.com, so there has to</font></i>
<a name='L317'><i><font color='green'>       be a way to use the old, broken sematics: _fields_ are not extended</font></i>
<a name='L318'><i><font color='green'>       but replaced in subclasses.</font></i>
<a name='L319'><i><font color='green'></font></i>
<a name='L320'><i><font color='green'>       XXX Remove this in ctypes 1.0!</font></i>
<a name='L321'><i><font color='green'>    */</font></i>
<a name='L322'>    <b>int</b> use_broken_old_ctypes_semantics;
<a name='L323'>
<a name='L324'>    <b>if</b> (fields == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L325'>        <b>return</b> 0;
<a name='L326'>
<a name='L327'><font color='darkred'>#ifdef</font> <a href='../D/5540.html' title='Multiple defined in 8 places.'>WORDS_BIGENDIAN</a>
<a name='L328'>    big_endian = <a href='../S/2803.html#L794' title='Defined at 794 in Objects/object.c.'>PyObject_HasAttrString</a>(type, "_swappedbytes_") ? 0 : 1;
<a name='L329'><font color='darkred'>#else</font>
<a name='L330'>    big_endian = <a href='../S/2803.html#L794' title='Defined at 794 in Objects/object.c.'>PyObject_HasAttrString</a>(type, "_swappedbytes_") ? 1 : 0;
<a name='L331'><font color='darkred'>#endif</font>
<a name='L332'>
<a name='L333'>    use_broken_old_ctypes_semantics = \
<a name='L334'>        <a href='../S/2803.html#L794' title='Defined at 794 in Objects/object.c.'>PyObject_HasAttrString</a>(type, "_use_broken_old_ctypes_structure_semantics_");
<a name='L335'>
<a name='L336'>    isPacked = <a href='../S/2803.html#L779' title='Defined at 779 in Objects/object.c.'>PyObject_GetAttrString</a>(type, "_pack_");
<a name='L337'>    <b>if</b> (isPacked) <font color='red'>{</font>
<a name='L338'>        <a href='../S/2613.html#L1804' title='Defined at 1804 in Modules/_struct.c.'>pack</a> = <a href='../S/2799.html#L416' title='Defined at 416 in Objects/longobject.c.'>PyLong_AsLong</a>(isPacked);
<a name='L339'>        <b>if</b> (<a href='../S/2613.html#L1804' title='Defined at 1804 in Modules/_struct.c.'>pack</a> &lt; 0 || <a href='../D/3154.html' title='Multiple defined in 2 places.'>PyErr_Occurred</a>()) <font color='red'>{</font>
<a name='L340'>            <a href='../S/544.html#L767' title='Defined at 767 in Include/object.h.'>Py_XDECREF</a>(isPacked);
<a name='L341'>            <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L342'>                            "_pack_ must be a non-negative integer");
<a name='L343'>            <b>return</b> -1;
<a name='L344'>        <font color='red'>}</font>
<a name='L345'>        Py_DECREF(isPacked);
<a name='L346'>    <font color='red'>}</font> <b>else</b>
<a name='L347'>        <a href='../S/3106.html#L318' title='Defined at 318 in Python/errors.c.'>PyErr_Clear</a>();
<a name='L348'>
<a name='L349'>    len = <a href='../D/3757.html' title='Multiple defined in 3 places.'>PySequence_Length</a>(fields);
<a name='L350'>    <b>if</b> (len == -1) <font color='red'>{</font>
<a name='L351'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_TypeError,
<a name='L352'>                        "'_fields_' must be a sequence of pairs");
<a name='L353'>        <b>return</b> -1;
<a name='L354'>    <font color='red'>}</font>
<a name='L355'>
<a name='L356'>    stgdict = <a href='../S/2557.html#L149' title='Defined at 149 in Modules/_ctypes/stgdict.c.'>PyType_stgdict</a>(type);
<a name='L357'>    <b>if</b> (!stgdict)
<a name='L358'>        <b>return</b> -1;
<a name='L359'>    <i><font color='green'>/* If this structure/union is already marked final we cannot assign</font></i>
<a name='L360'><i><font color='green'>       _fields_ anymore. */</font></i>
<a name='L361'>
<a name='L362'>    <b>if</b> (stgdict-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> &amp; <a href='../S/2252.html#L293' title='Defined at 293 in Modules/_ctypes/ctypes.h.'>DICTFLAG_FINAL</a>) <font color='red'>{</font><i><font color='green'>/* is final ? */</font></i>
<a name='L363'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_AttributeError,
<a name='L364'>                        "_fields_ is final");
<a name='L365'>        <b>return</b> -1;
<a name='L366'>    <font color='red'>}</font>
<a name='L367'>
<a name='L368'>    <b>if</b> (stgdict-&gt;format) <font color='red'>{</font>
<a name='L369'>        <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(stgdict-&gt;format);
<a name='L370'>        stgdict-&gt;format = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L371'>    <font color='red'>}</font>
<a name='L372'>
<a name='L373'>    <b>if</b> (stgdict-&gt;ffi_type_pointer.elements)
<a name='L374'>        <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(stgdict-&gt;ffi_type_pointer.elements);
<a name='L375'>
<a name='L376'>    basedict = <a href='../S/2557.html#L149' title='Defined at 149 in Modules/_ctypes/stgdict.c.'>PyType_stgdict</a>((<a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *)((<a href='../D/3899.html' title='Multiple defined in 3 places.'>PyTypeObject</a> *)type)-&gt;tp_base);
<a name='L377'>    <b>if</b> (basedict &amp;&amp; !use_broken_old_ctypes_semantics) <font color='red'>{</font>
<a name='L378'>        size = offset = basedict-&gt;size;
<a name='L379'>        <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = basedict-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>;
<a name='L380'>        union_size = 0;
<a name='L381'>        total_align = <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> ? <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> : 1;
<a name='L382'>        stgdict-&gt;ffi_type_pointer.type = <a href='../D/1202.html' title='Multiple defined in 3 places.'>FFI_TYPE_STRUCT</a>;
<a name='L383'>        stgdict-&gt;ffi_type_pointer.elements = <a href='../S/2803.html#L1769' title='Defined at 1769 in Objects/object.c.'>PyMem_Malloc</a>(<b>sizeof</b>(<a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> *) * (basedict-&gt;length + len + 1));
<a name='L384'>        <b>if</b> (stgdict-&gt;ffi_type_pointer.elements == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L385'>            <a href='../S/3106.html#L334' title='Defined at 334 in Python/errors.c.'>PyErr_NoMemory</a>();
<a name='L386'>            <b>return</b> -1;
<a name='L387'>        <font color='red'>}</font>
<a name='L388'>        memset(stgdict-&gt;ffi_type_pointer.elements, 0,
<a name='L389'>               <b>sizeof</b>(<a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> *) * (basedict-&gt;length + len + 1));
<a name='L390'>        <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a>(stgdict-&gt;ffi_type_pointer.elements,
<a name='L391'>               basedict-&gt;ffi_type_pointer.elements,
<a name='L392'>               <b>sizeof</b>(<a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> *) * (basedict-&gt;length));
<a name='L393'>        ffi_ofs = basedict-&gt;length;
<a name='L394'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L395'>        offset = 0;
<a name='L396'>        size = 0;
<a name='L397'>        <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = 0;
<a name='L398'>        union_size = 0;
<a name='L399'>        total_align = 1;
<a name='L400'>        stgdict-&gt;ffi_type_pointer.type = <a href='../D/1202.html' title='Multiple defined in 3 places.'>FFI_TYPE_STRUCT</a>;
<a name='L401'>        stgdict-&gt;ffi_type_pointer.elements = <a href='../S/2803.html#L1769' title='Defined at 1769 in Objects/object.c.'>PyMem_Malloc</a>(<b>sizeof</b>(<a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> *) * (len + 1));
<a name='L402'>        <b>if</b> (stgdict-&gt;ffi_type_pointer.elements == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L403'>            <a href='../S/3106.html#L334' title='Defined at 334 in Python/errors.c.'>PyErr_NoMemory</a>();
<a name='L404'>            <b>return</b> -1;
<a name='L405'>        <font color='red'>}</font>
<a name='L406'>        memset(stgdict-&gt;ffi_type_pointer.elements, 0,
<a name='L407'>               <b>sizeof</b>(<a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> *) * (len + 1));
<a name='L408'>        ffi_ofs = 0;
<a name='L409'>    <font color='red'>}</font>
<a name='L410'>
<a name='L411'>    <a href='../D/6814.html' title='Multiple defined in 2 places.'>assert</a>(stgdict-&gt;format == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>);
<a name='L412'>    <b>if</b> (isStruct &amp;&amp; !isPacked) <font color='red'>{</font>
<a name='L413'>        stgdict-&gt;format = <a href='../S/2246.html#L268' title='Defined at 268 in Modules/_ctypes/_ctypes.c.'>_ctypes_alloc_format_string</a>(<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, "T{");
<a name='L414'>    <font color='red'>}</font> <b>else</b> <font color='red'>{</font>
<a name='L415'>        <i><font color='green'>/* PEP3118 doesn't support union, or packed structures (well,</font></i>
<a name='L416'><i><font color='green'>           only standard packing, but we dont support the pep for</font></i>
<a name='L417'><i><font color='green'>           that). Use 'B' for bytes. */</font></i>
<a name='L418'>        stgdict-&gt;format = <a href='../S/2246.html#L268' title='Defined at 268 in Modules/_ctypes/_ctypes.c.'>_ctypes_alloc_format_string</a>(<a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, "B");
<a name='L419'>    <font color='red'>}</font>
<a name='L420'>
<a name='L421'><font color='darkred'>#define</font> realdict ((<a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *)&amp;stgdict-&gt;dict)
<a name='L422'>    <b>for</b> (i = 0; i &lt; len; ++i) <font color='red'>{</font>
<a name='L423'>        <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *name = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>, *desc = <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>;
<a name='L424'>        <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *pair = <a href='../S/2775.html#L1584' title='Defined at 1584 in Objects/abstract.c.'>PySequence_GetItem</a>(fields, i);
<a name='L425'>        <a href='../D/3593.html' title='Multiple defined in 2 places.'>PyObject</a> *prop;
<a name='L426'>        <a href='../S/2252.html#L219' title='Defined at 219 in Modules/_ctypes/ctypes.h.'>StgDictObject</a> *dict;
<a name='L427'>        <b>int</b> bitsize = 0;
<a name='L428'>
<a name='L429'>        <b>if</b> (!pair || !<a href='../D/2731.html' title='Multiple defined in 2 places.'>PyArg_ParseTuple</a>(pair, "OO|i", &amp;name, &amp;desc, &amp;bitsize)) <font color='red'>{</font>
<a name='L430'>            <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_AttributeError,
<a name='L431'>                            "'_fields_' must be a sequence of pairs");
<a name='L432'>            <a href='../S/544.html#L767' title='Defined at 767 in Include/object.h.'>Py_XDECREF</a>(pair);
<a name='L433'>            <b>return</b> -1;
<a name='L434'>        <font color='red'>}</font>
<a name='L435'>        dict = <a href='../S/2557.html#L149' title='Defined at 149 in Modules/_ctypes/stgdict.c.'>PyType_stgdict</a>(desc);
<a name='L436'>        <b>if</b> (dict == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L437'>            Py_DECREF(pair);
<a name='L438'>            <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_TypeError,
<a name='L439'>                         "second item in _fields_ tuple (index %zd) must be a C type",
<a name='L440'>                         i);
<a name='L441'>            <b>return</b> -1;
<a name='L442'>        <font color='red'>}</font>
<a name='L443'>        stgdict-&gt;ffi_type_pointer.elements[ffi_ofs + i] = &amp;dict-&gt;ffi_type_pointer;
<a name='L444'>        <b>if</b> (dict-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> &amp; (<a href='../S/2252.html#L290' title='Defined at 290 in Modules/_ctypes/ctypes.h.'>TYPEFLAG_ISPOINTER</a> | <a href='../S/2252.html#L291' title='Defined at 291 in Modules/_ctypes/ctypes.h.'>TYPEFLAG_HASPOINTER</a>))
<a name='L445'>            stgdict-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= <a href='../S/2252.html#L291' title='Defined at 291 in Modules/_ctypes/ctypes.h.'>TYPEFLAG_HASPOINTER</a>;
<a name='L446'>        dict-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= <a href='../S/2252.html#L293' title='Defined at 293 in Modules/_ctypes/ctypes.h.'>DICTFLAG_FINAL</a>; <i><font color='green'>/* mark field type final */</font></i>
<a name='L447'>        <b>if</b> (<a href='../S/2823.html#L112' title='Defined at 112 in Objects/tupleobject.c.'>PyTuple_Size</a>(pair) == 3) <font color='red'>{</font> <i><font color='green'>/* bits specified */</font></i>
<a name='L448'>            <b>switch</b>(dict-&gt;ffi_type_pointer.type) <font color='red'>{</font>
<a name='L449'>            <b>case</b> <a href='../D/1222.html' title='Multiple defined in 3 places.'>FFI_TYPE_UINT8</a>:
<a name='L450'>            <b>case</b> <a href='../D/1219.html' title='Multiple defined in 3 places.'>FFI_TYPE_UINT16</a>:
<a name='L451'>            <b>case</b> <a href='../D/1220.html' title='Multiple defined in 3 places.'>FFI_TYPE_UINT32</a>:
<a name='L452'>            <b>case</b> <a href='../D/1188.html' title='Multiple defined in 3 places.'>FFI_TYPE_SINT64</a>:
<a name='L453'>            <b>case</b> <a href='../D/1221.html' title='Multiple defined in 3 places.'>FFI_TYPE_UINT64</a>:
<a name='L454'>                <b>break</b>;
<a name='L455'>
<a name='L456'>            <b>case</b> <a href='../D/1189.html' title='Multiple defined in 3 places.'>FFI_TYPE_SINT8</a>:
<a name='L457'>            <b>case</b> <a href='../D/1186.html' title='Multiple defined in 3 places.'>FFI_TYPE_SINT16</a>:
<a name='L458'>            <b>case</b> <a href='../D/1187.html' title='Multiple defined in 3 places.'>FFI_TYPE_SINT32</a>:
<a name='L459'>                <b>if</b> (dict-&gt;getfunc != <a href='../S/2251.html#L1645' title='Defined at 1645 in Modules/_ctypes/cfield.c.'>_ctypes_get_fielddesc</a>("c")-&gt;getfunc
<a name='L460'><font color='darkred'>#ifdef</font> <a href='../S/2252.html#L348' title='Defined at 348 in Modules/_ctypes/ctypes.h.'>CTYPES_UNICODE</a>
<a name='L461'>                    &amp;&amp; dict-&gt;getfunc != <a href='../S/2251.html#L1645' title='Defined at 1645 in Modules/_ctypes/cfield.c.'>_ctypes_get_fielddesc</a>("u")-&gt;getfunc
<a name='L462'><font color='darkred'>#endif</font>
<a name='L463'>                    )
<a name='L464'>                    <b>break</b>;
<a name='L465'>                <i><font color='green'>/* else fall through */</font></i>
<a name='L466'>            <b>default</b>:
<a name='L467'>                <a href='../S/3106.html#L600' title='Defined at 600 in Python/errors.c.'>PyErr_Format</a>(PyExc_TypeError,
<a name='L468'>                             "bit fields not allowed for type %s",
<a name='L469'>                             ((<a href='../D/3899.html' title='Multiple defined in 3 places.'>PyTypeObject</a> *)desc)-&gt;tp_name);
<a name='L470'>                Py_DECREF(pair);
<a name='L471'>                <b>return</b> -1;
<a name='L472'>            <font color='red'>}</font>
<a name='L473'>            <b>if</b> (bitsize &lt;= 0 || bitsize &gt; dict-&gt;size * 8) <font color='red'>{</font>
<a name='L474'>                <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_ValueError,
<a name='L475'>                                "number of bits invalid for bit field");
<a name='L476'>                Py_DECREF(pair);
<a name='L477'>                <b>return</b> -1;
<a name='L478'>            <font color='red'>}</font>
<a name='L479'>        <font color='red'>}</font> <b>else</b>
<a name='L480'>            bitsize = 0;
<a name='L481'>        <b>if</b> (isStruct &amp;&amp; !isPacked) <font color='red'>{</font>
<a name='L482'>            <b>char</b> *fieldfmt = dict-&gt;format ? dict-&gt;format : "B";
<a name='L483'>            <b>char</b> *fieldname = <a href='../S/2828.html#L1919' title='Defined at 1919 in Objects/unicodeobject.c.'>_PyUnicode_AsString</a>(name);
<a name='L484'>            <b>char</b> *ptr;
<a name='L485'>            <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a> len = strlen(fieldname) + strlen(fieldfmt);
<a name='L486'>            <b>char</b> *buf = <a href='../D/6714.html' title='Multiple defined in 6 places.'>alloca</a>(len + 2 + 1);
<a name='L487'>
<a name='L488'>            sprintf(buf, "%s:%s:", fieldfmt, fieldname);
<a name='L489'>
<a name='L490'>            ptr = stgdict-&gt;format;
<a name='L491'>            stgdict-&gt;format = <a href='../S/2246.html#L268' title='Defined at 268 in Modules/_ctypes/_ctypes.c.'>_ctypes_alloc_format_string</a>(stgdict-&gt;format, buf);
<a name='L492'>            <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(ptr);
<a name='L493'>
<a name='L494'>            <b>if</b> (stgdict-&gt;format == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>) <font color='red'>{</font>
<a name='L495'>                Py_DECREF(pair);
<a name='L496'>                <b>return</b> -1;
<a name='L497'>            <font color='red'>}</font>
<a name='L498'>        <font color='red'>}</font>
<a name='L499'>        <b>if</b> (isStruct) <font color='red'>{</font>
<a name='L500'>            prop = <a href='../S/2251.html#L48' title='Defined at 48 in Modules/_ctypes/cfield.c.'>PyCField_FromDesc</a>(desc, i,
<a name='L501'>                                   &amp;field_size, bitsize, &amp;bitofs,
<a name='L502'>                                   &amp;size, &amp;offset, &amp;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>,
<a name='L503'>                                   <a href='../S/2613.html#L1804' title='Defined at 1804 in Modules/_struct.c.'>pack</a>, big_endian);
<a name='L504'>        <font color='red'>}</font> <b>else</b> <i><font color='green'>/* union */</font></i> <font color='red'>{</font>
<a name='L505'>            size = 0;
<a name='L506'>            offset = 0;
<a name='L507'>            <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = 0;
<a name='L508'>            prop = <a href='../S/2251.html#L48' title='Defined at 48 in Modules/_ctypes/cfield.c.'>PyCField_FromDesc</a>(desc, i,
<a name='L509'>                                   &amp;field_size, bitsize, &amp;bitofs,
<a name='L510'>                                   &amp;size, &amp;offset, &amp;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>,
<a name='L511'>                                   <a href='../S/2613.html#L1804' title='Defined at 1804 in Modules/_struct.c.'>pack</a>, big_endian);
<a name='L512'>            union_size = <a href='../S/2252.html#L6' title='Defined at 6 in Modules/_ctypes/ctypes.h.'>max</a>(size, union_size);
<a name='L513'>        <font color='red'>}</font>
<a name='L514'>        total_align = <a href='../S/2252.html#L6' title='Defined at 6 in Modules/_ctypes/ctypes.h.'>max</a>(<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>, total_align);
<a name='L515'>
<a name='L516'>        <b>if</b> (!prop) <font color='red'>{</font>
<a name='L517'>            Py_DECREF(pair);
<a name='L518'>            <b>return</b> -1;
<a name='L519'>        <font color='red'>}</font>
<a name='L520'>        <b>if</b> (-1 == <a href='../S/2803.html#L859' title='Defined at 859 in Objects/object.c.'>PyObject_SetAttr</a>(type, name, prop)) <font color='red'>{</font>
<a name='L521'>            Py_DECREF(prop);
<a name='L522'>            Py_DECREF(pair);
<a name='L523'>            <b>return</b> -1;
<a name='L524'>        <font color='red'>}</font>
<a name='L525'>        Py_DECREF(pair);
<a name='L526'>        Py_DECREF(prop);
<a name='L527'>    <font color='red'>}</font>
<a name='L528'><font color='darkred'>#undef</font> realdict
<a name='L529'>
<a name='L530'>    <b>if</b> (isStruct &amp;&amp; !isPacked) <font color='red'>{</font>
<a name='L531'>        <b>char</b> *ptr = stgdict-&gt;format;
<a name='L532'>        stgdict-&gt;format = <a href='../S/2246.html#L268' title='Defined at 268 in Modules/_ctypes/_ctypes.c.'>_ctypes_alloc_format_string</a>(stgdict-&gt;format, "}");
<a name='L533'>        <a href='../S/2803.html#L1781' title='Defined at 1781 in Objects/object.c.'>PyMem_Free</a>(ptr);
<a name='L534'>        <b>if</b> (stgdict-&gt;format == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>)
<a name='L535'>            <b>return</b> -1;
<a name='L536'>    <font color='red'>}</font>
<a name='L537'>
<a name='L538'>    <b>if</b> (!isStruct)
<a name='L539'>        size = union_size;
<a name='L540'>
<a name='L541'>    <i><font color='green'>/* Adjust the size according to the alignment requirements */</font></i>
<a name='L542'>    size = ((size + total_align - 1) / total_align) * total_align;
<a name='L543'>
<a name='L544'>    stgdict-&gt;ffi_type_pointer.alignment = <a href='../D/4230.html' title='Multiple defined in 2 places.'>Py_SAFE_DOWNCAST</a>(total_align,
<a name='L545'>                                                           <a href='../D/4364.html' title='Multiple defined in 6 places.'>Py_ssize_t</a>,
<a name='L546'>                                                           <b>unsigned</b> <b>short</b>);
<a name='L547'>    stgdict-&gt;ffi_type_pointer.size = size;
<a name='L548'>
<a name='L549'>    stgdict-&gt;size = size;
<a name='L550'>    stgdict-&gt;<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = total_align;
<a name='L551'>    stgdict-&gt;length = len;      <i><font color='green'>/* ADD ffi_ofs? */</font></i>
<a name='L552'>
<a name='L553'>    <i><font color='green'>/* We did check that this flag was NOT set above, it must not</font></i>
<a name='L554'><i><font color='green'>       have been set until now. */</font></i>
<a name='L555'>    <b>if</b> (stgdict-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> &amp; <a href='../S/2252.html#L293' title='Defined at 293 in Modules/_ctypes/ctypes.h.'>DICTFLAG_FINAL</a>) <font color='red'>{</font>
<a name='L556'>        <a href='../S/3106.html#L122' title='Defined at 122 in Python/errors.c.'>PyErr_SetString</a>(PyExc_AttributeError,
<a name='L557'>                        "Structure or union cannot contain itself");
<a name='L558'>        <b>return</b> -1;
<a name='L559'>    <font color='red'>}</font>
<a name='L560'>    stgdict-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= <a href='../S/2252.html#L293' title='Defined at 293 in Modules/_ctypes/ctypes.h.'>DICTFLAG_FINAL</a>;
<a name='L561'>
<a name='L562'>    <b>return</b> <a href='../S/2557.html#L258' title='Defined at 258 in Modules/_ctypes/stgdict.c.'>MakeAnonFields</a>(type);
<a name='L563'><font color='red'>}</font>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L20'>[^]</a><a href='#L304'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
