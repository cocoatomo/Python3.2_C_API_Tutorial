<html>
<head>
<title>Modules/_ctypes/libffi/src/x86/ffi64.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.8.1'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/3353.html'>Modules</a>/<a href='../files/3354.html'>_ctypes</a>/<a href='../files/3356.html'>libffi</a>/<a href='../files/3358.html'>src</a>/<a href='../files/3375.html'>x86</a>/ffi64.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L87'>[^]</a><a href='#L522'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L87' title='Defined at 87.'>merge_classes</a>
<li><a href='#L135' title='Defined at 135.'>classify_argument</a>
<li><a href='#L289' title='Defined at 289.'>examine_argument</a>
<li><a href='#L331' title='Defined at 331.'>ffi_prep_cif_machdep</a>
<li><a href='#L399' title='Defined at 399.'>ffi_call</a>
<li><a href='#L493' title='Defined at 493.'>ffi_prep_closure_loc</a>
<li><a href='#L522' title='Defined at 522.'>ffi_closure_unix64_inner</a>
</ol>
<hr>
<pre>
<a name='L1'><i><font color='green'>/* -----------------------------------------------------------------------</font></i>
<a name='L2'><i><font color='green'>   ffi64.c - Copyright (c) 2002, 2007  Bo Thorsen &lt;bo@suse.de&gt;</font></i>
<a name='L3'><i><font color='green'>             Copyright (c) 2008  Red Hat, Inc.</font></i>
<a name='L4'><i><font color='green'>   </font></i>
<a name='L5'><i><font color='green'>   x86-64 Foreign Function Interface </font></i>
<a name='L6'><i><font color='green'></font></i>
<a name='L7'><i><font color='green'>   Permission is hereby granted, free of charge, to any person obtaining</font></i>
<a name='L8'><i><font color='green'>   a copy of this software and associated documentation files (the</font></i>
<a name='L9'><i><font color='green'>   ``Software''), to deal in the Software without restriction, including</font></i>
<a name='L10'><i><font color='green'>   without limitation the rights to use, copy, modify, merge, publish,</font></i>
<a name='L11'><i><font color='green'>   distribute, sublicense, and/or sell copies of the Software, and to</font></i>
<a name='L12'><i><font color='green'>   permit persons to whom the Software is furnished to do so, subject to</font></i>
<a name='L13'><i><font color='green'>   the following conditions:</font></i>
<a name='L14'><i><font color='green'></font></i>
<a name='L15'><i><font color='green'>   The above copyright notice and this permission notice shall be included</font></i>
<a name='L16'><i><font color='green'>   in all copies or substantial portions of the Software.</font></i>
<a name='L17'><i><font color='green'></font></i>
<a name='L18'><i><font color='green'>   THE SOFTWARE IS PROVIDED ``AS IS'', WITHOUT WARRANTY OF ANY KIND,</font></i>
<a name='L19'><i><font color='green'>   EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</font></i>
<a name='L20'><i><font color='green'>   MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</font></i>
<a name='L21'><i><font color='green'>   NONINFRINGEMENT.  IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT</font></i>
<a name='L22'><i><font color='green'>   HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</font></i>
<a name='L23'><i><font color='green'>   WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</font></i>
<a name='L24'><i><font color='green'>   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</font></i>
<a name='L25'><i><font color='green'>   DEALINGS IN THE SOFTWARE.</font></i>
<a name='L26'><i><font color='green'>   ----------------------------------------------------------------------- */</font></i>
<a name='L27'>
<a name='L28'><font color='darkred'>#include</font> &lt;<a href='../I/325.html'>ffi.h</a>&gt;
<a name='L29'><font color='darkred'>#include</font> &lt;<a href='../I/119.html'>ffi_common.h</a>&gt;
<a name='L30'>
<a name='L31'><font color='darkred'>#include</font> &lt;stdlib.h&gt;
<a name='L32'><font color='darkred'>#include</font> &lt;stdarg.h&gt;
<a name='L33'>
<a name='L34'><font color='darkred'>#ifdef</font> __x86_64__
<a name='L35'>
<a name='L36'><font color='darkred'>#define</font> <a href='../R/1863.html' title='Multiple refered from 8 places.'>MAX_GPR_REGS</a> 6
<a name='L37'><font color='darkred'>#define</font> <a href='../R/1884.html' title='Multiple refered from 8 places.'>MAX_SSE_REGS</a> 8
<a name='L38'>
<a name='L39'><b>struct</b> <a href='../R/9997.html' title='Multiple refered from 15 places.'>register_args</a>
<a name='L40'><font color='red'>{</font>
<a name='L41'>  <i><font color='green'>/* Registers for argument passing.  */</font></i>
<a name='L42'>  <a href='../D/5331.html' title='Multiple defined in 7 places.'>UINT64</a> gpr[<a href='../D/2062.html' title='Multiple defined in 2 places.'>MAX_GPR_REGS</a>];
<a name='L43'>  __int128_t sse[<a href='../D/2083.html' title='Multiple defined in 2 places.'>MAX_SSE_REGS</a>];
<a name='L44'><font color='red'>}</font>;
<a name='L45'>
<a name='L46'><b>extern</b> <b>void</b> ffi_call_unix64 (<b>void</b> *args, <b>unsigned</b> <b>long</b> bytes, <b>unsigned</b> flags,
<a name='L47'>                             <b>void</b> *raddr, <b>void</b> (*fnaddr)(<b>void</b>), <b>unsigned</b> ssecount);
<a name='L48'>
<a name='L49'><i><font color='green'>/* All reference to register classes here is identical to the code in</font></i>
<a name='L50'><i><font color='green'>   gcc/config/i386/i386.c. Do *not* change one without the other.  */</font></i>
<a name='L51'>
<a name='L52'><i><font color='green'>/* Register class used for passing given 64bit part of the argument.</font></i>
<a name='L53'><i><font color='green'>   These represent classes as documented by the PS ABI, with the</font></i>
<a name='L54'><i><font color='green'>   exception of SSESF, SSEDF classes, that are basically SSE class,</font></i>
<a name='L55'><i><font color='green'>   just gcc will use SF or DFmode move instead of DImode to avoid</font></i>
<a name='L56'><i><font color='green'>   reformatting penalties.</font></i>
<a name='L57'><i><font color='green'></font></i>
<a name='L58'><i><font color='green'>   Similary we play games with INTEGERSI_CLASS to use cheaper SImode moves</font></i>
<a name='L59'><i><font color='green'>   whenever possible (upper half does contain padding).  */</font></i>
<a name='L60'><b>enum</b> <a href='../R/11483.html' title='Multiple refered from 12 places.'>x86_64_reg_class</a>
<a name='L61'>  <font color='red'>{</font>
<a name='L62'>    X86_64_NO_CLASS,
<a name='L63'>    X86_64_INTEGER_CLASS,
<a name='L64'>    X86_64_INTEGERSI_CLASS,
<a name='L65'>    X86_64_SSE_CLASS,
<a name='L66'>    X86_64_SSESF_CLASS,
<a name='L67'>    X86_64_SSEDF_CLASS,
<a name='L68'>    X86_64_SSEUP_CLASS,
<a name='L69'>    X86_64_X87_CLASS,
<a name='L70'>    X86_64_X87UP_CLASS,
<a name='L71'>    X86_64_COMPLEX_X87_CLASS,
<a name='L72'>    X86_64_MEMORY_CLASS
<a name='L73'>  <font color='red'>}</font>;
<a name='L74'>
<a name='L75'><font color='darkred'>#define</font> <a href='../R/1855.html' title='Multiple refered from 12 places.'>MAX_CLASSES</a> 4
<a name='L76'>
<a name='L77'><font color='darkred'>#define</font> <a href='../R/4323.html' title='Multiple refered from 15 places.'>SSE_CLASS_P</a>(X)  ((X) &gt;= X86_64_SSE_CLASS &amp;&amp; X &lt;= X86_64_SSEUP_CLASS)
<a name='L78'>
<a name='L79'><i><font color='green'>/* x86-64 register passing implementation.  See x86-64 ABI for details.  Goal</font></i>
<a name='L80'><i><font color='green'>   of this code is to classify each 8bytes of incoming argument by the register</font></i>
<a name='L81'><i><font color='green'>   class and assign registers accordingly.  */</font></i>
<a name='L82'>
<a name='L83'><i><font color='green'>/* Return the union class of CLASS1 and CLASS2.</font></i>
<a name='L84'><i><font color='green'>   See the x86-64 PS ABI for details.  */</font></i>
<a name='L85'>
<a name='L86'><b>static</b> <b>enum</b> <a href='../D/12393.html' title='Multiple defined in 2 places.'>x86_64_reg_class</a>
<a name='L87'><a href='../R/9003.html' title='Multiple refered from 2 places.'>merge_classes</a> (<b>enum</b> x86_64_reg_class class1, <b>enum</b> x86_64_reg_class class2)
<a name='L88'><font color='red'>{</font>
<a name='L89'>  <i><font color='green'>/* Rule #1: If both classes are equal, this is the resulting class.  */</font></i>
<a name='L90'>  <b>if</b> (class1 == class2)
<a name='L91'>    <b>return</b> class1;
<a name='L92'>
<a name='L93'>  <i><font color='green'>/* Rule #2: If one of the classes is NO_CLASS, the resulting class is</font></i>
<a name='L94'><i><font color='green'>     the other class.  */</font></i>
<a name='L95'>  <b>if</b> (class1 == X86_64_NO_CLASS)
<a name='L96'>    <b>return</b> class2;
<a name='L97'>  <b>if</b> (class2 == X86_64_NO_CLASS)
<a name='L98'>    <b>return</b> class1;
<a name='L99'>
<a name='L100'>  <i><font color='green'>/* Rule #3: If one of the classes is MEMORY, the result is MEMORY.  */</font></i>
<a name='L101'>  <b>if</b> (class1 == X86_64_MEMORY_CLASS || class2 == X86_64_MEMORY_CLASS)
<a name='L102'>    <b>return</b> X86_64_MEMORY_CLASS;
<a name='L103'>
<a name='L104'>  <i><font color='green'>/* Rule #4: If one of the classes is INTEGER, the result is INTEGER.  */</font></i>
<a name='L105'>  <b>if</b> ((class1 == X86_64_INTEGERSI_CLASS &amp;&amp; class2 == X86_64_SSESF_CLASS)
<a name='L106'>      || (class2 == X86_64_INTEGERSI_CLASS &amp;&amp; class1 == X86_64_SSESF_CLASS))
<a name='L107'>    <b>return</b> X86_64_INTEGERSI_CLASS;
<a name='L108'>  <b>if</b> (class1 == X86_64_INTEGER_CLASS || class1 == X86_64_INTEGERSI_CLASS
<a name='L109'>      || class2 == X86_64_INTEGER_CLASS || class2 == X86_64_INTEGERSI_CLASS)
<a name='L110'>    <b>return</b> X86_64_INTEGER_CLASS;
<a name='L111'>
<a name='L112'>  <i><font color='green'>/* Rule #5: If one of the classes is X87, X87UP, or COMPLEX_X87 class,</font></i>
<a name='L113'><i><font color='green'>     MEMORY is used.  */</font></i>
<a name='L114'>  <b>if</b> (class1 == X86_64_X87_CLASS
<a name='L115'>      || class1 == X86_64_X87UP_CLASS
<a name='L116'>      || class1 == X86_64_COMPLEX_X87_CLASS
<a name='L117'>      || class2 == X86_64_X87_CLASS
<a name='L118'>      || class2 == X86_64_X87UP_CLASS
<a name='L119'>      || class2 == X86_64_COMPLEX_X87_CLASS)
<a name='L120'>    <b>return</b> X86_64_MEMORY_CLASS;
<a name='L121'>
<a name='L122'>  <i><font color='green'>/* Rule #6: Otherwise class SSE is used.  */</font></i>
<a name='L123'>  <b>return</b> X86_64_SSE_CLASS;
<a name='L124'><font color='red'>}</font>
<a name='L125'>
<a name='L126'><i><font color='green'>/* Classify the argument of type TYPE and mode MODE.</font></i>
<a name='L127'><i><font color='green'>   CLASSES will be filled by the register class used to pass each word</font></i>
<a name='L128'><i><font color='green'>   of the operand.  The number of words is returned.  In case the parameter</font></i>
<a name='L129'><i><font color='green'>   should be passed in memory, 0 is returned. As a special case for zero</font></i>
<a name='L130'><i><font color='green'>   sized containers, classes[0] will be NO_CLASS and 1 is returned.</font></i>
<a name='L131'><i><font color='green'></font></i>
<a name='L132'><i><font color='green'>   See the x86-64 PS ABI for details.</font></i>
<a name='L133'><i><font color='green'>*/</font></i>
<a name='L134'><b>static</b> <b>int</b>
<a name='L135'><a href='../R/6659.html' title='Multiple refered from 4 places.'>classify_argument</a> (ffi_type *type, <b>enum</b> x86_64_reg_class classes[],
<a name='L136'>                   <a href='../D/11182.html' title='Multiple defined in 2 places.'>size_t</a> byte_offset)
<a name='L137'><font color='red'>{</font>
<a name='L138'>  <b>switch</b> (type-&gt;type)
<a name='L139'>    <font color='red'>{</font>
<a name='L140'>    <b>case</b> <a href='../D/1222.html' title='Multiple defined in 3 places.'>FFI_TYPE_UINT8</a>:
<a name='L141'>    <b>case</b> <a href='../D/1189.html' title='Multiple defined in 3 places.'>FFI_TYPE_SINT8</a>:
<a name='L142'>    <b>case</b> <a href='../D/1219.html' title='Multiple defined in 3 places.'>FFI_TYPE_UINT16</a>:
<a name='L143'>    <b>case</b> <a href='../D/1186.html' title='Multiple defined in 3 places.'>FFI_TYPE_SINT16</a>:
<a name='L144'>    <b>case</b> <a href='../D/1220.html' title='Multiple defined in 3 places.'>FFI_TYPE_UINT32</a>:
<a name='L145'>    <b>case</b> <a href='../D/1187.html' title='Multiple defined in 3 places.'>FFI_TYPE_SINT32</a>:
<a name='L146'>    <b>case</b> <a href='../D/1221.html' title='Multiple defined in 3 places.'>FFI_TYPE_UINT64</a>:
<a name='L147'>    <b>case</b> <a href='../D/1188.html' title='Multiple defined in 3 places.'>FFI_TYPE_SINT64</a>:
<a name='L148'>    <b>case</b> <a href='../D/1185.html' title='Multiple defined in 3 places.'>FFI_TYPE_POINTER</a>:
<a name='L149'>      <font color='red'>{</font>
<a name='L150'>        <b>int</b> size = byte_offset + type-&gt;size;
<a name='L151'>
<a name='L152'>        <b>if</b> (size &lt;= 4)
<a name='L153'>          <font color='red'>{</font>
<a name='L154'>            classes[0] = X86_64_INTEGERSI_CLASS;
<a name='L155'>            <b>return</b> 1;
<a name='L156'>          <font color='red'>}</font>
<a name='L157'>        <b>else</b> <b>if</b> (size &lt;= 8)
<a name='L158'>          <font color='red'>{</font>
<a name='L159'>            classes[0] = X86_64_INTEGER_CLASS;
<a name='L160'>            <b>return</b> 1;
<a name='L161'>          <font color='red'>}</font>
<a name='L162'>        <b>else</b> <b>if</b> (size &lt;= 12)
<a name='L163'>          <font color='red'>{</font>
<a name='L164'>            classes[0] = X86_64_INTEGER_CLASS;
<a name='L165'>            classes[1] = X86_64_INTEGERSI_CLASS;
<a name='L166'>            <b>return</b> 2;
<a name='L167'>          <font color='red'>}</font>
<a name='L168'>        <b>else</b> <b>if</b> (size &lt;= 16)
<a name='L169'>          <font color='red'>{</font>
<a name='L170'>            classes[0] = classes[1] = X86_64_INTEGERSI_CLASS;
<a name='L171'>            <b>return</b> 2;
<a name='L172'>          <font color='red'>}</font>
<a name='L173'>        <b>else</b>
<a name='L174'>          <a href='../D/1120.html' title='Multiple defined in 8 places.'>FFI_ASSERT</a> (0);
<a name='L175'>      <font color='red'>}</font>
<a name='L176'>    <b>case</b> <a href='../D/1181.html' title='Multiple defined in 3 places.'>FFI_TYPE_FLOAT</a>:
<a name='L177'>      <b>if</b> (!(byte_offset % 8))
<a name='L178'>        classes[0] = X86_64_SSESF_CLASS;
<a name='L179'>      <b>else</b>
<a name='L180'>        classes[0] = X86_64_SSE_CLASS;
<a name='L181'>      <b>return</b> 1;
<a name='L182'>    <b>case</b> <a href='../D/1180.html' title='Multiple defined in 3 places.'>FFI_TYPE_DOUBLE</a>:
<a name='L183'>      classes[0] = X86_64_SSEDF_CLASS;
<a name='L184'>      <b>return</b> 1;
<a name='L185'>    <b>case</b> <a href='../D/1184.html' title='Multiple defined in 8 places.'>FFI_TYPE_LONGDOUBLE</a>:
<a name='L186'>      classes[0] = X86_64_X87_CLASS;
<a name='L187'>      classes[1] = X86_64_X87UP_CLASS;
<a name='L188'>      <b>return</b> 2;
<a name='L189'>    <b>case</b> <a href='../D/1202.html' title='Multiple defined in 3 places.'>FFI_TYPE_STRUCT</a>:
<a name='L190'>      <font color='red'>{</font>
<a name='L191'>        <b>const</b> <b>int</b> UNITS_PER_WORD = 8;
<a name='L192'>        <b>int</b> words = (type-&gt;size + UNITS_PER_WORD - 1) / UNITS_PER_WORD;
<a name='L193'>        <a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> **ptr; 
<a name='L194'>        <b>int</b> i;
<a name='L195'>        <b>enum</b> <a href='../D/12393.html' title='Multiple defined in 2 places.'>x86_64_reg_class</a> subclasses[<a href='../D/2054.html' title='Multiple defined in 2 places.'>MAX_CLASSES</a>];
<a name='L196'>
<a name='L197'>        <i><font color='green'>/* If the struct is larger than 32 bytes, pass it on the stack.  */</font></i>
<a name='L198'>        <b>if</b> (type-&gt;size &gt; 32)
<a name='L199'>          <b>return</b> 0;
<a name='L200'>
<a name='L201'>        <b>for</b> (i = 0; i &lt; words; i++)
<a name='L202'>          classes[i] = X86_64_NO_CLASS;
<a name='L203'>
<a name='L204'>        <i><font color='green'>/* Zero sized arrays or structures are NO_CLASS.  We return 0 to</font></i>
<a name='L205'><i><font color='green'>           signalize memory class, so handle it as special case.  */</font></i>
<a name='L206'>        <b>if</b> (!words)
<a name='L207'>          <font color='red'>{</font>
<a name='L208'>            classes[0] = X86_64_NO_CLASS;
<a name='L209'>            <b>return</b> 1;
<a name='L210'>          <font color='red'>}</font>
<a name='L211'>
<a name='L212'>        <i><font color='green'>/* Merge the fields of structure.  */</font></i>
<a name='L213'>        <b>for</b> (ptr = type-&gt;elements; *ptr != <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a>; ptr++)
<a name='L214'>          <font color='red'>{</font>
<a name='L215'>            <b>int</b> num;
<a name='L216'>
<a name='L217'>            byte_offset = <a href='../D/55.html' title='Multiple defined in 4 places.'>ALIGN</a> (byte_offset, (*ptr)-&gt;alignment);
<a name='L218'>
<a name='L219'>            num = <a href='../D/7431.html' title='Multiple defined in 2 places.'>classify_argument</a> (*ptr, subclasses, byte_offset % 8);
<a name='L220'>            <b>if</b> (num == 0)
<a name='L221'>              <b>return</b> 0;
<a name='L222'>            <b>for</b> (i = 0; i &lt; num; i++)
<a name='L223'>              <font color='red'>{</font>
<a name='L224'>                <b>int</b> pos = byte_offset / 8;
<a name='L225'>                classes[i + pos] =
<a name='L226'>                  <a href='../D/9832.html' title='Multiple defined in 2 places.'>merge_classes</a> (subclasses[i], classes[i + pos]);
<a name='L227'>              <font color='red'>}</font>
<a name='L228'>
<a name='L229'>            byte_offset += (*ptr)-&gt;size;
<a name='L230'>          <font color='red'>}</font>
<a name='L231'>
<a name='L232'>        <b>if</b> (words &gt; 2)
<a name='L233'>          <font color='red'>{</font>
<a name='L234'>            <i><font color='green'>/* When size &gt; 16 bytes, if the first one isn't</font></i>
<a name='L235'><i><font color='green'>               X86_64_SSE_CLASS or any other ones aren't</font></i>
<a name='L236'><i><font color='green'>               X86_64_SSEUP_CLASS, everything should be passed in</font></i>
<a name='L237'><i><font color='green'>               memory.  */</font></i>
<a name='L238'>            <b>if</b> (classes[0] != X86_64_SSE_CLASS)
<a name='L239'>              <b>return</b> 0;
<a name='L240'>
<a name='L241'>            <b>for</b> (i = 1; i &lt; words; i++)
<a name='L242'>              <b>if</b> (classes[i] != X86_64_SSEUP_CLASS)
<a name='L243'>                <b>return</b> 0;
<a name='L244'>          <font color='red'>}</font>
<a name='L245'>
<a name='L246'>        <i><font color='green'>/* Final merger cleanup.  */</font></i>
<a name='L247'>        <b>for</b> (i = 0; i &lt; words; i++)
<a name='L248'>          <font color='red'>{</font>
<a name='L249'>            <i><font color='green'>/* If one class is MEMORY, everything should be passed in</font></i>
<a name='L250'><i><font color='green'>               memory.  */</font></i>
<a name='L251'>            <b>if</b> (classes[i] == X86_64_MEMORY_CLASS)
<a name='L252'>              <b>return</b> 0;
<a name='L253'>
<a name='L254'>            <i><font color='green'>/* The X86_64_SSEUP_CLASS should be always preceded by</font></i>
<a name='L255'><i><font color='green'>               X86_64_SSE_CLASS or X86_64_SSEUP_CLASS.  */</font></i>
<a name='L256'>            <b>if</b> (classes[i] == X86_64_SSEUP_CLASS
<a name='L257'>                &amp;&amp; classes[i - 1] != X86_64_SSE_CLASS
<a name='L258'>                &amp;&amp; classes[i - 1] != X86_64_SSEUP_CLASS)
<a name='L259'>              <font color='red'>{</font>
<a name='L260'>                <i><font color='green'>/* The first one should never be X86_64_SSEUP_CLASS.  */</font></i>
<a name='L261'>                <a href='../D/1120.html' title='Multiple defined in 8 places.'>FFI_ASSERT</a> (i != 0);
<a name='L262'>                classes[i] = X86_64_SSE_CLASS;
<a name='L263'>              <font color='red'>}</font>
<a name='L264'>
<a name='L265'>            <i><font color='green'>/*  If X86_64_X87UP_CLASS isn't preceded by X86_64_X87_CLASS,</font></i>
<a name='L266'><i><font color='green'>                everything should be passed in memory.  */</font></i>
<a name='L267'>            <b>if</b> (classes[i] == X86_64_X87UP_CLASS
<a name='L268'>                &amp;&amp; (classes[i - 1] != X86_64_X87_CLASS))
<a name='L269'>              <font color='red'>{</font>
<a name='L270'>                <i><font color='green'>/* The first one should never be X86_64_X87UP_CLASS.  */</font></i>
<a name='L271'>                <a href='../D/1120.html' title='Multiple defined in 8 places.'>FFI_ASSERT</a> (i != 0);
<a name='L272'>                <b>return</b> 0;
<a name='L273'>              <font color='red'>}</font>
<a name='L274'>          <font color='red'>}</font>
<a name='L275'>        <b>return</b> words;
<a name='L276'>      <font color='red'>}</font>
<a name='L277'>
<a name='L278'>    <b>default</b>:
<a name='L279'>      <a href='../D/1120.html' title='Multiple defined in 8 places.'>FFI_ASSERT</a>(0);
<a name='L280'>    <font color='red'>}</font>
<a name='L281'>  <b>return</b> 0; <i><font color='green'>/* Never reached.  */</font></i>
<a name='L282'><font color='red'>}</font>
<a name='L283'>
<a name='L284'><i><font color='green'>/* Examine the argument and return set number of register required in each</font></i>
<a name='L285'><i><font color='green'>   class.  Return zero iff parameter should be passed in memory, otherwise</font></i>
<a name='L286'><i><font color='green'>   the number of registers.  */</font></i>
<a name='L287'>
<a name='L288'><b>static</b> <b>int</b>
<a name='L289'><a href='../R/7613.html' title='Multiple refered from 10 places.'>examine_argument</a> (ffi_type *type, <b>enum</b> x86_64_reg_class classes[<a href='../D/2054.html' title='Multiple defined in 2 places.'>MAX_CLASSES</a>],
<a name='L290'>                  <b>_Bool</b> in_return, <b>int</b> *pngpr, <b>int</b> *pnsse)
<a name='L291'><font color='red'>{</font>
<a name='L292'>  <b>int</b> i, n, ngpr, nsse;
<a name='L293'>
<a name='L294'>  n = <a href='../D/7431.html' title='Multiple defined in 2 places.'>classify_argument</a> (type, classes, 0);
<a name='L295'>  <b>if</b> (n == 0)
<a name='L296'>    <b>return</b> 0;
<a name='L297'>
<a name='L298'>  ngpr = nsse = 0;
<a name='L299'>  <b>for</b> (i = 0; i &lt; n; ++i)
<a name='L300'>    <b>switch</b> (classes[i])
<a name='L301'>      <font color='red'>{</font>
<a name='L302'>      <b>case</b> X86_64_INTEGER_CLASS:
<a name='L303'>      <b>case</b> X86_64_INTEGERSI_CLASS:
<a name='L304'>        ngpr++;
<a name='L305'>        <b>break</b>;
<a name='L306'>      <b>case</b> X86_64_SSE_CLASS:
<a name='L307'>      <b>case</b> X86_64_SSESF_CLASS:
<a name='L308'>      <b>case</b> X86_64_SSEDF_CLASS:
<a name='L309'>        nsse++;
<a name='L310'>        <b>break</b>;
<a name='L311'>      <b>case</b> X86_64_NO_CLASS:
<a name='L312'>      <b>case</b> X86_64_SSEUP_CLASS:
<a name='L313'>        <b>break</b>;
<a name='L314'>      <b>case</b> X86_64_X87_CLASS:
<a name='L315'>      <b>case</b> X86_64_X87UP_CLASS:
<a name='L316'>      <b>case</b> X86_64_COMPLEX_X87_CLASS:
<a name='L317'>        <b>return</b> in_return != 0;
<a name='L318'>      <b>default</b>:
<a name='L319'>        <a href='../S/2520.html#L152' title='Defined at 152 in Modules/_ctypes/libffi_arm_wince/fficonfig.h.'>abort</a> ();
<a name='L320'>      <font color='red'>}</font>
<a name='L321'>
<a name='L322'>  *pngpr = ngpr;
<a name='L323'>  *pnsse = nsse;
<a name='L324'>
<a name='L325'>  <b>return</b> n;
<a name='L326'><font color='red'>}</font>
<a name='L327'>
<a name='L328'><i><font color='green'>/* Perform machine dependent cif processing.  */</font></i>
<a name='L329'>
<a name='L330'><a href='../D/8530.html' title='Multiple defined in 4 places.'>ffi_status</a>
<a name='L331'><a href='../R/7714.html' title='Multiple refered from 9 places.'>ffi_prep_cif_machdep</a> (ffi_cif *cif)
<a name='L332'><font color='red'>{</font>
<a name='L333'>  <b>int</b> gprcount, ssecount, i, avn, n, ngpr, nsse, <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a>;
<a name='L334'>  <b>enum</b> <a href='../D/12393.html' title='Multiple defined in 2 places.'>x86_64_reg_class</a> classes[<a href='../D/2054.html' title='Multiple defined in 2 places.'>MAX_CLASSES</a>];
<a name='L335'>  <a href='../D/11182.html' title='Multiple defined in 2 places.'>size_t</a> <a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a>;
<a name='L336'>
<a name='L337'>  gprcount = ssecount = 0;
<a name='L338'>
<a name='L339'>  <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> = cif-&gt;rtype-&gt;type;
<a name='L340'>  <b>if</b> (<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> != <a href='../D/1223.html' title='Multiple defined in 3 places.'>FFI_TYPE_VOID</a>)
<a name='L341'>    <font color='red'>{</font>
<a name='L342'>      n = <a href='../D/8401.html' title='Multiple defined in 2 places.'>examine_argument</a> (cif-&gt;rtype, classes, 1, &amp;ngpr, &amp;nsse);
<a name='L343'>      <b>if</b> (n == 0)
<a name='L344'>        <font color='red'>{</font>
<a name='L345'>          <i><font color='green'>/* The return value is passed in memory.  A pointer to that</font></i>
<a name='L346'><i><font color='green'>             memory is the first argument.  Allocate a register for it.  */</font></i>
<a name='L347'>          gprcount++;
<a name='L348'>          <i><font color='green'>/* We don't have to do anything in asm for the return.  */</font></i>
<a name='L349'>          <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> = <a href='../D/1223.html' title='Multiple defined in 3 places.'>FFI_TYPE_VOID</a>;
<a name='L350'>        <font color='red'>}</font>
<a name='L351'>      <b>else</b> <b>if</b> (<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> == <a href='../D/1202.html' title='Multiple defined in 3 places.'>FFI_TYPE_STRUCT</a>)
<a name='L352'>        <font color='red'>{</font>
<a name='L353'>          <i><font color='green'>/* Mark which registers the result appears in.  */</font></i>
<a name='L354'>          <b>_Bool</b> sse0 = <a href='../D/4906.html' title='Multiple defined in 2 places.'>SSE_CLASS_P</a> (classes[0]);
<a name='L355'>          <b>_Bool</b> sse1 = n == 2 &amp;&amp; <a href='../D/4906.html' title='Multiple defined in 2 places.'>SSE_CLASS_P</a> (classes[1]);
<a name='L356'>          <b>if</b> (sse0 &amp;&amp; !sse1)
<a name='L357'>            <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= 1 &lt;&lt; 8;
<a name='L358'>          <b>else</b> <b>if</b> (!sse0 &amp;&amp; sse1)
<a name='L359'>            <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= 1 &lt;&lt; 9;
<a name='L360'>          <b>else</b> <b>if</b> (sse0 &amp;&amp; sse1)
<a name='L361'>            <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= 1 &lt;&lt; 10;
<a name='L362'>          <i><font color='green'>/* Mark the true size of the structure.  */</font></i>
<a name='L363'>          <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= cif-&gt;rtype-&gt;size &lt;&lt; 12;
<a name='L364'>        <font color='red'>}</font>
<a name='L365'>    <font color='red'>}</font>
<a name='L366'>
<a name='L367'>  <i><font color='green'>/* Go over all arguments and determine the way they should be passed.</font></i>
<a name='L368'><i><font color='green'>     If it's in a register and there is space for it, let that be so. If</font></i>
<a name='L369'><i><font color='green'>     not, add it's size to the stack byte count.  */</font></i>
<a name='L370'>  <b>for</b> (<a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a> = 0, i = 0, avn = cif-&gt;nargs; i &lt; avn; i++)
<a name='L371'>    <font color='red'>{</font>
<a name='L372'>      <b>if</b> (<a href='../D/8401.html' title='Multiple defined in 2 places.'>examine_argument</a> (cif-&gt;arg_types[i], classes, 0, &amp;ngpr, &amp;nsse) == 0
<a name='L373'>          || gprcount + ngpr &gt; <a href='../D/2062.html' title='Multiple defined in 2 places.'>MAX_GPR_REGS</a>
<a name='L374'>          || ssecount + nsse &gt; <a href='../D/2083.html' title='Multiple defined in 2 places.'>MAX_SSE_REGS</a>)
<a name='L375'>        <font color='red'>{</font>
<a name='L376'>          <b>long</b> <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = cif-&gt;arg_types[i]-&gt;alignment;
<a name='L377'>
<a name='L378'>          <b>if</b> (<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> &lt; 8)
<a name='L379'>            <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = 8;
<a name='L380'>
<a name='L381'>          <a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a> = <a href='../D/55.html' title='Multiple defined in 4 places.'>ALIGN</a>(<a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a>, <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>);
<a name='L382'>          <a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a> += cif-&gt;arg_types[i]-&gt;size;
<a name='L383'>        <font color='red'>}</font>
<a name='L384'>      <b>else</b>
<a name='L385'>        <font color='red'>{</font>
<a name='L386'>          gprcount += ngpr;
<a name='L387'>          ssecount += nsse;
<a name='L388'>        <font color='red'>}</font>
<a name='L389'>    <font color='red'>}</font>
<a name='L390'>  <b>if</b> (ssecount)
<a name='L391'>    <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> |= 1 &lt;&lt; 11;
<a name='L392'>  cif-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> = <a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a>;
<a name='L393'>  cif-&gt;<a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a> = <a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a>;
<a name='L394'>
<a name='L395'>  <b>return</b> <a href='../D/1165.html' title='Multiple defined in 3 places.'>FFI_OK</a>;
<a name='L396'><font color='red'>}</font>
<a name='L397'>
<a name='L398'><b>void</b>
<a name='L399'><a href='../R/7684.html' title='Multiple refered from 112 places.'>ffi_call</a> (ffi_cif *cif, <b>void</b> (*fn)(<b>void</b>), <b>void</b> *rvalue, <b>void</b> **avalue)
<a name='L400'><font color='red'>{</font>
<a name='L401'>  <b>enum</b> <a href='../D/12393.html' title='Multiple defined in 2 places.'>x86_64_reg_class</a> classes[<a href='../D/2054.html' title='Multiple defined in 2 places.'>MAX_CLASSES</a>];
<a name='L402'>  <b>char</b> *<a href='../S/2844.html#L22' title='Defined at 22 in Parser/parser.h.'>stack</a>, *argp;
<a name='L403'>  <a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> **arg_types;
<a name='L404'>  <b>int</b> gprcount, ssecount, ngpr, nsse, i, avn;
<a name='L405'>  <b>_Bool</b> ret_in_memory;
<a name='L406'>  <b>struct</b> <a href='../S/2374.html#L39' title='Defined at 39 in Modules/_ctypes/libffi/src/x86/ffi64.c.'>register_args</a> *reg_args;
<a name='L407'>
<a name='L408'>  <i><font color='green'>/* Can't call 32-bit mode from 64-bit mode.  */</font></i>
<a name='L409'>  <a href='../D/1120.html' title='Multiple defined in 8 places.'>FFI_ASSERT</a> (cif-&gt;abi == <a href='../D/1225.html' title='Multiple defined in 4 places.'>FFI_UNIX64</a>);
<a name='L410'>
<a name='L411'>  <i><font color='green'>/* If the return value is a struct and we don't have a return value</font></i>
<a name='L412'><i><font color='green'>     address then we need to make one.  Note the setting of flags to</font></i>
<a name='L413'><i><font color='green'>     VOID above in ffi_prep_cif_machdep.  */</font></i>
<a name='L414'>  ret_in_memory = (cif-&gt;rtype-&gt;type == <a href='../D/1202.html' title='Multiple defined in 3 places.'>FFI_TYPE_STRUCT</a>
<a name='L415'>                   &amp;&amp; (cif-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> &amp; 0xff) == <a href='../D/1223.html' title='Multiple defined in 3 places.'>FFI_TYPE_VOID</a>);
<a name='L416'>  <b>if</b> (rvalue == <a href='../S/2891.html#L5' title='Defined at 5 in PC/os2emx/dllentry.c.'>NULL</a> &amp;&amp; ret_in_memory)
<a name='L417'>    rvalue = <a href='../D/6714.html' title='Multiple defined in 6 places.'>alloca</a> (cif-&gt;rtype-&gt;size);
<a name='L418'>
<a name='L419'>  <i><font color='green'>/* Allocate the space for the arguments, plus 4 words of temp space.  */</font></i>
<a name='L420'>  <a href='../S/2844.html#L22' title='Defined at 22 in Parser/parser.h.'>stack</a> = <a href='../D/6714.html' title='Multiple defined in 6 places.'>alloca</a> (<b>sizeof</b> (<b>struct</b> <a href='../S/2374.html#L39' title='Defined at 39 in Modules/_ctypes/libffi/src/x86/ffi64.c.'>register_args</a>) + cif-&gt;<a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a> + 4*8);
<a name='L421'>  reg_args = (<b>struct</b> <a href='../S/2374.html#L39' title='Defined at 39 in Modules/_ctypes/libffi/src/x86/ffi64.c.'>register_args</a> *) <a href='../S/2844.html#L22' title='Defined at 22 in Parser/parser.h.'>stack</a>;
<a name='L422'>  argp = <a href='../S/2844.html#L22' title='Defined at 22 in Parser/parser.h.'>stack</a> + <b>sizeof</b> (<b>struct</b> <a href='../S/2374.html#L39' title='Defined at 39 in Modules/_ctypes/libffi/src/x86/ffi64.c.'>register_args</a>);
<a name='L423'>
<a name='L424'>  gprcount = ssecount = 0;
<a name='L425'>
<a name='L426'>  <i><font color='green'>/* If the return value is passed in memory, add the pointer as the</font></i>
<a name='L427'><i><font color='green'>     first integer argument.  */</font></i>
<a name='L428'>  <b>if</b> (ret_in_memory)
<a name='L429'>    reg_args-&gt;gpr[gprcount++] = (<b>long</b>) rvalue;
<a name='L430'>
<a name='L431'>  avn = cif-&gt;nargs;
<a name='L432'>  arg_types = cif-&gt;arg_types;
<a name='L433'>
<a name='L434'>  <b>for</b> (i = 0; i &lt; avn; ++i)
<a name='L435'>    <font color='red'>{</font>
<a name='L436'>      <a href='../D/11182.html' title='Multiple defined in 2 places.'>size_t</a> size = arg_types[i]-&gt;size;
<a name='L437'>      <b>int</b> n;
<a name='L438'>
<a name='L439'>      n = <a href='../D/8401.html' title='Multiple defined in 2 places.'>examine_argument</a> (arg_types[i], classes, 0, &amp;ngpr, &amp;nsse);
<a name='L440'>      <b>if</b> (n == 0
<a name='L441'>          || gprcount + ngpr &gt; <a href='../D/2062.html' title='Multiple defined in 2 places.'>MAX_GPR_REGS</a>
<a name='L442'>          || ssecount + nsse &gt; <a href='../D/2083.html' title='Multiple defined in 2 places.'>MAX_SSE_REGS</a>)
<a name='L443'>        <font color='red'>{</font>
<a name='L444'>          <b>long</b> <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = arg_types[i]-&gt;alignment;
<a name='L445'>
<a name='L446'>          <i><font color='green'>/* Stack arguments are *always* at least 8 byte aligned.  */</font></i>
<a name='L447'>          <b>if</b> (<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> &lt; 8)
<a name='L448'>            <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = 8;
<a name='L449'>
<a name='L450'>          <i><font color='green'>/* Pass this argument in memory.  */</font></i>
<a name='L451'>          argp = (<b>void</b> *) <a href='../D/55.html' title='Multiple defined in 4 places.'>ALIGN</a> (argp, <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>);
<a name='L452'>          <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a> (argp, avalue[i], size);
<a name='L453'>          argp += size;
<a name='L454'>        <font color='red'>}</font>
<a name='L455'>      <b>else</b>
<a name='L456'>        <font color='red'>{</font>
<a name='L457'>          <i><font color='green'>/* The argument is passed entirely in registers.  */</font></i>
<a name='L458'>          <b>char</b> *a = (<b>char</b> *) avalue[i];
<a name='L459'>          <b>int</b> j;
<a name='L460'>
<a name='L461'>          <b>for</b> (j = 0; j &lt; n; j++, a += 8, size -= 8)
<a name='L462'>            <font color='red'>{</font>
<a name='L463'>              <b>switch</b> (classes[j])
<a name='L464'>                <font color='red'>{</font>
<a name='L465'>                <b>case</b> X86_64_INTEGER_CLASS:
<a name='L466'>                <b>case</b> X86_64_INTEGERSI_CLASS:
<a name='L467'>                  reg_args-&gt;gpr[gprcount] = 0;
<a name='L468'>                  <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a> (&amp;reg_args-&gt;gpr[gprcount], a, size &lt; 8 ? size : 8);
<a name='L469'>                  gprcount++;
<a name='L470'>                  <b>break</b>;
<a name='L471'>                <b>case</b> X86_64_SSE_CLASS:
<a name='L472'>                <b>case</b> X86_64_SSEDF_CLASS:
<a name='L473'>                  reg_args-&gt;sse[ssecount++] = *(<a href='../D/5331.html' title='Multiple defined in 7 places.'>UINT64</a> *) a;
<a name='L474'>                  <b>break</b>;
<a name='L475'>                <b>case</b> X86_64_SSESF_CLASS:
<a name='L476'>                  reg_args-&gt;sse[ssecount++] = *(<a href='../D/5330.html' title='Multiple defined in 7 places.'>UINT32</a> *) a;
<a name='L477'>                  <b>break</b>;
<a name='L478'>                <b>default</b>:
<a name='L479'>                  <a href='../S/2520.html#L152' title='Defined at 152 in Modules/_ctypes/libffi_arm_wince/fficonfig.h.'>abort</a>();
<a name='L480'>                <font color='red'>}</font>
<a name='L481'>            <font color='red'>}</font>
<a name='L482'>        <font color='red'>}</font>
<a name='L483'>    <font color='red'>}</font>
<a name='L484'>
<a name='L485'>  ffi_call_unix64 (<a href='../S/2844.html#L22' title='Defined at 22 in Parser/parser.h.'>stack</a>, cif-&gt;<a href='../D/7205.html' title='Multiple defined in 2 places.'>bytes</a> + <b>sizeof</b> (<b>struct</b> <a href='../S/2374.html#L39' title='Defined at 39 in Modules/_ctypes/libffi/src/x86/ffi64.c.'>register_args</a>),
<a name='L486'>                   cif-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a>, rvalue, <a href='../S/2334.html#L39' title='Defined at 39 in Modules/_ctypes/libffi/src/mips/n32.S.'>fn</a>, ssecount);
<a name='L487'><font color='red'>}</font>
<a name='L488'>
<a name='L489'>
<a name='L490'><b>extern</b> <b>void</b> ffi_closure_unix64(<b>void</b>);
<a name='L491'>
<a name='L492'><a href='../D/8530.html' title='Multiple defined in 4 places.'>ffi_status</a>
<a name='L493'><a href='../R/7717.html' title='Multiple refered from 92 places.'>ffi_prep_closure_loc</a> (ffi_closure* closure,
<a name='L494'>                      ffi_cif* cif,
<a name='L495'>                      <b>void</b> (*fun)(ffi_cif*, <b>void</b>*, <b>void</b>**, <b>void</b>*),
<a name='L496'>                      <b>void</b> *user_data,
<a name='L497'>                      <b>void</b> *codeloc)
<a name='L498'><font color='red'>{</font>
<a name='L499'>  <b>volatile</b> <b>unsigned</b> <b>short</b> *tramp;
<a name='L500'>
<a name='L501'>  tramp = (<b>volatile</b> <b>unsigned</b> <b>short</b> *) &amp;closure-&gt;tramp[0];
<a name='L502'>
<a name='L503'>  tramp[0] = 0xbb49;            <i><font color='green'>/* mov &lt;code&gt;, %r11     */</font></i>
<a name='L504'>  *(<b>void</b> * <b>volatile</b> *) &amp;tramp[1] = ffi_closure_unix64;
<a name='L505'>  tramp[5] = 0xba49;            <i><font color='green'>/* mov &lt;data&gt;, %r10     */</font></i>
<a name='L506'>  *(<b>void</b> * <b>volatile</b> *) &amp;tramp[6] = codeloc;
<a name='L507'>
<a name='L508'>  <i><font color='green'>/* Set the carry bit iff the function uses any sse registers.</font></i>
<a name='L509'><i><font color='green'>     This is clc or stc, together with the first byte of the jmp.  */</font></i>
<a name='L510'>  tramp[10] = cif-&gt;<a href='../D/8626.html' title='Multiple defined in 2 places.'>flags</a> &amp; (1 &lt;&lt; 11) ? 0x49f9 : 0x49f8;
<a name='L511'>
<a name='L512'>  tramp[11] = 0xe3ff;                   <i><font color='green'>/* jmp *%r11    */</font></i>
<a name='L513'>
<a name='L514'>  closure-&gt;cif = cif;
<a name='L515'>  closure-&gt;fun = fun;
<a name='L516'>  closure-&gt;user_data = user_data;
<a name='L517'>
<a name='L518'>  <b>return</b> <a href='../D/1165.html' title='Multiple defined in 3 places.'>FFI_OK</a>;
<a name='L519'><font color='red'>}</font>
<a name='L520'>
<a name='L521'><b>int</b>
<a name='L522'><a href='../R/7698.html' title='Multiple refered from 2 places.'>ffi_closure_unix64_inner</a>(ffi_closure *closure, <b>void</b> *rvalue,
<a name='L523'>                         <b>struct</b> register_args *reg_args, <b>char</b> *argp)
<a name='L524'><font color='red'>{</font>
<a name='L525'>  <a href='../D/8477.html' title='Multiple defined in 4 places.'>ffi_cif</a> *cif;
<a name='L526'>  <b>void</b> **avalue;
<a name='L527'>  <a href='../D/8534.html' title='Multiple defined in 3 places.'>ffi_type</a> **arg_types;
<a name='L528'>  <b>long</b> i, avn;
<a name='L529'>  <b>int</b> gprcount, ssecount, ngpr, nsse;
<a name='L530'>  <b>int</b> ret;
<a name='L531'>
<a name='L532'>  cif = closure-&gt;cif;
<a name='L533'>  avalue = <a href='../D/6714.html' title='Multiple defined in 6 places.'>alloca</a>(cif-&gt;nargs * <b>sizeof</b>(<b>void</b> *));
<a name='L534'>  gprcount = ssecount = 0;
<a name='L535'>
<a name='L536'>  ret = cif-&gt;rtype-&gt;type;
<a name='L537'>  <b>if</b> (ret != <a href='../D/1223.html' title='Multiple defined in 3 places.'>FFI_TYPE_VOID</a>)
<a name='L538'>    <font color='red'>{</font>
<a name='L539'>      <b>enum</b> <a href='../D/12393.html' title='Multiple defined in 2 places.'>x86_64_reg_class</a> classes[<a href='../D/2054.html' title='Multiple defined in 2 places.'>MAX_CLASSES</a>];
<a name='L540'>      <b>int</b> n = <a href='../D/8401.html' title='Multiple defined in 2 places.'>examine_argument</a> (cif-&gt;rtype, classes, 1, &amp;ngpr, &amp;nsse);
<a name='L541'>      <b>if</b> (n == 0)
<a name='L542'>        <font color='red'>{</font>
<a name='L543'>          <i><font color='green'>/* The return value goes in memory.  Arrange for the closure</font></i>
<a name='L544'><i><font color='green'>             return value to go directly back to the original caller.  */</font></i>
<a name='L545'>          rvalue = (<b>void</b> *) reg_args-&gt;gpr[gprcount++];
<a name='L546'>          <i><font color='green'>/* We don't have to do anything in asm for the return.  */</font></i>
<a name='L547'>          ret = <a href='../D/1223.html' title='Multiple defined in 3 places.'>FFI_TYPE_VOID</a>;
<a name='L548'>        <font color='red'>}</font>
<a name='L549'>      <b>else</b> <b>if</b> (ret == <a href='../D/1202.html' title='Multiple defined in 3 places.'>FFI_TYPE_STRUCT</a> &amp;&amp; n == 2)
<a name='L550'>        <font color='red'>{</font>
<a name='L551'>          <i><font color='green'>/* Mark which register the second word of the structure goes in.  */</font></i>
<a name='L552'>          <b>_Bool</b> sse0 = <a href='../D/4906.html' title='Multiple defined in 2 places.'>SSE_CLASS_P</a> (classes[0]);
<a name='L553'>          <b>_Bool</b> sse1 = <a href='../D/4906.html' title='Multiple defined in 2 places.'>SSE_CLASS_P</a> (classes[1]);
<a name='L554'>          <b>if</b> (!sse0 &amp;&amp; sse1)
<a name='L555'>            ret |= 1 &lt;&lt; 8;
<a name='L556'>          <b>else</b> <b>if</b> (sse0 &amp;&amp; !sse1)
<a name='L557'>            ret |= 1 &lt;&lt; 9;
<a name='L558'>        <font color='red'>}</font>
<a name='L559'>    <font color='red'>}</font>
<a name='L560'>
<a name='L561'>  avn = cif-&gt;nargs;
<a name='L562'>  arg_types = cif-&gt;arg_types;
<a name='L563'>  
<a name='L564'>  <b>for</b> (i = 0; i &lt; avn; ++i)
<a name='L565'>    <font color='red'>{</font>
<a name='L566'>      <b>enum</b> <a href='../D/12393.html' title='Multiple defined in 2 places.'>x86_64_reg_class</a> classes[<a href='../D/2054.html' title='Multiple defined in 2 places.'>MAX_CLASSES</a>];
<a name='L567'>      <b>int</b> n;
<a name='L568'>
<a name='L569'>      n = <a href='../D/8401.html' title='Multiple defined in 2 places.'>examine_argument</a> (arg_types[i], classes, 0, &amp;ngpr, &amp;nsse);
<a name='L570'>      <b>if</b> (n == 0
<a name='L571'>          || gprcount + ngpr &gt; <a href='../D/2062.html' title='Multiple defined in 2 places.'>MAX_GPR_REGS</a>
<a name='L572'>          || ssecount + nsse &gt; <a href='../D/2083.html' title='Multiple defined in 2 places.'>MAX_SSE_REGS</a>)
<a name='L573'>        <font color='red'>{</font>
<a name='L574'>          <b>long</b> <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = arg_types[i]-&gt;alignment;
<a name='L575'>
<a name='L576'>          <i><font color='green'>/* Stack arguments are *always* at least 8 byte aligned.  */</font></i>
<a name='L577'>          <b>if</b> (<a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> &lt; 8)
<a name='L578'>            <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a> = 8;
<a name='L579'>
<a name='L580'>          <i><font color='green'>/* Pass this argument in memory.  */</font></i>
<a name='L581'>          argp = (<b>void</b> *) <a href='../D/55.html' title='Multiple defined in 4 places.'>ALIGN</a> (argp, <a href='../S/2613.html#L1149' title='Defined at 1149 in Modules/_struct.c.'>align</a>);
<a name='L582'>          avalue[i] = argp;
<a name='L583'>          argp += arg_types[i]-&gt;size;
<a name='L584'>        <font color='red'>}</font>
<a name='L585'>      <i><font color='green'>/* If the argument is in a single register, or two consecutive</font></i>
<a name='L586'><i><font color='green'>         integer registers, then we can use that address directly.  */</font></i>
<a name='L587'>      <b>else</b> <b>if</b> (n == 1
<a name='L588'>               || (n == 2 &amp;&amp; !(<a href='../D/4906.html' title='Multiple defined in 2 places.'>SSE_CLASS_P</a> (classes[0])
<a name='L589'>                               || <a href='../D/4906.html' title='Multiple defined in 2 places.'>SSE_CLASS_P</a> (classes[1]))))
<a name='L590'>        <font color='red'>{</font>
<a name='L591'>          <i><font color='green'>/* The argument is in a single register.  */</font></i>
<a name='L592'>          <b>if</b> (<a href='../D/4906.html' title='Multiple defined in 2 places.'>SSE_CLASS_P</a> (classes[0]))
<a name='L593'>            <font color='red'>{</font>
<a name='L594'>              avalue[i] = &amp;reg_args-&gt;sse[ssecount];
<a name='L595'>              ssecount += n;
<a name='L596'>            <font color='red'>}</font>
<a name='L597'>          <b>else</b>
<a name='L598'>            <font color='red'>{</font>
<a name='L599'>              avalue[i] = &amp;reg_args-&gt;gpr[gprcount];
<a name='L600'>              gprcount += n;
<a name='L601'>            <font color='red'>}</font>
<a name='L602'>        <font color='red'>}</font>
<a name='L603'>      <i><font color='green'>/* Otherwise, allocate space to make them consecutive.  */</font></i>
<a name='L604'>      <b>else</b>
<a name='L605'>        <font color='red'>{</font>
<a name='L606'>          <b>char</b> *a = <a href='../D/6714.html' title='Multiple defined in 6 places.'>alloca</a> (16);
<a name='L607'>          <b>int</b> j;
<a name='L608'>
<a name='L609'>          avalue[i] = a;
<a name='L610'>          <b>for</b> (j = 0; j &lt; n; j++, a += 8)
<a name='L611'>            <font color='red'>{</font>
<a name='L612'>              <b>if</b> (<a href='../D/4906.html' title='Multiple defined in 2 places.'>SSE_CLASS_P</a> (classes[j]))
<a name='L613'>                <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a> (a, &amp;reg_args-&gt;sse[ssecount++], 8);
<a name='L614'>              <b>else</b>
<a name='L615'>                <a href='../D/9803.html' title='Multiple defined in 4 places.'>memcpy</a> (a, &amp;reg_args-&gt;gpr[gprcount++], 8);
<a name='L616'>            <font color='red'>}</font>
<a name='L617'>        <font color='red'>}</font>
<a name='L618'>    <font color='red'>}</font>
<a name='L619'>
<a name='L620'>  <i><font color='green'>/* Invoke the closure.  */</font></i>
<a name='L621'>  closure-&gt;fun (cif, rvalue, avalue, closure-&gt;user_data);
<a name='L622'>
<a name='L623'>  <i><font color='green'>/* Tell assembly how to perform return type promotions.  */</font></i>
<a name='L624'>  <b>return</b> ret;
<a name='L625'><font color='red'>}</font>
<a name='L626'>
<a name='L627'><font color='darkred'>#endif</font> <i><font color='green'>/* __x86_64__ */</font></i>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L87'>[^]</a><a href='#L522'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
